<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program Command - EWU Design</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <style>
        /* Primer-inspired Design Tokens */
        :root {
            /* EWU Brand Colors */
            --ewu-red: #a10022;
            --ewu-red-dark: #8a001d;
            --primary-gradient: linear-gradient(180deg, #a10022 0%, #8a001d 100%);
            
            /* Primer Color Scale */
            --color-fg-default: #1F2328;
            --color-fg-muted: #656d76;
            --color-fg-subtle: #6e7781;
            --color-fg-on-emphasis: #ffffff;
            --color-canvas-default: #ffffff;
            --color-canvas-subtle: #f6f8fa;
            --color-canvas-inset: #f6f8fa;
            --color-border-default: #d0d7de;
            --color-border-muted: #d8dee4;
            --color-border-subtle: rgba(27, 31, 36, 0.15);
            --color-accent-fg: #0969da;
            --color-accent-emphasis: #0969da;
            --color-success-fg: #1a7f37;
            --color-success-emphasis: #1f883d;
            --color-attention-fg: #9a6700;
            --color-attention-emphasis: #9a6700;
            --color-danger-fg: #d1242f;
            --color-danger-emphasis: #cf222e;
            
            /* Primer Spacing Scale (4px base) */
            --space-0: 0;
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 16px;
            --space-4: 24px;
            --space-5: 32px;
            --space-6: 40px;
            
            /* Primer Border Radius */
            --radius-1: 3px;
            --radius-2: 6px;
            --radius-3: 12px;
            
            /* Primer Shadows */
            --shadow-sm: 0 1px 0 rgba(27, 31, 36, 0.04);
            --shadow-md: 0 3px 6px rgba(140, 149, 159, 0.15);
            --shadow-lg: 0 8px 24px rgba(140, 149, 159, 0.2);
            --shadow-xl: 0 12px 28px rgba(140, 149, 159, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--color-canvas-subtle);
            min-height: 100vh;
            padding: var(--space-3);
            color: var(--color-fg-default);
            font-size: 14px;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--color-canvas-default);
            border-radius: var(--radius-2);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--color-border-default);
        }

        header {
            background: var(--primary-gradient);
            color: var(--color-fg-on-emphasis);
            padding: var(--space-4) var(--space-4);
            text-align: center;
            position: relative;
        }

        header::after {
            display: none;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: var(--space-1);
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Year Navigation */
        .year-nav {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: var(--space-2) var(--space-3);
            background: var(--color-canvas-subtle);
            border-bottom: 1px solid var(--color-border-muted);
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 13px;
        }

        .year-selector label {
            color: var(--color-fg-muted);
            font-weight: 500;
        }

        .year-selector select {
            padding: 4px 8px;
            font-size: 13px;
            font-weight: 600;
            border-radius: var(--radius-2);
        }

        .copy-year-btn {
            padding: 4px 12px;
            font-size: 12px;
            background: var(--color-canvas-default);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-2);
            color: var(--color-fg-default);
            cursor: pointer;
            transition: background 0.15s;
        }

        .copy-year-btn:hover {
            background: var(--color-canvas-subtle);
        }

        .tab-year {
            font-weight: 400;
            opacity: 0.8;
        }

        /* Quarter Tabs - Primer UnderlineNav style */
        .quarter-tabs {
            display: flex;
            background: var(--color-canvas-default);
            border-bottom: 1px solid var(--color-border-muted);
            padding: 0 var(--space-3);
            gap: var(--space-2);
        }

        .quarter-tab {
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-fg-muted);
            cursor: pointer;
            transition: color 0.15s ease;
            position: relative;
            border-radius: var(--radius-2) var(--radius-2) 0 0;
            box-shadow: none;
            flex: 0;
            white-space: nowrap;
        }

        .quarter-tab:hover {
            color: var(--color-fg-default);
            background: transparent;
            transform: none;
            box-shadow: none;
        }

        .quarter-tab.active {
            color: var(--color-fg-default);
            font-weight: 600;
            background: transparent;
        }

        .quarter-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--ewu-red);
            border-radius: var(--radius-1);
        }

        /* Collapsible Filters Panel - Primer style */
        .filters-panel {
            background: var(--color-canvas-default);
            border-bottom: 1px solid var(--color-border-muted);
        }

        .filters-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2) var(--space-3);
            background: var(--color-canvas-subtle);
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            color: var(--color-fg-muted);
            transition: background 0.15s ease;
        }

        .filters-toggle:hover {
            background: var(--color-canvas-inset);
            color: var(--color-fg-default);
        }

        .filters-toggle .toggle-icon {
            transition: transform 0.2s ease;
            font-size: 10px;
        }

        .filters-panel.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .filters-content {
            padding: var(--space-3);
            background: var(--color-canvas-default);
            display: block;
        }

        .filters-panel.collapsed .filters-content {
            display: none;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-3);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--color-fg-default);
            font-size: 12px;
            text-transform: none;
            letter-spacing: 0;
        }

        .filter-group select {
            padding: 5px 12px;
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-2);
            font-size: 14px;
            background: var(--color-canvas-default);
            cursor: pointer;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            font-weight: 400;
            color: var(--color-fg-default);
            height: 32px;
        }

        .filter-group select:hover {
            border-color: var(--color-border-default);
            background: var(--color-canvas-default);
        }

        .filter-group select:focus {
            border-color: var(--ewu-red);
            outline: none;
            box-shadow: 0 0 0 3px rgba(161, 0, 34, 0.15);
        }

        .filters-actions {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 8px;
        }

        .lens-status {
            margin-top: var(--space-2);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: var(--color-fg-muted);
        }

        .lens-chip {
            display: inline-flex;
            align-items: center;
            border: 1px solid var(--color-border-default);
            border-radius: 999px;
            padding: 2px 8px;
            background: var(--color-canvas-subtle);
            color: var(--color-fg-default);
            font-weight: 600;
            font-size: 12px;
        }

        .header-shell {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
        }

        .header-copy {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 0;
        }

        .header-actions {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-settings-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            height: 36px;
            padding: 0 12px;
            border-radius: 8px;
            border: 1px solid var(--color-border-default);
            background: var(--color-canvas-default);
            color: var(--color-fg-default);
            font-weight: 600;
        }

        .header-settings-button:hover {
            background: var(--color-canvas-subtle);
            border-color: #afb8c1;
        }

        .header-settings-menu {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            z-index: 1100;
            width: 280px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            border: 1px solid var(--color-border-default);
            border-radius: 10px;
            background: var(--color-canvas-default);
            box-shadow: var(--shadow-lg);
        }

        .header-actions.open .header-settings-menu {
            display: flex;
        }

        .header-settings-section-label {
            margin: 4px 4px 2px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
            color: var(--color-fg-muted);
        }

        .header-settings-divider {
            height: 1px;
            margin: 4px 2px;
            background: var(--color-border-muted);
        }

        .header-settings-item {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 34px;
            padding: 0 10px;
            border: 1px solid transparent;
            border-radius: 8px;
            background: transparent;
            color: var(--color-fg-default);
            font-size: 14px;
            font-weight: 500;
            justify-content: flex-start;
            text-align: left;
        }

        .header-settings-item:hover {
            background: var(--color-canvas-subtle);
            border-color: var(--color-border-muted);
        }

        .header-settings-item-icon {
            width: 18px;
            text-align: center;
            flex-shrink: 0;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        label {
            font-weight: 600;
            color: var(--color-fg-default);
            font-size: 12px;
            text-transform: none;
            letter-spacing: 0;
        }

        select, button {
            padding: 5px 12px;
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-2);
            font-size: 14px;
            background: var(--color-canvas-default);
            cursor: pointer;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            font-weight: 500;
            font-family: inherit;
        }

        select:hover {
            border-color: var(--color-border-default);
            background: var(--color-canvas-default);
        }

        select:focus {
            border-color: var(--ewu-red);
            outline: none;
            box-shadow: 0 0 0 3px rgba(161, 0, 34, 0.15);
        }

        /* Primer Button styles */
        button {
            background: var(--color-canvas-subtle);
            color: var(--color-fg-default);
            border: 1px solid var(--color-border-default);
            padding: 5px 16px;
            box-shadow: var(--shadow-sm);
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-1);
        }

        button:hover {
            background: var(--color-canvas-inset);
            transform: none;
            box-shadow: var(--shadow-sm);
            border-color: var(--color-border-default);
        }

        button:active {
            background: var(--color-canvas-inset);
        }

        /* Primary button */
        button.btn-primary {
            background: var(--ewu-red);
            color: var(--color-fg-on-emphasis);
            border: none;
        }

        button.btn-primary:hover {
            background: var(--ewu-red-dark);
        }

        /* Dashboard Navigation Accordion - Primer style */
        .dashboard-nav {
            background: var(--color-canvas-default);
            border-bottom: 1px solid var(--color-border-muted);
        }

        .nav-accordion-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2) var(--space-3);
            background: var(--ewu-red);
            color: var(--color-fg-on-emphasis);
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            transition: background 0.15s ease;
        }

        .nav-accordion-toggle:hover {
            background: var(--ewu-red-dark);
        }

        .nav-accordion-toggle .toggle-icon {
            transition: transform 0.2s ease;
            font-size: 10px;
        }

        .nav-accordion-toggle.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .nav-accordion-content {
            padding: var(--space-3);
            display: block;
            background: var(--color-canvas-subtle);
        }

        .nav-accordion-content.collapsed {
            display: none;
        }

        .nav-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-row:last-child {
            border-bottom: none;
        }

        .nav-row-header {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #718096;
            font-weight: 700;
            min-width: 80px;
        }

        .nav-row-items {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-2);
            text-decoration: none;
            color: var(--color-fg-default);
            font-weight: 500;
            font-size: 12px;
            transition: background 0.15s ease;
            cursor: pointer;
            border: 1px solid var(--color-border-default);
            background: var(--color-canvas-default);
        }

        .nav-link:hover {
            background: var(--color-canvas-subtle);
            border-color: var(--color-border-default);
            color: var(--color-fg-default);
            box-shadow: none;
            transform: none;
        }

        .nav-link .icon {
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .nav-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav-row-header {
                margin-bottom: var(--space-2);
            }
        }

        /* Faculty Modal */
        .faculty-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .faculty-modal-overlay.visible {
            display: flex;
        }

        .faculty-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .faculty-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .faculty-modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .faculty-modal-header .faculty-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .faculty-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .faculty-modal-close:hover {
            background: #f3f4f6;
            color: #374151;
            transform: none;
            box-shadow: none;
        }

        .faculty-modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .faculty-section {
            margin-bottom: 20px;
        }

        .faculty-section h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6b7280;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .faculty-schedule-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .faculty-schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 14px;
        }

        .faculty-schedule-item .course-code {
            font-weight: 600;
            color: #111827;
        }

        .faculty-schedule-item .course-details {
            color: #6b7280;
            font-size: 13px;
        }

        .faculty-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .faculty-stat {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .faculty-stat .value {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }

        .faculty-stat .label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .faculty-pref-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .faculty-pref-tag {
            display: inline-block;
            padding: 4px 10px;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 4px;
            font-size: 13px;
        }

        .faculty-modal-section {
            margin-bottom: 20px;
        }

        .faculty-modal-section h4 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6b7280;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .faculty-course-item {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 12px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .faculty-course-item .course-code {
            font-weight: 600;
            color: #111827;
        }

        .faculty-course-item .course-title {
            color: #374151;
        }

        .faculty-course-item .course-details {
            color: #6b7280;
            font-size: 13px;
            width: 100%;
        }

        .faculty-modal-stats .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .faculty-modal-stats .stat-item .stat-label {
            color: #6b7280;
            font-size: 14px;
        }

        .faculty-modal-stats .stat-item .stat-value {
            font-weight: 600;
            color: #111827;
        }

        .faculty-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .pref-tag {
            display: inline-block;
            padding: 6px 12px;
            background: #f3f4f6;
            color: #374151;
            border-radius: 6px;
            font-size: 13px;
        }

        .pref-link {
            display: inline-block;
            color: #667eea;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
        }

        .pref-link:hover {
            text-decoration: underline;
        }

        .faculty-legend-item {
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #d0d7de;
            background: #fff;
        }

        .faculty-legend-item:hover {
            background: #f6f8fa;
            border-color: #b8c1cc;
        }

        .stats-bar {
            padding: var(--space-2) var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            background: var(--color-canvas-subtle);
            border-bottom: 1px solid var(--color-border-muted);
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            white-space: nowrap;
        }

        .stat-item .stat-icon {
            font-size: 12px;
        }

        .stat-item .stat-number {
            font-weight: 600;
            color: var(--color-fg-default);
        }

        .stat-item .stat-label {
            color: var(--color-fg-muted);
            font-size: 12px;
        }

        .stat-item.critical .stat-number {
            color: var(--color-danger-emphasis);
        }

        .stat-item.warning .stat-number {
            color: var(--color-attention-emphasis);
        }

        .stat-item.success .stat-number {
            color: var(--color-success-emphasis);
        }

        .stat-item.info .stat-number {
            color: var(--color-accent-emphasis);
        }

        .content {
            padding: 30px;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 100px repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border: 1px solid #dee2e6;
            margin-bottom: 30px;
        }

        .grid-header {
            background: #495057;
            color: white;
            padding: 15px;
            font-weight: 600;
            text-align: center;
            font-size: 0.9em;
        }

        .time-slot {
            background: #495057;
            color: white;
            padding: 15px 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
        }

        .schedule-cell {
            background: white;
            padding: 8px;
            min-height: 80px;
            position: relative;
            transition: all 0.3s;
        }

        .schedule-cell:hover {
            background: #f8f9fa;
        }

        .course-block {
            background: #e9ecef;
            padding: 8px;
            border-radius: 6px;
            border-left: 4px solid #adb5bd;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 4px;
        }

        .course-block:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .course-block.conflict-0 {
            background: #fff5f5;
            border-left-color: #ff6b6b;
        }

        .course-block.conflict-1 {
            background: #fff3e0;
            border-left-color: #ffa726;
        }

        .course-block.conflict-2 {
            background: #fff9c4;
            border-left-color: #ffd93d;
        }

        .course-name {
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 2px;
            color: #212529;
        }

        .course-details {
            font-size: 0.75em;
            color: #6c757d;
        }

        .conflict-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1000px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        .conflicts-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .conflicts-panel h2 {
            color: #495057;
            margin-bottom: 6px;
            font-size: 1.2em;
        }

        .conflicts-panel-subtitle {
            margin: 0 0 12px;
            color: #6c757d;
            font-size: 0.9em;
        }

        .annual-conflict-summary {
            background: #ffffff;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 14px;
        }

        .annual-conflict-header {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .annual-conflict-header strong {
            font-size: 0.95em;
            color: #212529;
        }

        .annual-conflict-stats {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .annual-conflict-stat {
            font-size: 0.78em;
            border: 1px solid #d0d7de;
            background: #f6f8fa;
            color: #495057;
            border-radius: 999px;
            padding: 3px 9px;
            font-weight: 600;
        }

        .annual-pattern-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .annual-pattern-item {
            border: 1px solid #d0d7de;
            border-left: 4px solid #adb5bd;
            border-radius: 8px;
            padding: 8px 10px;
            background: #fff;
        }

        .annual-pattern-item.critical {
            border-left-color: #ff6b6b;
        }

        .annual-pattern-item.high {
            border-left-color: #ffa726;
        }

        .annual-pattern-item.medium {
            border-left-color: #ffd93d;
        }

        .annual-pattern-title {
            font-size: 0.85em;
            font-weight: 600;
            color: #212529;
        }

        .annual-pattern-meta {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }

        .conflict-quarter-group {
            margin-bottom: 14px;
            padding-bottom: 4px;
            border-bottom: 1px dashed #d0d7de;
        }

        .conflict-quarter-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .conflict-quarter-title {
            margin: 0 0 10px;
            font-size: 0.95em;
            color: #374151;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .current-quarter-tag {
            font-size: 0.72em;
            border: 1px solid #d0d7de;
            background: #f6f8fa;
            color: #59636e;
            border-radius: 999px;
            padding: 2px 8px;
            font-weight: 600;
        }

        .no-conflicts-quarter {
            margin: 0 0 8px;
            color: #1a7f37;
            font-size: 0.88em;
            font-weight: 600;
        }

        .conflict-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #adb5bd;
            transition: all 0.3s;
        }

        .conflict-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .conflict-item.critical {
            border-left-color: #ff6b6b;
        }

        .conflict-item.high {
            border-left-color: #ffa726;
        }

        .conflict-item.medium {
            border-left-color: #ffd93d;
        }

        .conflict-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .conflict-time {
            font-weight: 600;
            color: #212529;
            font-size: 1.1em;
        }

        .severity-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-badge.critical {
            background: #ff6b6b;
            color: white;
        }

        .severity-badge.high {
            background: #ffa726;
            color: white;
        }

        .severity-badge.medium {
            background: #ffd93d;
            color: #333;
        }

        .conflict-courses {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .conflict-course-tag {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .recommendations {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
        }

        .recommendations h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .recommendation-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }

        .recommendation-item h3 {
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .priority-high {
            border-left: 4px solid #fff;
        }

        .priority-critical {
            border-left: 4px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.2) !important;
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .day-divider {
            grid-column: 1 / -1;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            margin: 10px 0;
            position: relative;
        }

        .day-divider::after {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 5px 15px;
            font-weight: 600;
            color: #667eea;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .day-divider.mw::after {
            content: 'Monday/Wednesday';
        }

        .day-divider.tr::after {
            content: 'Tuesday/Thursday';
        }

        /* Faculty color coding */
        .faculty-masingale { --faculty-accent: #667eea; --faculty-glow: rgba(102, 126, 234, 0.28); border-left-color: #667eea !important; }
        .faculty-durr { --faculty-accent: #e67e22; --faculty-glow: rgba(230, 126, 34, 0.28); border-left-color: #e67e22 !important; }
        .faculty-manikoth { --faculty-accent: #27ae60; --faculty-glow: rgba(39, 174, 96, 0.28); border-left-color: #27ae60 !important; }
        .faculty-mills { --faculty-accent: #9b59b6; --faculty-glow: rgba(155, 89, 182, 0.28); border-left-color: #9b59b6 !important; }
        .faculty-lybbert { --faculty-accent: #e74c3c; --faculty-glow: rgba(231, 76, 60, 0.28); border-left-color: #e74c3c !important; }
        .faculty-hustrulid { --faculty-accent: #f39c12; --faculty-glow: rgba(243, 156, 18, 0.28); border-left-color: #f39c12 !important; }
        .faculty-sopu { --faculty-accent: #3498db; --faculty-glow: rgba(52, 152, 219, 0.28); border-left-color: #3498db !important; }
        .faculty-norris { --faculty-accent: #1abc9c; --faculty-glow: rgba(26, 188, 156, 0.28); border-left-color: #1abc9c !important; }
        .faculty-braukmann { --faculty-accent: #34495e; --faculty-glow: rgba(52, 73, 94, 0.28); border-left-color: #34495e !important; }
        .faculty-allison { --faculty-accent: #d35400; --faculty-glow: rgba(211, 84, 0, 0.28); border-left-color: #d35400 !important; }
        .faculty-online { --faculty-accent: #7f8c8d; --faculty-glow: rgba(127, 140, 141, 0.28); border-left-color: #7f8c8d !important; }
        .faculty-adjunct { --faculty-accent: #95a5a6; --faculty-glow: rgba(149, 165, 166, 0.28); border-left-color: #95a5a6 !important; }
        .faculty-tbd { --faculty-accent: #bdc3c7; --faculty-glow: rgba(189, 195, 199, 0.28); border-left-color: #bdc3c7 !important; }

        .faculty-legend {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-canvas-subtle);
            border-radius: var(--radius-2);
            margin-bottom: var(--space-3);
            border: 1px solid var(--color-border-muted);
        }

        .faculty-legend-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-2);
            font-size: 12px;
            color: var(--color-fg-muted);
        }

        .faculty-legend-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .faculty-legend-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }

        .faculty-legend-name {
            font-weight: 600;
            color: var(--color-fg-default);
        }

        .faculty-legend-meta {
            color: var(--color-fg-muted);
        }

        .faculty-legend-empty {
            color: var(--color-fg-muted);
            font-size: 12px;
        }

        .faculty-color-bar {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-1);
        }

        /* Minor highlighting */
        .course-block.minor-highlight {
            border-width: 3px;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .minor-info-panel {
            background: linear-gradient(135deg, #74c0fc 0%, #4dabf7 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .minor-info-panel h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .minor-courses {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .minor-course-tag {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
            font-size: 0.9em;
        }

        .minor-note {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9em;
            font-style: italic;
        }

        .suggested-minors {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .suggested-minors h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .minor-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .minor-chip {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #667eea;
            color: #667eea;
            font-weight: 600;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .minor-chip:hover {
            background: #667eea;
            color: white;
        }

        .minor-chip.not-typical {
            border-color: #e67e22;
            color: #e67e22;
        }

        .minor-chip.not-typical:hover {
            background: #e67e22;
            color: white;
        }

        .special-sections-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 900px) {
            .special-sections-grid {
                grid-template-columns: 1fr;
            }
        }

        .online-section {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            border: 1px solid #e1e4e8;
            color: #24292f;
        }

        .online-section h4 {
            margin: 0 0 8px 0;
            font-size: 0.85em;
            font-weight: 600;
            color: #57606a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .online-courses-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .online-course-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #d0d7de;
            font-size: 0.9em;
        }

        .arranged-section {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 0;
            color: white;
        }

        .arranged-section h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .arranged-courses {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .arranged-course-block {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid white;
            backdrop-filter: blur(10px);
        }

        /* Enrollment indicators - compact inline text */
        .enrollment-badge {
            display: inline;
            padding: 0;
            border-radius: 0;
            font-size: 0.75em;
            font-weight: 500;
            margin-left: 2px;
            background: transparent !important;
            color: var(--color-fg-muted) !important;
        }

        .enrollment-high {
            background: #ff6b6b;
            color: white;
        }

        .enrollment-medium {
            background: #ffd93d;
            color: #333;
        }

        .enrollment-low {
            background: #51cf66;
            color: white;
        }

        .trend-growing::after {
            content: " ↗";
            color: #51cf66;
            font-weight: bold;
        }

        .trend-declining::after {
            content: " ↘";
            color: #ff6b6b;
            font-weight: bold;
        }

        .trend-stable::after {
            content: " →";
            color: #4dabf7;
            font-weight: bold;
        }

        .trend-new::after {
            content: " ✨";
            color: #9b59b6;
            font-weight: bold;
        }

        /* Enrollment tooltip */
        .enrollment-tooltip {
            position: absolute;
            background: #2c3e50;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8em;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            pointer-events: none;
        }

        .enrollment-tooltip.show {
            display: block;
        }

        .enrollment-analytics {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .enrollment-analytics h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .enrollment-category {
            margin-bottom: 20px;
        }

        .enrollment-category h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .enrollment-course-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .enrollment-course-tag {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid;
            font-size: 0.85em;
        }

        .enrollment-course-tag.high {
            border-left-color: #ff6b6b;
        }

        .enrollment-course-tag.low {
            border-left-color: #51cf66;
        }

        .enrollment-course-tag.declining {
            border-left-color: #ffa726;
        }

        .quarterly-enrollment {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .quarterly-enrollment h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .enrollment-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .enrollment-history-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .enrollment-history-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .enrollment-history-table tr:hover {
            background: #f8f9fa;
        }

        .enrollment-number {
            font-weight: 600;
            color: #495057;
        }

        .enrollment-split {
            font-size: 0.85em;
            color: #6c757d;
        }

        .course-note-badge {
            display: inline-block;
            background: #9b59b6;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 8px;
        }

        .conflict-solver-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .conflict-solver-panel h2 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .conflict-solution-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ff6b6b;
        }

        .conflict-solution-card h3 {
            color: #ff6b6b;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .solution-option {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #51cf66;
        }

        .solution-option.creates-conflict {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .solution-option.warning {
            border-left-color: #ffd93d;
            background: #fffdf0;
        }

        .solution-recommendation {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .solution-details {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .schedule-grid {
                grid-template-columns: 80px repeat(7, 1fr);
                font-size: 0.8em;
            }

            h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Edit Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: #1f2937;
        }
        .modal-body {
            padding: 24px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 12px;
            max-width: 560px;
            width: min(92vw, 560px);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primer-border-default, #d0d7de);
        }

        .api-help {
            margin-bottom: 14px;
            background: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            color: #4b5563;
        }

        .api-help strong {
            color: #1f2937;
            display: block;
            margin-bottom: 6px;
        }

        .api-provider-type {
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .api-provider-type label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #374151;
            cursor: pointer;
            user-select: none;
        }

        .api-provider-type input[type="checkbox"] {
            margin-right: 8px;
            transform: translateY(1px);
        }

        .api-provider-note {
            margin: 6px 0 0;
            font-size: 12px;
            color: #6b7280;
        }

        .api-model-group {
            margin-top: 12px;
        }

        .api-model-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #374151;
            font-weight: 600;
        }

        .api-model-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            color: #1f2937;
        }

        .api-model-note {
            margin: 6px 0 0;
            font-size: 12px;
            color: #6b7280;
        }

        .api-status-box {
            margin-top: 12px;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            background: #f8fafc;
            padding: 10px 12px;
            min-height: 56px;
        }

        .api-status-box.ok {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .api-status-box.warn {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .api-status-box.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .api-status-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: #6b7280;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .api-status-message {
            font-size: 13px;
            color: #1f2937;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        .form-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            margin-left: auto;
        }
        .btn-save {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(34, 197, 94, 0.25);
        }
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }
        .btn-save:active {
            transform: translateY(0);
        }
        .btn-evaluate {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.25);
        }
        .btn-evaluate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }
        .btn-evaluate:active {
            transform: translateY(0);
        }
        .btn-ai {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.25);
        }
        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }
        .btn-ai:active {
            transform: translateY(0);
        }
        .btn-settings {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: #4a5568;
        }
        .btn-settings:hover {
            background: #f7fafc;
            border-color: var(--ewu-red);
            color: var(--ewu-red);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .btn-settings:active {
            transform: translateY(0);
        }

        /* Toggle Switch for Constraints */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #10b981;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .course-details-content {
            padding: 20px 24px;
        }
        .course-details-content p {
            margin: 8px 0;
            color: #4b5563;
        }
        .course-details-content strong {
            color: #1f2937;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1f2937;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1100;
        }
        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Drag and Drop Styles */
        .course-block[draggable="true"] {
            cursor: grab;
        }
        .course-block[draggable="true"]:active {
            cursor: grabbing;
        }
        .course-block.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .schedule-cell.drop-zone {
            transition: all 0.2s ease;
        }
        .schedule-cell.drag-over {
            background: #e7f5ff !important;
            border: 2px dashed #339af0;
            box-shadow: inset 0 0 10px rgba(51, 154, 240, 0.2);
        }
        .schedule-cell.drop-highlight {
            background: #d3f9d8 !important;
            border: 2px solid #51cf66;
        }
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 2000;
            opacity: 0.9;
            transform: rotate(3deg);
        }
        .drop-indicator {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1500;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .drop-indicator.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Displaced Course Tray Sidebar */
        .displaced-tray {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: white;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .displaced-tray.open {
            transform: translateX(0);
        }
        .displaced-tray-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .displaced-tray-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .displaced-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        .displaced-tray-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
        }
        .displaced-tray-close:hover {
            opacity: 1;
        }
        .displaced-tray-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .displaced-course-card {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: grab;
            transition: all 0.2s;
        }
        .displaced-course-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .displaced-course-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .displaced-course-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .displaced-course-code {
            font-weight: 600;
            color: #1f2937;
        }
        .displaced-course-remove {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 2px;
            font-size: 1rem;
            line-height: 1;
        }
        .displaced-course-remove:hover {
            color: #ef4444;
        }
        .displaced-course-name {
            font-size: 0.85rem;
            color: #4b5563;
            margin-bottom: 6px;
        }
        .displaced-course-origin {
            font-size: 0.75rem;
            color: #9ca3af;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        .displaced-tray-actions {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .displaced-tray-actions button {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .btn-add-course {
            color: white;
            border: none;
            font-weight: 600;
        }
        .btn-clear-all {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .btn-clear-all:hover {
            background: #fecaca;
        }
        /* Swap Mode Toggle Switch */
        .swap-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .swap-toggle-label {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
        }
        .swap-toggle-label.active {
            color: #059669;
            font-weight: 600;
        }
        .swap-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }
        .swap-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .swap-toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #e5e7eb;
            border-radius: 26px;
            transition: 0.3s;
        }
        .swap-toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .swap-toggle input:checked + .swap-toggle-slider {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .swap-toggle input:checked + .swap-toggle-slider:before {
            transform: translateX(24px);
        }
        .displaced-tray.drag-over {
            background: #ecfdf5;
            box-shadow: 4px 0 20px rgba(16, 185, 129, 0.3);
        }
        .displaced-tray.drag-over .displaced-tray-content {
            border: 2px dashed #10b981;
            border-radius: 8px;
            margin: 8px;
        }
        .displaced-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        .displaced-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }
        /* Toggle button when tray is closed */
        .displaced-tray-toggle {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 8px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            z-index: 999;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            display: none;
        }
        .displaced-tray-toggle.visible {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .displaced-tray-toggle .toggle-count {
            background: #ef4444;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            writing-mode: horizontal-tb;
        }
        /* Delete button on course blocks - subtle gray X */
        .course-block .delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: transparent;
            color: var(--color-fg-muted);
            border: none;
            width: 16px;
            height: 16px;
            border-radius: var(--radius-1);
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s, background 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .course-block:hover .delete-btn {
            opacity: 0.6;
        }
        .course-block .delete-btn:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.1);
            color: var(--color-fg-default);
            transform: none;
        }
        /* Confirmation Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .confirm-modal.active {
            display: flex;
        }
        .confirm-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .confirm-dialog h3 {
            margin: 0 0 12px 0;
            color: #1f2937;
        }
        .confirm-dialog p {
            color: #6b7280;
            margin: 0 0 20px 0;
        }
        .confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .confirm-actions button {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-confirm-delete {
            background: #ef4444;
            color: white;
            border: none;
        }
        .btn-confirm-delete:hover {
            background: #dc2626;
        }
        .btn-confirm-cancel {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 1200px) {
            .controls {
                gap: 20px;
            }
            .action-buttons {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
        }

        @media (max-width: 992px) {
            body {
                padding: 20px 10px;
            }
            .container {
                border-radius: 16px;
            }
            header {
                padding: 35px 20px;
            }
            h1 {
                font-size: 2.2em;
            }
            .controls {
                padding: 24px;
                gap: 16px;
            }
            .control-group {
                min-width: 180px;
            }
            .action-buttons {
                width: 100%;
                justify-content: center;
                margin-top: 12px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px 5px;
            }
            .container {
                border-radius: 12px;
            }
            header {
                padding: 28px 16px;
            }
            h1 {
                font-size: 1.8em;
            }
            .subtitle {
                font-size: 1em;
            }
            .controls {
                padding: 16px;
                flex-direction: column;
                gap: 12px;
            }
            .control-group {
                width: 100%;
                min-width: unset;
            }
            .action-buttons {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            .action-buttons button {
                width: 100%;
                justify-content: center;
            }
            .nav-accordion-toggle {
                padding: 12px 16px;
            }
            .nav-accordion-content {
                padding: 16px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            h1 {
                font-size: 1.5em;
            }
            .subtitle {
                font-size: 0.9em;
            }
            header {
                padding: 20px 12px;
            }
            .controls {
                padding: 12px;
            }
            select {
                font-size: 0.95em;
                padding: 10px 12px;
            }
        }

        /* EWU Editorial + Primer-Style Theme Override */
        :root {
            --ewu-red: #B7142E;
            --ewu-red-dark: #8F0F24;
            --ewu-black: #1a1a1a;
            --ewu-paper: #faf9f7;
            --ewu-stone: #f0eeeb;
            --ewu-muted: #6b6560;
            --ewu-line: #ddd8d2;
            --ewu-accent: #c4450c;
            --ewu-success: #2a7d4f;
            --ewu-warning: #b45309;
            --ewu-mono: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --primary-gradient: linear-gradient(180deg, #B7142E 0%, #8F0F24 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--ewu-paper);
            color: var(--ewu-black);
            font-size: 16px;
            line-height: 1.6;
        }

        .container {
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
            max-width: 96%;
        }

        header {
            background: var(--ewu-black);
            color: var(--ewu-paper);
            padding: 2rem 2rem 1.75rem;
            margin-bottom: 1rem;
            text-align: left;
            border-radius: 0;
            border-bottom: 3px solid var(--ewu-red);
        }

        .header-eyebrow {
            font-size: 13px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--ewu-accent);
            margin-bottom: 0.45rem;
            font-family: var(--ewu-mono);
            font-weight: 700;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 800;
            line-height: 1.15;
            margin-bottom: 0.45rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1.05rem;
            color: #b5b0aa;
            opacity: 1;
            line-height: 1.45;
        }

        .year-nav,
        .quarter-tabs,
        .stats-bar,
        .legend,
        .faculty-legend,
        .online-section,
        .conflicts-panel,
        .conflict-solver-panel {
            background: var(--ewu-stone);
            border: 1px solid var(--ewu-line);
        }

        .year-nav {
            justify-content: space-between;
            gap: 12px;
            border-radius: 0;
            margin-bottom: 0;
            border-bottom: none;
        }

        .year-selector label,
        .filter-group label {
            font-family: var(--ewu-mono);
            text-transform: uppercase;
            letter-spacing: 1.4px;
            font-size: 11px;
            color: var(--ewu-muted);
            font-weight: 700;
        }

        .copy-year-btn,
        .btn-secondary,
        .header-settings-item,
        .nav-link {
            border-color: var(--ewu-line);
            color: var(--ewu-black);
            background: #ffffff;
        }

        .copy-year-btn:hover,
        .btn-secondary:hover,
        .header-settings-item:hover,
        .nav-link:hover {
            background: var(--ewu-stone);
            border-color: #c8c1ba;
        }

        .quarter-tabs {
            border-top: none;
            border-bottom: 1px solid var(--ewu-line);
            gap: 8px;
        }

        .quarter-tab {
            border-radius: 0;
            font-weight: 700;
            color: var(--ewu-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
            padding: 12px 12px;
        }

        .quarter-tab.active {
            color: var(--ewu-black);
        }

        .quarter-tab.active::after {
            background: var(--ewu-red);
            height: 3px;
            border-radius: 0;
        }

        .filters-toggle,
        .nav-accordion-toggle {
            font-family: var(--ewu-mono);
            letter-spacing: 1.2px;
            text-transform: uppercase;
            font-size: 11px;
            font-weight: 700;
        }

        .nav-accordion-toggle {
            background: var(--ewu-black);
            color: var(--ewu-paper);
        }

        .nav-accordion-toggle:hover {
            background: #2b2b2b;
        }

        .nav-row-header {
            color: var(--ewu-accent);
            font-family: var(--ewu-mono);
            letter-spacing: 1.5px;
            font-size: 11px;
        }

        .stats-bar {
            padding: 14px 18px;
            display: grid;
            grid-template-columns: repeat(4, minmax(120px, 1fr));
            gap: 10px;
            border-top: none;
        }

        .stat-item {
            background: #ffffff;
            border: 1px solid var(--ewu-line);
            border-left: 3px solid var(--ewu-red);
            border-radius: 0;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
        }

        .stat-item .stat-number {
            font-size: 1.2rem;
            font-weight: 800;
            line-height: 1.1;
        }

        .stat-item .stat-label {
            font-family: var(--ewu-mono);
            font-size: 10px;
            letter-spacing: 1.1px;
            text-transform: uppercase;
            color: var(--ewu-muted);
            margin-top: 4px;
        }

        .stat-item.critical {
            border-left-color: var(--ewu-red);
        }

        .stat-item.warning {
            border-left-color: var(--ewu-warning);
        }

        .stat-item.success {
            border-left-color: var(--ewu-success);
        }

        .stat-item.info {
            border-left-color: #2b6cb0;
        }

        .content {
            padding: 24px;
        }

        .schedule-grid {
            background: var(--ewu-line);
            border: 1px solid var(--ewu-line);
            border-radius: 0;
        }

        .grid-header,
        .time-slot {
            background: var(--ewu-black);
            color: var(--ewu-paper);
            font-family: var(--ewu-mono);
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .schedule-cell {
            background: #ffffff;
        }

        .schedule-cell:hover {
            background: #f5f3f0;
        }

        .course-block {
            background: #ffffff;
            border: 1px solid #e2ddd7;
            border-left: 4px solid var(--ewu-red);
            border-radius: 0;
            box-shadow: none;
            padding: 8px 10px;
        }

        .course-block:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .course-name {
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 0.1px;
        }

        .course-details {
            color: var(--ewu-muted);
            font-size: 12px;
        }

        .day-divider {
            background: var(--ewu-red);
            height: 2px;
            margin: 10px 0;
        }

        .day-divider::after {
            color: var(--ewu-red);
            font-family: var(--ewu-mono);
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: 1px solid var(--ewu-line);
            border-radius: 0;
        }

        .conflicts-panel,
        .conflict-solver-panel,
        .recommendations,
        .minor-info-panel,
        .arranged-section {
            border-radius: 0;
        }

        .recommendations {
            background: #fff0eb;
            color: var(--ewu-black);
            border: 1px solid #f0d6cb;
            border-left: 4px solid var(--ewu-accent);
        }

        .recommendations h2 {
            color: var(--ewu-black);
        }

        .recommendation-item {
            background: #ffffff;
            border: 1px solid #ead4cb;
            border-left: 3px solid var(--ewu-accent);
            backdrop-filter: none;
            border-radius: 0;
        }

        .schedule-grid-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            gap: 16px;
        }

        .schedule-grid-title {
            margin: 0;
            color: var(--ewu-black);
            font-size: 1.35rem;
            font-weight: 800;
            letter-spacing: -0.01em;
        }

        .schedule-grid-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .scheduler-assistant-panel {
            margin-top: 16px;
            margin-bottom: 18px;
            background: #ffffff;
            border: 1px solid var(--ewu-line);
            border-left: 4px solid var(--ewu-red);
            padding: 16px;
        }

        .scheduler-assistant-header {
            margin-bottom: 12px;
        }

        .scheduler-assistant-eyebrow {
            font-size: 11px;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            font-family: var(--ewu-mono);
            color: var(--ewu-accent);
            font-weight: 700;
            margin-bottom: 4px;
        }

        .scheduler-assistant-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--ewu-black);
        }

        .scheduler-assistant-header p {
            margin: 6px 0 0;
            color: var(--ewu-muted);
            font-size: 0.95rem;
        }

        .scheduler-assistant-input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
        }

        .scheduler-question-input {
            border: 1px solid var(--ewu-line);
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            min-height: 90px;
            resize: vertical;
            background: #fff;
            color: var(--ewu-black);
        }

        .scheduler-assistant-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 185px;
        }

        .scheduler-assistant-actions button {
            min-height: 38px;
        }

        .scheduler-assistant-response {
            margin-top: 12px;
            border: 1px solid var(--ewu-line);
            background: var(--ewu-stone);
            padding: 12px;
            white-space: pre-wrap;
            line-height: 1.55;
            font-size: 14px;
            color: var(--ewu-black);
            min-height: 70px;
        }

        .scheduler-assistant-response.empty {
            color: var(--ewu-muted);
            font-style: italic;
        }

        .legend,
        .faculty-legend {
            border-radius: 0;
        }

        .modal,
        .faculty-modal,
        .confirm-dialog {
            border-radius: 0;
            border: 1px solid var(--ewu-line);
        }

        .modal-header,
        .faculty-modal-header {
            border-bottom: 1px solid var(--ewu-line);
        }

        button.btn-primary {
            background: var(--ewu-red);
            border: 1px solid var(--ewu-red-dark);
            color: #fff;
        }

        button.btn-primary:hover {
            background: var(--ewu-red-dark);
        }

        .btn-ewu-accent {
            background: var(--ewu-red) !important;
            color: #fff !important;
            border: 1px solid var(--ewu-red-dark) !important;
            border-radius: 0 !important;
            font-weight: 700 !important;
        }

        .btn-ewu-accent:hover {
            background: var(--ewu-red-dark) !important;
        }

        .btn-add-course-main {
            padding: 10px 16px !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 8px !important;
            height: auto !important;
        }

        .btn-add-icon {
            font-family: var(--ewu-mono);
            font-size: 16px;
            line-height: 1;
        }

        .displaced-tray-actions .btn-ewu-accent {
            margin-bottom: 8px;
        }

        .ai-results-header-ewu {
            background: var(--ewu-black) !important;
            border-bottom: 2px solid var(--ewu-red);
        }

        /* Program Command + Primer Product UI Refinement */
        :root {
            --tray-width: 220px;
            --tray-edge: 10px;
            --primer-fg-default: #1f2328;
            --primer-fg-muted: #59636e;
            --primer-border-default: #d0d7de;
            --primer-bg-default: #ffffff;
            --primer-bg-subtle: #f6f8fa;
            --primer-canvas: #f3f4f6;
            --primer-shadow: 0 1px 0 rgba(27, 31, 36, 0.04), 0 8px 24px rgba(140, 149, 159, 0.2);
        }

        body {
            background:
                radial-gradient(1200px 320px at 15% 0%, rgba(183, 20, 46, 0.08), transparent 60%),
                radial-gradient(900px 260px at 85% 0%, rgba(9, 105, 218, 0.08), transparent 62%),
                var(--primer-canvas);
            color: var(--primer-fg-default);
        }

        .container {
            max-width: 1360px;
            margin: 20px auto 40px;
            transition: margin-left 0.26s ease;
        }

        body.tray-open .container {
            margin-left: calc(var(--tray-width) + var(--tray-edge) + 18px);
        }

        header {
            background: var(--primer-bg-default);
            color: var(--primer-fg-default);
            border: 1px solid var(--primer-border-default);
            border-top: 4px solid var(--ewu-red);
            border-bottom: 1px solid var(--primer-border-default);
            border-radius: 12px;
            box-shadow: var(--primer-shadow);
        }

        .header-eyebrow {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            background: #fff1f3;
            border: 1px solid #ffd1d9;
            color: #8f0f24;
        }

        .subtitle {
            color: var(--primer-fg-muted);
        }

        .year-nav,
        .quarter-tabs,
        .legend,
        .faculty-legend,
        .online-section,
        .conflicts-panel,
        .conflict-solver-panel {
            background: var(--primer-bg-default);
            border: 1px solid var(--primer-border-default);
            border-radius: 12px;
            box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04);
        }

        .year-nav {
            padding: 14px 16px;
            margin-bottom: 10px;
        }

        .quarter-tabs {
            padding: 8px;
            gap: 8px;
            margin-bottom: 12px;
        }

        .quarter-tab {
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--primer-fg-muted);
            font-weight: 600;
            text-transform: none;
            letter-spacing: 0;
            font-size: 14px;
        }

        .quarter-tab:hover {
            background: var(--primer-bg-subtle);
            color: var(--primer-fg-default);
        }

        .quarter-tab.active {
            background: #24292f;
            border-color: #24292f;
            color: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
        }

        .quarter-tab.active::after {
            display: none;
        }

        .filters-toggle,
        .nav-accordion-toggle {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            letter-spacing: 0;
            text-transform: none;
            font-size: 13px;
            font-weight: 600;
        }

        .nav-accordion-toggle {
            background: var(--primer-bg-default);
            color: var(--primer-fg-default);
            border: 1px solid var(--primer-border-default);
            border-radius: 10px;
        }

        .nav-accordion-toggle:hover {
            background: var(--primer-bg-subtle);
        }

        .nav-row-header {
            color: var(--primer-fg-muted);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            letter-spacing: 0;
            font-size: 12px;
            font-weight: 700;
        }

        .copy-year-btn,
        .btn-secondary,
        .header-settings-item,
        .nav-link {
            border: 1px solid var(--primer-border-default);
            color: var(--primer-fg-default);
            background: var(--primer-bg-default);
            border-radius: 8px;
            box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04);
        }

        .copy-year-btn:hover,
        .btn-secondary:hover,
        .header-settings-item:hover,
        .nav-link:hover {
            background: var(--primer-bg-subtle);
            border-color: #afb8c1;
        }

        .stats-bar {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            margin-bottom: 14px;
            gap: 12px;
        }

        .stat-item {
            border-radius: 10px;
            border: 1px solid var(--primer-border-default);
            border-top: 3px solid var(--ewu-red);
            border-left: 1px solid var(--primer-border-default);
            box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04);
        }

        .content {
            background: var(--primer-bg-default);
            border: 1px solid var(--primer-border-default);
            border-radius: 12px;
            box-shadow: var(--primer-shadow);
            padding: 20px;
        }

        .schedule-grid {
            border: 1px solid var(--primer-border-default);
            border-radius: 12px;
            overflow: hidden;
            background: var(--primer-border-default);
        }

        .grid-header,
        .time-slot {
            background: #24292f;
            color: #f6f8fa;
            font-family: var(--ewu-mono);
            font-size: 11px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .schedule-cell {
            background: #ffffff;
        }

        .schedule-cell:hover {
            background: #f6f8fa;
        }

        .course-block {
            --faculty-accent: var(--ewu-red);
            border-radius: 8px;
            border: 1px solid var(--primer-border-default);
            border-left: 3px solid var(--faculty-accent);
            box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04);
        }

        .course-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(31, 35, 40, 0.12);
        }

        .btn-ewu-accent {
            border-radius: 8px !important;
            box-shadow: 0 1px 0 rgba(27, 31, 36, 0.08) !important;
        }

        .scheduler-assistant-panel {
            background: linear-gradient(180deg, #ffffff 0%, #f6f8fa 100%);
            border: 1px solid var(--primer-border-default);
            border-left: 1px solid var(--primer-border-default);
            border-radius: 12px;
            box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04);
        }

        .scheduler-assistant-eyebrow {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 999px;
            background: #ddf4ff;
            border: 1px solid #b6e3ff;
            color: #0550ae;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            letter-spacing: 0;
            text-transform: none;
        }

        .scheduler-question-input {
            border: 1px solid var(--primer-border-default);
            border-radius: 8px;
            font-family: var(--ewu-mono);
            line-height: 1.5;
        }

        .scheduler-question-input:focus {
            outline: none;
            border-color: #0969da;
            box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.18);
        }

        .scheduler-assistant-response {
            border-radius: 8px;
            background: #ffffff;
            border: 1px solid var(--primer-border-default);
            white-space: normal;
        }

        .markdown-output {
            color: var(--primer-fg-default);
            line-height: 1.6;
            font-size: 14px;
        }

        .markdown-output > :first-child {
            margin-top: 0;
        }

        .markdown-output > :last-child {
            margin-bottom: 0;
        }

        .markdown-output h1,
        .markdown-output h2,
        .markdown-output h3,
        .markdown-output h4 {
            margin: 0 0 10px;
            line-height: 1.3;
            color: #24292f;
        }

        .markdown-output p {
            margin: 0 0 10px;
        }

        .markdown-output ul,
        .markdown-output ol {
            margin: 0 0 10px 20px;
            padding: 0;
        }

        .markdown-output li {
            margin: 4px 0;
        }

        .markdown-output blockquote {
            margin: 10px 0;
            padding: 8px 12px;
            border-left: 3px solid #d0d7de;
            background: #f6f8fa;
            color: #57606a;
        }

        .markdown-output code {
            font-family: var(--ewu-mono);
            background: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 1px 5px;
            font-size: 12px;
        }

        .markdown-output pre {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #30363d;
            background: #0d1117;
            color: #e6edf3;
            overflow-x: auto;
        }

        .markdown-output pre code {
            background: transparent;
            border: none;
            color: inherit;
            padding: 0;
        }

        .markdown-output table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .markdown-output th,
        .markdown-output td {
            border: 1px solid #d0d7de;
            padding: 7px 9px;
            text-align: left;
            vertical-align: top;
            font-size: 13px;
        }

        .markdown-output th {
            background: #f6f8fa;
            font-weight: 600;
        }

        .markdown-output hr {
            border: none;
            border-top: 1px solid #d0d7de;
            margin: 12px 0;
        }

        .markdown-output a {
            color: #0969da;
        }

        .ai-results-header-ewu {
            background: #24292f !important;
            border-bottom: 1px solid #57606a;
        }

        /* Compact translucent displaced tray */
        .displaced-tray {
            left: var(--tray-edge);
            top: var(--tray-edge);
            bottom: var(--tray-edge);
            width: var(--tray-width);
            border: 1px solid var(--primer-border-default);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.78);
            backdrop-filter: blur(10px);
            box-shadow: 0 6px 28px rgba(31, 35, 40, 0.22);
            overflow: hidden;
        }

        .displaced-tray-header {
            padding: 12px 14px;
            background: linear-gradient(180deg, #24292f 0%, #3d444d 100%);
        }

        .displaced-tray-title {
            font-size: 0.95rem;
            font-weight: 700;
        }

        .displaced-tray-content {
            padding: 10px;
        }

        .displaced-course-card {
            background: rgba(246, 248, 250, 0.9);
            border: 1px solid var(--primer-border-default);
            border-left: 3px solid #57606a;
            border-radius: 7px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .displaced-course-origin {
            background: rgba(208, 215, 222, 0.38);
        }

        .displaced-tray-actions {
            padding: 10px;
            border-top: 1px solid var(--primer-border-default);
        }

        .displaced-tray-actions button {
            padding: 8px;
            font-size: 0.83rem;
            border-radius: 7px;
        }

        .displaced-tray-toggle {
            left: 8px;
            padding: 10px 7px;
            border-radius: 0 8px 8px 0;
            box-shadow: 2px 0 10px rgba(31, 35, 40, 0.2);
        }

        @media (max-width: 1220px) {
            body.tray-open .container {
                margin-left: 20px;
            }
            .displaced-tray {
                width: min(210px, 58vw);
            }
        }

        @media (max-width: 860px) {
            .displaced-tray {
                width: min(88vw, 300px);
            }
            .displaced-tray-header {
                padding: 10px 12px;
            }
        }

        :focus-visible {
            outline: 3px solid rgba(183, 20, 46, 0.28);
            outline-offset: 1px;
        }

        @media (max-width: 900px) {
            .stats-bar {
                grid-template-columns: repeat(2, minmax(130px, 1fr));
            }
        }

        @media (max-width: 640px) {
            .container {
                max-width: 100%;
            }
            header {
                padding: 1.4rem 1rem 1.2rem;
            }
            .header-shell {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            .header-actions {
                align-self: flex-start;
            }
            .header-settings-menu {
                right: auto;
                left: 0;
                width: min(92vw, 320px);
            }
            h1 {
                font-size: 1.55rem;
            }
            .subtitle {
                font-size: 0.92rem;
            }
            .stats-bar {
                grid-template-columns: 1fr 1fr;
            }
            .schedule-grid-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .schedule-grid-actions {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }
            .scheduler-assistant-input-row {
                grid-template-columns: 1fr;
            }
            .scheduler-assistant-actions {
                min-width: unset;
                width: 100%;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

    </style>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <!-- Schedule Manager Scripts -->
    <script src="js/config/constants.js"></script>
    <script src="js/schedule-manager.js"></script>
    <script src="js/data-loader.js"></script>

    <!-- Constraints & Conflict Engine -->
    <script src="js/constraints-service.js"></script>
    <script src="js/conflict-engine.js"></script>
    <script src="js/graduation-optimizer.js"></script>
</head>
<body>
    <!-- Displaced Course Tray Sidebar -->
    <div class="displaced-tray" id="displacedTray" ondragover="handleTrayDragOver(event)" ondragleave="handleTrayDragLeave(event)" ondrop="handleTrayDrop(event)">
        <div class="displaced-tray-header">
            <div class="displaced-tray-title">
                Displaced Courses
                <span class="displaced-count" id="displacedCount">0</span>
            </div>
            <button class="displaced-tray-close" onclick="closeDisplacedTray()">&times;</button>
        </div>
        <div class="displaced-tray-content" id="displacedContent">
            <div class="displaced-empty">
                <div class="displaced-empty-icon">📦</div>
                <p>No displaced courses</p>
                <p style="font-size: 0.8rem;">Drag courses here or bump them from slots</p>
            </div>
        </div>
        <div class="displaced-tray-actions">
            <button class="btn-add-course btn-ewu-accent" onclick="openAddCourseModal()">+ Add Course</button>
            <button class="btn-clear-all" onclick="clearAllDisplaced()">Clear All</button>
        </div>
    </div>

    <!-- Toggle button for closed tray -->
    <button class="displaced-tray-toggle" id="displacedToggle" onclick="openDisplacedTray()">
        <span class="toggle-count" id="toggleCount">0</span>
        Displaced
    </button>

    <!-- Delete Confirmation Modal -->
    <div class="confirm-modal" id="deleteConfirmModal">
        <div class="confirm-dialog">
            <h3>Delete Course</h3>
            <p id="deleteConfirmText">Are you sure you want to remove this course from the schedule?</p>
            <div class="confirm-actions">
                <button class="btn-confirm-cancel" onclick="closeDeleteConfirm()">Cancel</button>
                <button class="btn-confirm-delete" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-shell">
                <div class="header-copy">
                    <div class="header-eyebrow">EWU DESIGN · PROGRAM COMMAND</div>
                    <h1>Program Command</h1>
                    <p class="subtitle">Design Program Planning, Scheduling, and Scenario Control</p>
                </div>
                <div class="header-actions" id="headerActions">
                    <button class="header-settings-button" id="headerSettingsButton" type="button" onclick="toggleHeaderSettingsMenu(event)" aria-haspopup="true" aria-expanded="false" title="Open settings and actions">
                        <span aria-hidden="true">⚙️</span>
                        <span>Settings</span>
                    </button>
                    <div class="header-settings-menu" id="headerSettingsMenu" role="menu" aria-label="Program command settings">
                        <div class="header-settings-section-label">Schedule</div>
                        <button class="header-settings-item" type="button" onclick="runHeaderSettingsAction('save')">
                            <span class="header-settings-item-icon">💾</span>
                            <span>Save Schedule</span>
                        </button>
                        <button class="header-settings-item" type="button" onclick="runHeaderSettingsAction('conflicts')">
                            <span class="header-settings-item-icon">🔍</span>
                            <span>Detect Conflicts</span>
                        </button>
                        <button class="header-settings-item" type="button" onclick="runHeaderSettingsAction('ai')">
                            <span class="header-settings-item-icon">✨</span>
                            <span>AI Analysis</span>
                        </button>
                        <button class="header-settings-item" type="button" onclick="runHeaderSettingsAction('print')">
                            <span class="header-settings-item-icon">🖨️</span>
                            <span>Print Schedule</span>
                        </button>
                        <button class="header-settings-item" type="button" onclick="runHeaderSettingsAction('sheets')">
                            <span class="header-settings-item-icon">📊</span>
                            <span>Export to Sheets</span>
                        </button>
                        <div class="header-settings-divider"></div>
                        <div class="header-settings-section-label">Configuration</div>
                        <button class="header-settings-item" type="button" onclick="runHeaderSettingsAction('rules')">
                            <span class="header-settings-item-icon">📋</span>
                            <span>Constraint Rules</span>
                        </button>
                        <button class="header-settings-item" type="button" onclick="runHeaderSettingsAction('api')">
                            <span class="header-settings-item-icon">🔐</span>
                            <span>API Connections</span>
                        </button>
                        <button class="header-settings-item" type="button" onclick="runHeaderSettingsAction('accounts')">
                            <span class="header-settings-item-icon">👤</span>
                            <span>Users & Accounts</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Year and Quarter Navigation -->
        <div class="year-nav">
            <div class="year-selector">
                <label>Academic Year:</label>
                <select id="yearSelect" onchange="switchAcademicYear(this.value)">
                    <option value="2025-26" selected>2025-26</option>
                    <option value="2026-27">2026-27</option>
                </select>
                <button class="copy-year-btn" onclick="copyToNextYear()" title="Copy current schedule to next year">
                    Copy to Next Year →
                </button>
            </div>
        </div>

        <!-- Quarter Tabs - Primary Navigation -->
        <div class="quarter-tabs">
            <button class="quarter-tab" data-quarter="fall" onclick="selectQuarterTab('fall')">Fall <span class="tab-year">2025</span></button>
            <button class="quarter-tab" data-quarter="winter" onclick="selectQuarterTab('winter')">Winter <span class="tab-year">2026</span></button>
            <button class="quarter-tab active" data-quarter="spring" onclick="selectQuarterTab('spring')">Spring <span class="tab-year">2026</span></button>
        </div>

        <!-- Collapsible Filters Panel -->
        <div class="filters-panel collapsed" id="filtersPanel">
            <div class="filters-toggle" onclick="toggleFiltersPanel()">
                <span>🎯 Advising Lens</span>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="filters-content" id="filtersContent">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="trackFilter">Student Track:</label>
                        <select id="trackFilter">
                            <option value="all">All Tracks</option>
                            <option value="ux">UX Design</option>
                            <option value="interaction-design">Interaction Design</option>
                            <option value="web-development">Web Development</option>
                            <option value="animation">Animation</option>
                            <option value="game-design">Game Design</option>
                            <option value="motion">Motion Design</option>
                            <option value="photography">Photography</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="minorFilter">Program / Minor Lens:</label>
                        <select id="minorFilter">
                            <option value="all">No Minor Lens</option>
                            <option value="ux">UX/Interaction Design</option>
                            <option value="animation">Animation</option>
                            <option value="gameDesign">Game Design</option>
                            <option value="graphicDesign">Graphic Design</option>
                            <option value="photography">Photography</option>
                            <option value="webDevelopment">Web Development</option>
                        </select>
                    </div>

                    <div class="filter-group filters-actions">
                        <button class="btn-secondary" type="button" onclick="resetLensFilters()">Clear Lens</button>
                    </div>
                </div>
                <div class="lens-status" id="lensStatus">No advising lens active.</div>
            </div>
        </div>

        <!-- Hidden select for compatibility with existing code -->
        <select id="quarterSelect" style="display: none;">
            <option value="fall">Fall 2025</option>
            <option value="winter">Winter 2026</option>
            <option value="spring" selected>Spring 2026</option>
        </select>

        <!-- Dashboard Navigation -->
        <div class="dashboard-nav">
            <div class="nav-accordion-toggle collapsed" onclick="toggleNavAccordion()">
                <span>📌 Dashboards & Tools</span>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="nav-accordion-content collapsed" id="navAccordionContent">
                <!-- Analytics Row -->
                <div class="nav-row">
                    <span class="nav-row-header">Analytics</span>
                    <div class="nav-row-items">
                        <a href="enrollment-dashboard.html" class="nav-link"><span class="icon">📊</span>Enrollment</a>
                        <a href="pages/workload-dashboard.html" class="nav-link"><span class="icon">👥</span>Workload</a>
                        <a href="pages/capacity-planning-dashboard.html" class="nav-link"><span class="icon">📈</span>Capacity</a>
                        <a href="pages/applied-learning-dashboard.html" class="nav-link"><span class="icon">🎓</span>Applied Learning</a>
                    </div>
                </div>
                <!-- Planning Row -->
                <div class="nav-row">
                    <span class="nav-row-header">Planning</span>
                    <div class="nav-row-items">
                        <a href="pages/schedule-builder.html" class="nav-link"><span class="icon">📅</span>Builder</a>
                        <a href="pages/academic-year-setup.html" class="nav-link"><span class="icon">🗂️</span>AY Setup</a>
                        <a href="pages/course-management.html" class="nav-link"><span class="icon">📚</span>Courses</a>
                        <a href="pages/workload-dashboard.html" class="nav-link"><span class="icon">👥</span>Workload</a>
                        <a href="pages/constraints-dashboard.html" class="nav-link"><span class="icon">🔒</span>Constraints</a>
                        <a href="pages/demand-planning-dashboard.html" class="nav-link"><span class="icon">⚡</span>Demand</a>
                    </div>
                </div>
                <!-- Tools Row -->
                <div class="nav-row">
                    <span class="nav-row-header">Tools</span>
                    <div class="nav-row-items">
                        <button onclick="highlightConflicts()" class="nav-link"><span class="icon">🔍</span>Conflicts</button>
                        <button onclick="exportReport()" class="nav-link"><span class="icon">📋</span>Export</button>
                        <a href="pages/pamcam-playground.html" class="nav-link"><span class="icon">🧪</span>PamCam Lab</a>
                        <a href="pages/release-time-dashboard.html" class="nav-link"><span class="icon">🔧</span>Release Time</a>
                        <a href="pages/recommendations-dashboard.html" class="nav-link"><span class="icon">💡</span>Recommendations</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item critical">
                <span class="stat-number" id="criticalConflicts">3</span>
                <span class="stat-label">Critical</span>
            </div>
            <div class="stat-item warning">
                <span class="stat-number" id="totalConflicts">7</span>
                <span class="stat-label">Conflicts</span>
            </div>
            <div class="stat-item info">
                <span class="stat-number" id="totalCourses">15</span>
                <span class="stat-label">Courses</span>
            </div>
            <div class="stat-item success">
                <span class="stat-number" id="utilizationRate">78%</span>
                <span class="stat-label">Utilization</span>
            </div>
        </div>

        <div class="content">
            <div id="minorInfoPanel"></div>
            <div id="trackSuggestionsPanel"></div>

            <div class="schedule-grid-header">
                <h2 class="schedule-grid-title">Program Schedule - <span id="quarterTitle">Spring 2026</span></h2>
                <div class="schedule-grid-actions">
                    <div class="swap-toggle-container" title="When ON: Dropping a course onto an occupied slot swaps them. When OFF: The existing course goes to the displaced tray.">
                        <span class="swap-toggle-label" id="displaceLabel">Displace</span>
                        <label class="swap-toggle">
                            <input type="checkbox" id="swapModeToggle" onchange="updateSwapModeLabels()">
                            <span class="swap-toggle-slider"></span>
                        </label>
                        <span class="swap-toggle-label" id="swapLabel">Swap</span>
                    </div>
                    <button class="btn-ewu-accent btn-add-course-main" onclick="openAddCourseModal()">
                        <span class="btn-add-icon">+</span> Add Course
                    </button>
                </div>
            </div>
            <div class="schedule-grid" id="scheduleGrid"></div>

            <div id="onlineSection"></div>
            
            <div class="special-sections-grid">
                <div id="arrangedSection"></div>
            </div>

            <div class="scheduler-assistant-panel">
                <div class="scheduler-assistant-header">
                    <div class="scheduler-assistant-eyebrow">Program Command · ChatGPT</div>
                    <h3>Program Command</h3>
                    <p>Run natural-language planning commands before committing schedule changes.</p>
                </div>
                <div class="scheduler-assistant-input-row">
                    <textarea id="schedulerQuestionInput" class="scheduler-question-input" placeholder="Example: Run without the optional lecturer and redistribute 45 credits with minimum conflict risk."></textarea>
                    <div class="scheduler-assistant-actions">
                        <button class="btn-ewu-accent" onclick="askSchedulerQuestion()">Run Command</button>
                        <button class="btn-secondary" onclick="fillSchedulerQuestion('If the optional lecturer is removed from the 45-credit plan, what is the lowest-risk redistribution across Sam, Sonja, and Meg?')">Without Optional Lecturer</button>
                        <button class="btn-secondary" onclick="fillSchedulerQuestion('Given Travis and Ginelle each have 31 credits plus 5 inload and DESN 499 at 2 per quarter, where are overload risks by quarter?')">Overload Audit</button>
                    </div>
                </div>
                <div id="schedulerQuestionResponse" class="scheduler-assistant-response empty">Your answer will appear here.</div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff5f5; border: 2px solid #ff6b6b;"></div>
                    <span>Critical Conflict (3+ courses)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff3e0; border: 2px solid #ffa726;"></div>
                    <span>High Conflict (2 courses)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e9ecef; border: 2px solid #adb5bd;"></div>
                    <span>No Conflict</span>
                </div>
            </div>

            <div class="faculty-legend" id="facultyLegend"></div>

            <div id="enrollmentAnalytics"></div>

            <div class="analysis-grid">
                <div class="conflicts-panel">
                    <h2>Detected Conflicts</h2>
                    <p class="conflicts-panel-subtitle">Annual pattern scan first, then quarter-by-quarter details.</p>
                    <div id="annualConflictSummary" class="annual-conflict-summary"></div>
                    <div id="conflictsList" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <div class="conflict-solver-panel">
                    <h2>🔧 Resolution Options</h2>
                    <p style="color: #666; font-size: 0.85em; margin-bottom: 15px;">
                        Solutions that won't create new conflicts
                    </p>
                    <div id="conflictSolverList" style="max-height: 350px; overflow-y: auto;"></div>
                </div>
            </div>

            <div class="recommendations" style="padding: 20px;">
                <h2 style="font-size: 1.2em;">Optimization Recommendations</h2>
                <div id="recommendationsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Faculty color mapping
        const facultyColors = {
            'T.Masingale': { class: 'faculty-masingale', color: '#667eea', name: 'T.Masingale' },
            'T. Masingale': { class: 'faculty-masingale', color: '#667eea', name: 'T.Masingale' },
            'S.Durr': { class: 'faculty-durr', color: '#e67e22', name: 'S.Durr' },
            'C.Manikoth': { class: 'faculty-manikoth', color: '#27ae60', name: 'C.Manikoth' },
            'Manikoth': { class: 'faculty-manikoth', color: '#27ae60', name: 'C.Manikoth' },
            'S.Mills': { class: 'faculty-mills', color: '#9b59b6', name: 'S.Mills' },
            'M.Lybbert': { class: 'faculty-lybbert', color: '#e74c3c', name: 'M.Lybbert' },
            'G.Hustrulid': { class: 'faculty-hustrulid', color: '#f39c12', name: 'G.Hustrulid' },
            'A.Sopu': { class: 'faculty-sopu', color: '#3498db', name: 'A.Sopu' },
            'E.Norris': { class: 'faculty-norris', color: '#1abc9c', name: 'E.Norris' },
            'J.Braukmann': { class: 'faculty-braukmann', color: '#34495e', name: 'J.Braukmann' },
            'S.Allison': { class: 'faculty-allison', color: '#d35400', name: 'S.Allison' },
            'Barton/Pettigrew': { class: 'faculty-online', color: '#7f8c8d', name: 'Barton/Pettigrew' },
            'Adjunct': { class: 'faculty-adjunct', color: '#95a5a6', name: 'Adjunct' },
            'TBD': { class: 'faculty-tbd', color: '#bdc3c7', name: 'TBD' }
        };

        const AY_SETUP_STORAGE_KEY = 'programCommandAySetup';

        function buildFacultyAliasMap() {
            const aliasMap = {};
            for (const [alias, info] of Object.entries(facultyColors)) {
                const canonical = info?.name || alias;
                aliasMap[alias] = canonical;
                aliasMap[canonical] = canonical;
            }
            aliasMap.Online = 'Barton/Pettigrew';
            return aliasMap;
        }

        const facultyAliasMap = buildFacultyAliasMap();

        function getCanonicalFacultyName(name) {
            const raw = typeof name === 'string' ? name.trim() : '';
            if (!raw) return 'TBD';

            const directMatch = facultyAliasMap[raw];
            if (directMatch) return directMatch;

            const lower = raw.toLowerCase();
            if (lower.includes('adjunct')) return 'Adjunct';
            if (lower.includes('online') || lower.includes('barton') || lower.includes('pettigrew')) return 'Barton/Pettigrew';
            if (lower.includes('tbd')) return 'TBD';

            // Alias fallback that ignores punctuation/spacing.
            const compactRaw = lower.replace(/[^a-z0-9]/g, '');
            for (const [alias, canonical] of Object.entries(facultyAliasMap)) {
                const compactAlias = alias.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (compactRaw === compactAlias) return canonical;
            }

            return raw;
        }

        function getFacultyClass(instructor) {
            const canonical = getCanonicalFacultyName(instructor);
            return facultyColors[canonical]?.class || facultyColors[instructor]?.class || 'faculty-tbd';
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function readAySetupDataForYear(year) {
            try {
                const raw = localStorage.getItem(AY_SETUP_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                return parsed?.[year] || null;
            } catch (error) {
                console.warn('Could not parse academic year setup data:', error);
                return null;
            }
        }

        function getFacultySetupRecord(name, year = currentAcademicYear) {
            const yearData = readAySetupDataForYear(year);
            const faculty = Array.isArray(yearData?.faculty) ? yearData.faculty : [];
            const canonicalTarget = getCanonicalFacultyName(name);
            return faculty.find((entry) => getCanonicalFacultyName(entry.name) === canonicalTarget) || null;
        }

        function getFacultyLegendEntries() {
            const summaries = new Map();
            const quarters = ['fall', 'winter', 'spring'];

            quarters.forEach((quarter) => {
                const quarterCourses = flattenQuarterData(scheduleData[quarter] || {});
                quarterCourses.forEach((course) => {
                    const canonical = getCanonicalFacultyName(course.instructor || 'TBD');
                    const facultyInfo = facultyColors[canonical] || {
                        color: '#6b7280',
                        name: canonical
                    };

                    if (!summaries.has(canonical)) {
                        summaries.set(canonical, {
                            lookupName: canonical,
                            displayName: facultyInfo.name || canonical,
                            color: facultyInfo.color || '#6b7280',
                            sections: 0,
                            credits: 0
                        });
                    }

                    const summary = summaries.get(canonical);
                    summary.sections += 1;
                    summary.credits += Number(course.credits) || 5;
                });
            });

            return Array.from(summaries.values()).sort((a, b) => {
                if (b.sections !== a.sections) return b.sections - a.sections;
                return a.displayName.localeCompare(b.displayName);
            });
        }

        function renderFacultyLegend() {
            const legendEl = document.getElementById('facultyLegend');
            if (!legendEl) return;

            const entries = getFacultyLegendEntries();
            const totalSections = entries.reduce((sum, entry) => sum + entry.sections, 0);

            if (!entries.length) {
                legendEl.innerHTML = `
                    <div class="faculty-legend-header">
                        <strong>Faculty Key</strong>
                        <span>${escapeHtml(currentAcademicYear)}</span>
                    </div>
                    <div class="faculty-legend-empty">No sections assigned for this academic year yet.</div>
                `;
                return;
            }

            const chips = entries.map((entry) => `
                <button class="faculty-legend-item" type="button" data-faculty="${escapeHtml(entry.lookupName)}" onclick="showFacultyModal(this.dataset.faculty)">
                    <span class="faculty-color-bar" style="background:${escapeHtml(entry.color)};"></span>
                    <span class="faculty-legend-name">${escapeHtml(entry.displayName)}</span>
                    <span class="faculty-legend-meta">${entry.sections} sec | ${entry.credits} cr</span>
                </button>
            `).join('');

            legendEl.innerHTML = `
                <div class="faculty-legend-header">
                    <strong>Faculty Key</strong>
                    <span>${entries.length} faculty | ${totalSections} sections | ${escapeHtml(currentAcademicYear)}</span>
                </div>
                <div class="faculty-legend-list">${chips}</div>
            `;
        }

        // Navigation accordion toggle
        function toggleNavAccordion() {
            const toggle = document.querySelector('.nav-accordion-toggle');
            const content = document.getElementById('navAccordionContent');
            toggle.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Filters panel toggle
        function toggleFiltersPanel() {
            const panel = document.getElementById('filtersPanel');
            panel.classList.toggle('collapsed');
        }

        function toggleHeaderSettingsMenu(event) {
            if (event) event.stopPropagation();

            const container = document.getElementById('headerActions');
            const button = document.getElementById('headerSettingsButton');
            if (!container || !button) return;

            const willOpen = !container.classList.contains('open');
            container.classList.toggle('open', willOpen);
            button.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
        }

        function closeHeaderSettingsMenu() {
            const container = document.getElementById('headerActions');
            const button = document.getElementById('headerSettingsButton');
            if (!container || !button) return;

            container.classList.remove('open');
            button.setAttribute('aria-expanded', 'false');
        }

        function runHeaderSettingsAction(action) {
            closeHeaderSettingsMenu();

            if (action === 'save') {
                saveScheduleChanges();
                return;
            }
            if (action === 'conflicts') {
                runConflictDetection();
                return;
            }
            if (action === 'ai') {
                evaluateScheduleWithAI();
                return;
            }
            if (action === 'print') {
                openPrintDialog();
                return;
            }
            if (action === 'sheets') {
                exportToGoogleSheets();
                return;
            }
            if (action === 'rules') {
                openConstraintsModal();
                return;
            }
            if (action === 'api') {
                openApiSettingsModal();
                return;
            }
            if (action === 'accounts') {
                showToast('Users & accounts is the next build step: add Supabase Auth + role-based permissions.', 'success');
            }
        }

        document.addEventListener('click', function(e) {
            const headerActions = document.getElementById('headerActions');
            if (headerActions && !headerActions.contains(e.target)) {
                closeHeaderSettingsMenu();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHeaderSettingsMenu();
            }
        });

        // Quarter tab selection
        function selectQuarterTab(quarter) {
            // Update tab visual state
            document.querySelectorAll('.quarter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.quarter === quarter) {
                    tab.classList.add('active');
                }
            });

            // Update hidden select for compatibility
            const quarterSelect = document.getElementById('quarterSelect');
            if (quarterSelect) {
                quarterSelect.value = quarter;
                // Trigger change event for existing handlers
                quarterSelect.dispatchEvent(new Event('change'));
            }
        }

        // Initialize UI state on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Sync quarter tabs with hidden select value
            const quarterSelect = document.getElementById('quarterSelect');
            if (quarterSelect) {
                const activeQuarter = quarterSelect.value;
                document.querySelectorAll('.quarter-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.quarter === activeQuarter) {
                        tab.classList.add('active');
                    }
                });
            }
        });

        // Faculty modal functions
        function showFacultyModal(facultyName) {
            const overlay = document.getElementById('facultyModalOverlay');
            const nameEl = document.getElementById('facultyModalName');
            const scheduleEl = document.getElementById('facultyModalSchedule');
            const statsEl = document.getElementById('facultyModalStats');
            const prefsEl = document.getElementById('facultyModalPreferences');

            // Set faculty name with color
            const canonicalName = getCanonicalFacultyName(facultyName);
            const facultyInfo = facultyColors[canonicalName] || facultyColors[facultyName] || { color: '#6b7280', name: canonicalName };
            nameEl.textContent = facultyInfo.name || canonicalName;
            nameEl.style.color = facultyInfo.color;

            // Get current schedule from scheduleData
            const facultyCourses = [];
            if (typeof scheduleData !== 'undefined') {
                const quarters = ['fall', 'winter', 'spring'];
                quarters.forEach(quarter => {
                    const quarterCourses = flattenQuarterData(scheduleData[quarter] || {});
                    quarterCourses.forEach(course => {
                        if (getCanonicalFacultyName(course.instructor) === canonicalName) {
                            facultyCourses.push({
                                ...course,
                                quarter: quarter.charAt(0).toUpperCase() + quarter.slice(1)
                            });
                        }
                    });
                });
            }

            // Populate schedule
            if (facultyCourses.length > 0) {
                scheduleEl.innerHTML = facultyCourses.map(course => `
                    <div class="faculty-course-item">
                        <span class="course-code">${course.code}</span>
                        <span class="course-title">${course.title || course.name || ''}</span>
                        <span class="course-details">${course.quarter} | ${course.day || course.days || ''} ${course.time || ''}</span>
                    </div>
                `).join('');
            } else {
                scheduleEl.innerHTML = '<p style="color: #6b7280; font-style: italic;">No scheduled courses found</p>';
            }

            // Calculate workload stats
            const totalCredits = facultyCourses.reduce((sum, c) => sum + (parseInt(c.credits) || 5), 0);
            const sectionCount = facultyCourses.length;
            const setupRecord = getFacultySetupRecord(canonicalName, currentAcademicYear);
            statsEl.innerHTML = `
                <div class="stat-item"><span class="stat-label">Total Sections:</span> <span class="stat-value">${sectionCount}</span></div>
                <div class="stat-item"><span class="stat-label">Total Credits:</span> <span class="stat-value">${totalCredits}</span></div>
                <div class="stat-item"><span class="stat-label">Role:</span> <span class="stat-value">${escapeHtml(setupRecord?.role || 'Not set')}</span></div>
            `;

            if (setupRecord) {
                prefsEl.innerHTML = `
                    <div class="faculty-tags">
                        <span class="pref-tag">FTE: ${escapeHtml(setupRecord.ftePercent || '100')}%</span>
                        <span class="pref-tag">Annual Target: ${escapeHtml(setupRecord.annualTargetCredits || '45')} cr</span>
                        <span class="pref-tag">Release: ${escapeHtml(setupRecord.releaseCredits || '0')} cr${setupRecord.releasePercent !== undefined && setupRecord.releasePercent !== null ? ` (${escapeHtml(setupRecord.releasePercent)}%)` : ''}</span>
                        ${setupRecord.releaseReason ? `<span class="pref-tag">${escapeHtml(setupRecord.releaseReason)}</span>` : ''}
                    </div>
                    <a href="pages/academic-year-setup.html" class="pref-link">Edit Academic Year Inputs →</a>
                `;
            } else {
                prefsEl.innerHTML = `
                    <div class="faculty-tags">
                        <span class="pref-tag">No AY setup record found for ${escapeHtml(currentAcademicYear)}</span>
                    </div>
                    <a href="pages/academic-year-setup.html" class="pref-link">Add Faculty Inputs →</a>
                `;
            }

            overlay.classList.add('visible');
        }

        function closeFacultyModal(event) {
            if (event && event.target !== document.getElementById('facultyModalOverlay')) return;
            document.getElementById('facultyModalOverlay').classList.remove('visible');
        }

        // Minor data structure
        const minors = {
            ux: {
                name: 'UX/Interaction Design Minor',
                courses: ['DESN 338', 'DESN 348', 'DESN 458', 'DESN 366'],
                tracks: ['ux', 'interaction-design', 'web-development'],
                color: '#e74c3c',
                typical: true
            },
            animation: {
                name: 'Animation Minor',
                courses: ['DESN 326', 'DESN 355', 'DESN 365', 'DESN 336'],
                tracks: ['animation', 'motion'],
                color: '#f39c12',
                typical: false, // UX/Interaction/Web Dev typically don't pursue this
                note: 'UX, Interaction Design, and Web Dev students typically don\'t pursue this minor'
            },
            gameDesign: {
                name: 'Game Design Minor',
                courses: ['DESN 335', 'DESN 345', 'DESN 369', 'DESN 379'],
                tracks: ['animation', 'game-design'],
                color: '#27ae60',
                typical: true,
                note: 'Animation and Game Design students may pursue this minor'
            },
            graphicDesign: {
                name: 'Graphic Design Minor',
                courses: ['DESN 243', 'DESN 263', 'DESN 360', 'DESN 463'],
                tracks: ['all'],
                color: '#3498db',
                typical: true,
                note: 'Can be picked up along the way by any track'
            },
            photography: {
                name: 'Photography Minor',
                courses: ['DESN 350', 'DESN 301'],
                tracks: ['photography', 'visual-storytelling'],
                color: '#9b59b6',
                typical: true,
                note: 'PHOTO 350 only offered in Spring',
                seasonal: { 'DESN 350': 'spring' }
            },
            webDevelopment: {
                name: 'Web Development Minor',
                courses: ['DESN 368', 'DESN 369', 'DESN 379', 'DESN 468'],
                tracks: ['web-development', 'code-design'],
                color: '#667eea',
                typical: true
            }
        };

        // Student track definitions
        const studentTracks = {
            'ux': { name: 'UX Design', suggestedMinors: ['ux', 'graphicDesign', 'webDevelopment'] },
            'interaction-design': { name: 'Interaction Design', suggestedMinors: ['ux', 'graphicDesign', 'webDevelopment'] },
            'web-development': { name: 'Web Development', suggestedMinors: ['webDevelopment', 'graphicDesign', 'ux'] },
            'animation': { name: 'Animation', suggestedMinors: ['animation', 'gameDesign', 'graphicDesign'] },
            'game-design': { name: 'Game Design', suggestedMinors: ['gameDesign', 'animation', 'graphicDesign'] },
            'motion': { name: 'Motion Design', suggestedMinors: ['animation', 'graphicDesign'] },
            'photography': { name: 'Photography', suggestedMinors: ['photography', 'graphicDesign'] },
            'visual-storytelling': { name: 'Visual Storytelling', suggestedMinors: ['photography', 'graphicDesign'] },
            'code-design': { name: 'Code + Design', suggestedMinors: ['webDevelopment', 'gameDesign', 'graphicDesign'] }
        };

        // Load dynamic enrollment data from JSON file
        let enrollmentData = {};
        let enrollmentDataByCode = {};
        const NEW_COURSE_CODES = new Set(
            ['DESN 345', 'DESN 369', 'DESN 379'].map((code) => normalizeCourseCode(code))
        );

        function rebuildEnrollmentLookup() {
            enrollmentDataByCode = {};
            Object.entries(enrollmentData || {}).forEach(([code, stats]) => {
                enrollmentDataByCode[normalizeCourseCode(code)] = stats;
            });
        }

        async function loadEnrollmentData() {
            try {
                const response = await fetch('./enrollment-dashboard-data.json');
                if (response.ok) {
                    const data = await response.json();
                    enrollmentData = {
                        ...fallbackEnrollmentData,
                        ...(data.courseStats || {})
                    };
                    rebuildEnrollmentLookup();
                    console.log('✅ Loaded dynamic enrollment data');
                    console.log(`   Total courses: ${Object.keys(enrollmentData).length}`);
                    return true;
                }
            } catch (error) {
                console.warn('⚠️ Could not load enrollment-dashboard-data.json, using fallback data');
            }
            // Fallback to hardcoded data if JSON fails
            enrollmentData = fallbackEnrollmentData;
            rebuildEnrollmentLookup();
            return false;
        }

        // Fallback enrollment data (used if JSON file is not available)
        const fallbackEnrollmentData = {
            "DESN 100": {
                average: 35,
                peak: 48,
                trend: "declining",
                peakQuarter: "fall-2022",
                quarterly: {
                    "winter-2023": 38,
                    "winter-2024": 24,
                    "winter-2025": 22
                }
            },
            "DESN 200": { average: 26, peak: 44, trend: "growing", peakQuarter: "fall-2024" },
            "DESN 216": {
                average: 52,
                peak: 73,
                trend: "declining",
                peakQuarter: "fall-2022",
                quarterly: {
                    "winter-2023": { total: 38, online: 19, inPerson: 19 },
                    "winter-2024": { total: 25, online: 13, inPerson: 12 },
                    "winter-2025": { total: 22, online: 11, inPerson: 11 }
                }
            },
            "DESN 243": { average: 17, peak: 25, trend: "stable", peakQuarter: "spring-2023" },
            "DESN 263": { average: 18, peak: 25, trend: "stable", peakQuarter: "spring-2023" },
            "DESN 301": { average: 21, peak: 25, trend: "growing", peakQuarter: "fall-2024" },
            "DESN 305": { average: 22, peak: 23, trend: "stable", peakQuarter: "spring-2024" },
            "DESN 326": { average: 25, peak: 25, trend: "stable", peakQuarter: "fall-2023" },
            "DESN 335": { average: 24, peak: 24, trend: "stable", peakQuarter: "winter-2025" },
            "DESN 336": { average: 18, peak: 21, trend: "growing", peakQuarter: "spring-2025" },
            "DESN 338": { average: 20, peak: 30, trend: "declining", peakQuarter: "fall-2022" },
            "DESN 345": { average: 0, peak: 0, trend: "new", peakQuarter: "never-offered", isNew: true, note: "New course - Digital Game Design (Spring 2026)" },
            "DESN 348": { average: 16, peak: 20, trend: "stable", peakQuarter: "winter-2024" },
            "DESN 350": { average: 10, peak: 10, trend: "stable", peakQuarter: "spring" },
            "DESN 355": { average: 19, peak: 22, trend: "stable", peakQuarter: "winter-2024" },
            "DESN 359": { average: 19, peak: 24, trend: "growing", peakQuarter: "winter-2024" },
            "DESN 360": { average: 17, peak: 19, trend: "stable", peakQuarter: "winter-2025" },
            "DESN 365": { average: 15, peak: 16, trend: "stable", peakQuarter: "spring-2024" },
            "DESN 366": { average: 12, peak: 18, trend: "declining", peakQuarter: "spring-2023" },
            "DESN 368": { average: 18, peak: 20, trend: "stable", peakQuarter: "fall" },
            "DESN 369": { average: 0, peak: 0, trend: "new", peakQuarter: "never-offered", isNew: true, note: "New course - Web Dev 1 (Winter 2026)" },
            "DESN 374": { average: 22, peak: 25, trend: "stable", peakQuarter: "fall" },
            "DESN 378": { average: 15, peak: 16, trend: "stable", peakQuarter: "winter" },
            "DESN 379": { average: 0, peak: 0, trend: "new", peakQuarter: "never-offered", isNew: true, note: "New course - Web Dev 2 (Spring 2026)" },
            "DESN 384": { average: 19, peak: 24, trend: "stable", peakQuarter: "winter-2023" },
            "DESN 401": { average: 16, peak: 21, trend: "growing", peakQuarter: "winter-2025" },
            "DESN 458": { average: 12, peak: 15, trend: "stable", peakQuarter: "spring-2024" },
            "DESN 463": { average: 16, peak: 24, trend: "growing", peakQuarter: "spring-2025" },
            "DESN 468": { average: 12, peak: 13, trend: "stable", peakQuarter: "spring-2024" },
            "DESN 480": { average: 15, peak: 20, trend: "stable", peakQuarter: "winter-2023" },
            "DESN 490": { average: 15, peak: 25, trend: "growing", peakQuarter: "spring-2025" }
        };

        function getEnrollmentLevel(average) {
            if (average >= 30) return 'high';
            if (average >= 15) return 'medium';
            return 'low';
        }

        function getEnrollmentData(courseCode) {
            const normalizedCode = normalizeCourseCode(courseCode);
            return enrollmentDataByCode[normalizedCode]
                || enrollmentData[courseCode]
                || { average: 0, peak: 0, trend: "unknown", peakQuarter: "" };
        }

        const scheduleData = {
            fall: {
                'MW': {
                    '10:00-12:20': [
                        { code: 'DESN 368', name: 'Code + Design 1', room: '206', instructor: 'T.Masingale', credits: 5 },
                        { code: 'DESN 243', name: 'Typography', room: '209', instructor: 'S.Durr', credits: 5 },
                        { code: 'DESN 490', name: 'Capstone', room: '210', instructor: 'C.Manikoth', credits: 5 },
                        { code: 'DESN 100', name: 'Drawing Com.', room: 'CEB 104', instructor: 'A.Sopu', credits: 5 }
                    ],
                    '13:00-15:20': [
                        { code: 'DESN 338', name: 'UX 1', room: '206', instructor: 'M.Lybbert', credits: 5 },
                        { code: 'DESN 463', name: 'Community Dr.', room: '209', instructor: 'S.Durr', credits: 5 },
                        { code: 'DESN 301', name: 'Visual Storyte.', room: '210', instructor: 'S.Mills', credits: 5 },
                        { code: 'DESN 216', name: 'Digital Fdns.', room: 'CEB 102', instructor: 'A.Sopu', credits: 5 },
                        { code: 'DESN 100', name: 'Drawing Com.', room: 'CEB 104', instructor: 'S.Allison', credits: 5 }
                    ],
                    '16:00-18:20': [
                        { code: 'DESN 366', name: 'Production Des.', room: '206', instructor: 'M.Lybbert', credits: 5 }
                    ]
                },
                'TR': {
                    '10:00-12:20': [
                        { code: 'DESN 374', name: 'AI + Design', room: '209', instructor: 'T.Masingale', credits: 5 },
                        { code: 'DESN 200', name: 'Visual Thinking', room: '210', instructor: 'C.Manikoth', credits: 5 },
                        { code: 'DESN 359', name: 'Histories of Des.', room: 'CEB 102', instructor: 'S.Durr', credits: 5 },
                        { code: 'ITGS 110', name: 'FYE: Humanities', room: 'CEB 104', instructor: 'S.Mills', credits: 5 }
                    ],
                    '13:00-15:20': [
                        { code: 'DESN 480', name: 'Pro. Practice', room: '206', instructor: 'C.Manikoth', credits: 5 },
                        { code: 'DESN 326', name: 'Intro to Anim.', room: '209', instructor: 'G.Hustrulid', credits: 5 },
                        { code: 'DESN 263', name: 'VCD 1', room: '210', instructor: 'A.Sopu', credits: 5 },
                        { code: 'DESN 200', name: 'Visual Thinking', room: 'CEB 104', instructor: 'S.Mills', credits: 5 }
                    ]
                },
                'ONLINE': {
                    'async': [
                        { code: 'DESN 216', name: 'Digital Fdns.', room: 'ONLINE', instructor: 'Barton/Pettigrew', credits: 5 }
                    ]
                }
            },
            winter: {
                'MW': {
                    '10:00-12:20': [
                        { code: 'DESN 335', name: 'Board Game', room: '206', instructor: 'M.Lybbert', credits: 5 },
                        { code: 'DESN 243', name: 'Typography', room: '209', instructor: 'S.Durr', credits: 5 },
                        { code: 'DESN 216', name: 'Digital Fdns.', room: 'CEB 102', instructor: 'A.Sopu', credits: 5 }
                    ],
                    '13:00-15:20': [
                        { code: 'DESN 348', name: 'UX 2', room: '206', instructor: 'M.Lybbert', credits: 5 },
                        { code: 'DESN 360', name: 'Zine Pubic.', room: '209', instructor: 'S.Mills', credits: 5 },
                        { code: 'DESN 480', name: 'Pro. Practice', room: '210', instructor: 'C.Manikoth', credits: 5 },
                        { code: 'DESN 100', name: 'Drawing Com.', room: 'CEB 104', instructor: 'A.Sopu', credits: 5 }
                    ],
                    '16:00-18:20': [
                        { code: 'DESN 338', name: 'UX 1', room: '206', instructor: 'M.Lybbert', credits: 5 },
                        { code: 'DESN 378', name: 'Code + Design 2', room: '209', instructor: 'T. Masingale', credits: 5 }
                    ]
                },
                'TR': {
                    '10:00-12:20': [
                        { code: 'DESN 369', name: 'Web Dev. 1', room: '206', instructor: 'C.Manikoth', credits: 5 },
                        { code: 'DESN 490', name: 'Capstone', room: '209', instructor: 'TBD', credits: 5 },
                        { code: 'DESN 359', name: 'Histories of Des.', room: '210', instructor: 'S.Durr', credits: 5 },
                        { code: 'DESN 200', name: 'Visual Thinking', room: 'CEB 102', instructor: 'S.Mills', credits: 5 }
                    ],
                    '13:00-15:20': [
                        { code: 'DESN 374', name: 'AI + Design', room: '206', instructor: 'T. Masingale', credits: 5 },
                        { code: 'DESN 355', name: 'Motion Design', room: '209', instructor: 'G.Hustrulid', credits: 5 },
                        { code: 'DESN 263', name: 'VCD 1', room: '210', instructor: 'A.Sopu', credits: 5 },
                        { code: 'DESN 100', name: 'Drawing Com.', room: 'CEB 104', instructor: 'S.Allison', credits: 5 }
                    ],
                    '16:00-18:20': [
                        { code: 'DESN 336', name: '3D Animation', room: '209', instructor: 'Adjunct', credits: 5 }
                    ]
                },
                'ONLINE': {
                    'async': [
                        { code: 'DESN 216', name: 'Digital Fdns.', room: 'ONLINE', instructor: 'Barton/Pettigrew', credits: 5 }
                    ]
                },
                'ARRANGED': {
                    'arranged': [
                        { code: 'DESN 396', name: 'Japan Study Ab.', room: 'ARRANGED', instructor: 'M.Lybbert', credits: 5 }
                    ]
                }
            },
            spring: {
                'MW': {
                    '10:00-12:20': [
                        { code: 'DESN 305', name: 'Social Media', room: '206', instructor: 'E.Norris', credits: 5 },
                        { code: 'DESN 374', name: 'AI + Design', room: '209', instructor: 'T. Masingale', credits: 5 },
                        { code: 'DESN 490', name: 'Capstone', room: '210', instructor: 'TBD', credits: 5 },
                        { code: 'DESN 359', name: 'Histories of Des.', room: 'CEB 102', instructor: 'S.Durr', credits: 5 }
                    ],
                    '13:00-15:20': [
                        { code: 'DESN 338', name: 'UX 1', room: '206', instructor: 'M.Lybbert', credits: 5 },
                        { code: 'DESN 345', name: 'Digital Game', room: '209', instructor: 'Manikoth', credits: 5 },
                        { code: 'DESN 263', name: 'VCD 1', room: '210', instructor: 'A.Sopu', credits: 5 },
                        { code: 'DESN 200', name: 'Visual Thinking', room: 'CEB 102', instructor: 'S.Mills', credits: 5 }
                    ],
                    '16:00-18:20': [
                        { code: 'DESN 458', name: 'UX 3', room: '206', instructor: 'M.Lybbert', credits: 5 },
                        { code: 'DESN 350', name: 'Digital Photo', room: '209', instructor: 'Adjunct', credits: 5 }
                    ]
                },
                'TR': {
                    '10:00-12:20': [
                        { code: 'DESN 379', name: 'Web Dev. 2', room: '206', instructor: 'C.Manikoth', credits: 5 },
                        { code: 'DESN 401', name: 'Imaginary Ws.', room: '209', instructor: 'S.Mills', credits: 5 },
                        { code: 'DESN 463', name: 'Community Dr.', room: '210', instructor: 'S.Durr', credits: 5 },
                        { code: 'DESN 216', name: 'Digital Fdns.', room: 'CEB 102', instructor: 'A.Sopu', credits: 5 }
                    ],
                    '13:00-15:20': [
                        { code: 'DESN 468', name: 'Code + Design 3', room: '206', instructor: 'T. Masingale', credits: 5 },
                        { code: 'DESN 365', name: 'Motion Des. 2', room: '209', instructor: 'G.Hustrulid', credits: 5 },
                        { code: 'DESN 243', name: 'Typography', room: '210', instructor: 'S.Durr', credits: 5 },
                        { code: 'DESN 384', name: 'Digital Sound', room: 'CEB 102', instructor: 'J.Braukmann', credits: 5 },
                        { code: 'DESN 100', name: 'Drawing Com.', room: 'CEB 104', instructor: 'A.Sopu', credits: 5 }
                    ]
                },
                'ONLINE': {
                    'async': [
                        { code: 'DESN 216', name: 'Digital Fdns.', room: 'ONLINE', instructor: 'Barton/Pettigrew', credits: 5 }
                    ]
                }
            }
        };

        let conflictData = {
            fall: [],
            winter: [],
            spring: []
        };
        let annualConflictInsights = [];

        const recommendations = {
            spring: [
                {
                    priority: 'high',
                    title: 'Move DESN 463 to Monday/Wednesday 1-3 PM',
                    description: 'Relocating Community Design eliminates the critical three-way conflict and S. Durr has no conflicts at this time.'
                }
            ],
            fall: [
                {
                    priority: 'medium',
                    title: 'Monitor Capstone Distribution Across Quarters',
                    description: 'DESN 490 can be completed across Fall, Winter, or Spring. Keep section placement balanced so seniors can sequence code-track courses without bottlenecks.'
                }
            ],
            winter: [
                {
                    priority: 'critical',
                    title: 'URGENT: Resolve DESN 348/480 Senior Graduation Conflict',
                    description: 'DESN 348 (UX 2 - UX minor requirement) conflicts with DESN 480 (Professional Practice - required to graduate). Seniors cannot complete UX minor and graduate on time. Recommendation: Move DESN 480 to TR 13:00-15:00 or offer additional DESN 348 section at different time (MW 16:00-18:00 or TR time slot).'
                },
                {
                    priority: 'high',
                    title: 'Optimize DESN 100 Winter Sections',
                    description: 'DESN 100 winter enrollment has declined from 38 (2023) to 22 (2025) students. Currently offering 2 sections, but only 1 section is needed. Consider consolidating to a single section.'
                },
                {
                    priority: 'high',
                    title: 'Review DESN 216 Winter Capacity',
                    description: 'DESN 216 winter shows declining enrollment (38→25→22 students, split 50/50 between online and in-person). The in-person section now has only ~11 students. Consider consolidating to online-only or offering in-person every other year.'
                }
            ]
        };

        /**
         * Check for imported schedule data from schedule builder
         */
        function checkForImportedSchedule() {
            // Check URL params for import flag
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.get('import')) return;

            const importedData = localStorage.getItem('importedScheduleData');
            if (!importedData) {
                console.log('No imported schedule data found');
                return;
            }

            try {
                const parsed = JSON.parse(importedData);
                if (parsed.source !== 'schedule-builder') return;

                console.log('Importing schedule from schedule builder:', parsed);

                // Merge imported schedule data into scheduleData
                ['fall', 'winter', 'spring'].forEach(quarter => {
                    if (parsed.scheduleData[quarter]) {
                        // Replace schedule data for this quarter
                        scheduleData[quarter] = parsed.scheduleData[quarter];
                    }
                });

                // Show import notification
                showImportNotification(parsed.academicYear, parsed.generatedAt);

                // Clear the import flag from URL without reloading
                window.history.replaceState({}, document.title, window.location.pathname);

                // Clear localStorage after import
                localStorage.removeItem('importedScheduleData');

            } catch (error) {
                console.error('Error importing schedule:', error);
            }
        }

        /**
         * Show notification about imported schedule
         */
        function showImportNotification(year, generatedAt) {
            const notification = document.createElement('div');
            notification.className = 'import-notification';
            notification.innerHTML = `
                <div class="import-notification-content">
                    <span class="import-icon">✓</span>
                    <span>Schedule imported for ${year} (generated ${new Date(generatedAt).toLocaleString()})</span>
                    <button onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => notification.remove(), 5000);
        }

        function renderSchedule(quarter) {
            const grid = document.getElementById('scheduleGrid');
            const data = scheduleData[quarter];

            // Clear grid safely
            while (grid.firstChild) {
                grid.removeChild(grid.firstChild);
            }

            // Header row - create elements safely
            const headers = ['Time', '206 UX Lab', '207 Media Lab', '209 Mac Lab', '210 Mac Lab', '212 Project Lab', 'CEB 102', 'CEB 104'];
            headers.forEach(text => {
                const header = document.createElement('div');
                header.className = 'grid-header';
                header.textContent = text;
                grid.appendChild(header);
            });

            const times = ['10:00-12:20', '13:00-15:20', '16:00-18:20'];
            const days = ['MW', 'TR'];
            const rooms = ['206', '207', '209', '210', '212', 'CEB 102', 'CEB 104'];

            days.forEach((day, dayIndex) => {
                // Add divider for each day section
                const divider = document.createElement('div');
                divider.className = 'day-divider ' + (dayIndex === 0 ? 'mw' : 'tr');
                grid.appendChild(divider);

                times.forEach(time => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.textContent = day;
                    timeSlot.appendChild(document.createElement('br'));
                    timeSlot.appendChild(document.createTextNode(time));
                    grid.appendChild(timeSlot);

                    rooms.forEach(room => {
                        const courses = data[day] && data[day][time] ?
                            data[day][time].filter(c => c.room === room) : [];

                        const cell = document.createElement('div');
                        cell.className = 'schedule-cell drop-zone';
                        cell.dataset.day = day;
                        cell.dataset.time = time;
                        cell.dataset.room = room;

                        courses.forEach(course => {
                            const conflictLevel = courses.length > 2 ? 0 : courses.length > 1 ? 1 : 2;
                            const facultyClass = getFacultyClass(course.instructor);
                            const enrollment = getEnrollmentData(course.code);

                            // Get quarter-specific enrollment from previous year instead of overall average
                            const prevYearQuarter = quarter === 'fall' ? 'fall-2025' :
                                                   quarter === 'winter' ? 'winter-2025' :
                                                   quarter === 'spring' ? 'spring-2025' : null;

                            let displayEnrollment = enrollment.average; // fallback
                            let tooltipText = 'Avg enrollment: ' + enrollment.average;
                            let showYearIndicator = false;
                            const hasPriorQuarterSample = Boolean(
                                prevYearQuarter
                                && enrollment.quarterly
                                && enrollment.quarterly[prevYearQuarter] !== undefined
                            );
                            const treatAsNewCourse = Boolean(
                                NEW_COURSE_CODES.has(normalizeCourseCode(course.code))
                                ||
                                enrollment.isNew
                                || enrollment.trend === 'new'
                                || (!hasPriorQuarterSample
                                    && Number(enrollment.average) === 0
                                    && Number(enrollment.peak) === 0)
                            );

                            if (hasPriorQuarterSample) {
                                const prevYearData = enrollment.quarterly[prevYearQuarter];
                                displayEnrollment = typeof prevYearData === 'object' ? prevYearData.total : prevYearData;
                                tooltipText = quarter.charAt(0).toUpperCase() + quarter.slice(1) + ' 2025: ' + displayEnrollment + ' students';
                                showYearIndicator = true;
                            } else if (treatAsNewCourse) {
                                displayEnrollment = 'NEW';
                                tooltipText = 'New course - no historical data';
                            }

                            const enrollmentLevel = typeof displayEnrollment === 'number' ? getEnrollmentLevel(displayEnrollment) : 'medium';
                            const trendClass = 'trend-' + enrollment.trend;

                            // Generate a course ID for editing
                            const courseId = '2025-26-' + quarter + '-' + course.code.replace(/\s+/g, '').toLowerCase() + '-001';

                            const block = document.createElement('div');
                            block.className = 'course-block conflict-' + conflictLevel + ' ' + facultyClass + ' ' + trendClass;
                            block.dataset.courseId = courseId;
                            block.dataset.quarter = quarter;
                            block.dataset.courseCode = course.code;
                            block.dataset.day = day;
                            block.dataset.time = time;
                            block.dataset.room = room;
                            block.draggable = true;
                            block.title = tooltipText + ' | Peak: ' + enrollment.peak + ' | Trend: ' + enrollment.trend + ' | Drag to move';
                            block.onclick = function(e) {
                                // Don't trigger click if we're dragging
                                if (!block.classList.contains('dragging')) {
                                    showCourseDetails(course.code, course.name, course.instructor, course.credits, course.room, courseId, quarter, day, time);
                                }
                            };

                            if (courses.length > 1) {
                                const badge = document.createElement('span');
                                badge.className = 'conflict-badge';
                                badge.textContent = courses.length;
                                block.appendChild(badge);
                            }

                            // Add delete button
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'delete-btn';
                            deleteBtn.innerHTML = '&times;';
                            deleteBtn.title = 'Click to delete, Shift+Click to move to tray';
                            deleteBtn.onclick = function(e) {
                                e.stopPropagation();
                                deleteCourse(course.code, day, time, course.room, e.shiftKey);
                            };
                            block.appendChild(deleteBtn);

                            const nameDiv = document.createElement('div');
                            nameDiv.className = 'course-name';
                            nameDiv.textContent = course.code + ' ';
                            const enrollBadge = document.createElement('span');
                            enrollBadge.className = 'enrollment-badge';
                            enrollBadge.textContent = '(' + displayEnrollment + (showYearIndicator ? "'" : '') + ')';
                            nameDiv.appendChild(enrollBadge);

                            const titleDiv = document.createElement('div');
                            titleDiv.className = 'course-details';
                            titleDiv.textContent = course.name;

                            const instructorDiv = document.createElement('div');
                            instructorDiv.className = 'course-details';
                            instructorDiv.textContent = course.instructor;

                            block.appendChild(nameDiv);
                            block.appendChild(titleDiv);
                            block.appendChild(instructorDiv);
                            cell.appendChild(block);
                        });

                        grid.appendChild(cell);
                    });
                });
            });

            // Setup drag-and-drop after grid is rendered
            setupDragAndDrop();
            renderFacultyLegend();
        }

        // ============================================
        // DRAG AND DROP FUNCTIONALITY
        // ============================================

        let draggedCourse = null;

        function setupDragAndDrop() {
            // Setup draggable course blocks
            document.querySelectorAll('.course-block[draggable="true"]').forEach(block => {
                block.addEventListener('dragstart', handleDragStart);
                block.addEventListener('dragend', handleDragEnd);
            });

            // Setup drop zones (schedule cells)
            document.querySelectorAll('.schedule-cell.drop-zone').forEach(cell => {
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('dragleave', handleDragLeave);
                cell.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedCourse = {
                element: this,
                courseId: this.dataset.courseId,
                courseCode: this.dataset.courseCode,
                quarter: this.dataset.quarter,
                originalDay: this.dataset.day,
                originalTime: this.dataset.time,
                originalRoom: this.dataset.room
            };

            this.classList.add('dragging');

            // Set transfer data
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                courseId: draggedCourse.courseId,
                courseCode: draggedCourse.courseCode,
                quarter: draggedCourse.quarter
            }));

            // Show drop indicator
            const indicator = document.getElementById('dropIndicator');
            document.getElementById('dropIndicatorText').textContent =
                'Dragging ' + draggedCourse.courseCode + ' - Drop on any time slot to move';
            indicator.classList.add('active');

            // Highlight all drop zones
            document.querySelectorAll('.schedule-cell.drop-zone').forEach(cell => {
                cell.style.opacity = '1';
            });
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedCourse = null;

            // Hide drop indicator
            document.getElementById('dropIndicator').classList.remove('active');

            // Remove all drag-over classes
            document.querySelectorAll('.schedule-cell').forEach(cell => {
                cell.classList.remove('drag-over');
                cell.style.opacity = '';
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            if (!this.classList.contains('drag-over')) {
                // Remove highlight from other cells
                document.querySelectorAll('.schedule-cell.drag-over').forEach(cell => {
                    cell.classList.remove('drag-over');
                });
                this.classList.add('drag-over');

                // Update indicator with target info
                const day = this.dataset.day;
                const time = this.dataset.time;
                const room = this.dataset.room;
                document.getElementById('dropIndicatorText').textContent =
                    'Drop to move to ' + day + ' ' + time + ' in Room ' + room;
            }
        }

        function handleDragLeave(e) {
            // Only remove if we're actually leaving this cell
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (!draggedCourse) return;

            const targetDay = this.dataset.day;
            const targetTime = this.dataset.time;
            const targetRoom = this.dataset.room;
            const quarter = document.getElementById('quarterSelect').value;
            const data = scheduleData[quarter];

            // Check if dropping from displaced tray
            if (draggedCourse.isFromDisplacedTray) {
                // Check if target cell has existing courses with same room
                if (data[targetDay] && data[targetDay][targetTime]) {
                    const existingInRoom = data[targetDay][targetTime].filter(c => c.room === targetRoom);
                    // Move existing courses to displaced tray
                    existingInRoom.forEach(existing => {
                        addToDisplacedTray({
                            code: existing.code,
                            name: existing.name,
                            instructor: existing.instructor,
                            credits: existing.credits,
                            originalDay: targetDay,
                            originalTime: targetTime,
                            originalRoom: targetRoom
                        });
                        const idx = data[targetDay][targetTime].findIndex(c => c.code === existing.code && c.room === existing.room);
                        if (idx > -1) data[targetDay][targetTime].splice(idx, 1);
                    });
                }

                // Add course from displaced tray to schedule
                if (!data[targetDay]) data[targetDay] = {};
                if (!data[targetDay][targetTime]) data[targetDay][targetTime] = [];
                data[targetDay][targetTime].push({
                    code: draggedCourse.courseCode,
                    name: draggedCourse.courseName,
                    instructor: draggedCourse.instructor || 'TBD',
                    credits: draggedCourse.credits || 5,
                    room: targetRoom
                });

                // Remove from displaced tray
                removeFromDisplacedTray(draggedCourse.displacedIndex);

                saveScheduleData(); // Persist changes
                renderSchedule(quarter);
                renderConflicts(quarter);
                updateStats(quarter);
                showToast('Placed ' + draggedCourse.courseCode + ' at ' + targetDay + ' ' + targetTime);
                return;
            }

            // Don't do anything if dropped in the same cell (for regular drag)
            if (targetDay === draggedCourse.originalDay &&
                targetTime === draggedCourse.originalTime &&
                targetRoom === draggedCourse.originalRoom) {
                showToast('Course already in this slot');
                return;
            }

            // Move the course (handles displacement)
            moveCourse(draggedCourse, targetDay, targetTime, targetRoom);
        }

        function moveCourse(course, newDay, newTime, newRoom) {
            const quarter = document.getElementById('quarterSelect').value;

            // Update local schedule data
            const data = scheduleData[quarter];

            // Find and remove from original location
            if (data[course.originalDay] && data[course.originalDay][course.originalTime]) {
                const originalCourses = data[course.originalDay][course.originalTime];
                const courseIndex = originalCourses.findIndex(c => c.code === course.courseCode);

                if (courseIndex > -1) {
                    const movedCourse = originalCourses.splice(courseIndex, 1)[0];

                    // Update course with new location
                    movedCourse.room = newRoom;

                    // Check for existing courses in target room and displace them
                    if (!data[newDay]) data[newDay] = {};
                    if (!data[newDay][newTime]) data[newDay][newTime] = [];

                    const existingInRoom = data[newDay][newTime].filter(c => c.room === newRoom);
                    const hasExisting = existingInRoom.length > 0;
                    let swappedCourse = null;

                    if (hasExisting) {
                        if (swapMode) {
                            // SWAP MODE: Move existing course to the original location
                            existingInRoom.forEach(existing => {
                                swappedCourse = { ...existing }; // Copy for toast message

                                // First, remove from target location (before changing room)
                                const idx = data[newDay][newTime].findIndex(c => c.code === existing.code && c.room === newRoom);
                                if (idx > -1) {
                                    const removedCourse = data[newDay][newTime].splice(idx, 1)[0];
                                    // Update the removed course's room to original room
                                    removedCourse.room = course.originalRoom;
                                    // Add to original location
                                    if (!data[course.originalDay]) data[course.originalDay] = {};
                                    if (!data[course.originalDay][course.originalTime]) data[course.originalDay][course.originalTime] = [];
                                    data[course.originalDay][course.originalTime].push(removedCourse);
                                }
                            });
                        } else {
                            // DISPLACE MODE: Move existing course to displaced tray
                            existingInRoom.forEach(existing => {
                                addToDisplacedTray({
                                    code: existing.code,
                                    name: existing.name,
                                    instructor: existing.instructor,
                                    credits: existing.credits,
                                    originalDay: newDay,
                                    originalTime: newTime,
                                    originalRoom: newRoom
                                });
                                // Remove from schedule
                                const idx = data[newDay][newTime].findIndex(c => c.code === existing.code && c.room === existing.room);
                                if (idx > -1) data[newDay][newTime].splice(idx, 1);
                            });
                        }
                    }

                    // Add to new location
                    data[newDay][newTime].push(movedCourse);

                    // Also update ScheduleManager if available
                    if (typeof ScheduleManager !== 'undefined') {
                        const updates = {
                            room: newRoom,
                            days: newDay === 'MW' ? ['M', 'W'] : ['T', 'Th'],
                            startTime: convertTimeSlotToStart(newTime),
                            endTime: convertTimeSlotToEnd(newTime)
                        };

                        ScheduleManager.updateCourseAssignment('2025-26', quarter, course.courseId, updates);
                    }

                    // Save and re-render the schedule
                    saveScheduleData(); // Persist changes
                    renderSchedule(quarter);
                    renderConflicts(quarter);
                    renderConflictSolver(quarter);
                    updateStats(quarter);

                    let toastMsg = 'Moved ' + course.courseCode + ' to ' + newDay + ' ' + newTime + ' Room ' + newRoom;
                    if (hasExisting) {
                        if (swapMode && swappedCourse) {
                            toastMsg += ' (swapped with ' + swappedCourse.code + ')';
                        } else {
                            toastMsg += ' (' + existingInRoom.length + ' course' + (existingInRoom.length > 1 ? 's' : '') + ' displaced)';
                        }
                    }
                    showToast(toastMsg);
                } else {
                    showToast('Could not find course to move', 'error');
                }
            } else {
                showToast('Could not find original course location', 'error');
            }
        }

        function convertTimeSlotToStart(timeSlot) {
            const start = timeSlot.split('-')[0];
            return start + ':00';
        }

        function convertTimeSlotToEnd(timeSlot) {
            const end = timeSlot.split('-')[1];
            return end + ':00';
        }

        function renderOnlineCourses(quarter) {
            const onlineSection = document.getElementById('onlineSection');
            const data = scheduleData[quarter];

            // Clear section safely
            while (onlineSection.firstChild) {
                onlineSection.removeChild(onlineSection.firstChild);
            }

            if (!data || !data['ONLINE']) {
                return;
            }

            const onlineCourses = data['ONLINE']['async'] || [];

            if (onlineCourses.length === 0) {
                return;
            }

            const section = document.createElement('div');
            section.className = 'online-section';

            const heading = document.createElement('h4');
            heading.textContent = 'Online / Asynchronous';
            section.appendChild(heading);

            const coursesList = document.createElement('div');
            coursesList.className = 'online-courses-list';

            onlineCourses.forEach((course, index) => {
                const item = document.createElement('div');
                item.className = 'online-course-item';
                
                const courseInfo = document.createElement('span');
                courseInfo.innerHTML = `<strong>${course.code}</strong> <span style="color:#57606a">${course.name}</span> <span style="color:#8b949e">- ${course.instructor}</span>`;
                courseInfo.style.cursor = 'pointer';
                courseInfo.onclick = () => {
                    showCourseDetails(course.code, course.name, course.instructor, course.credits, 'ONLINE', null, quarter, 'ONLINE', 'async');
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = 'Delete this online course';
                deleteBtn.style.cssText = 'background: none; border: none; color: #cf222e; font-size: 1.2em; cursor: pointer; padding: 0 4px; margin-left: 8px; line-height: 1;';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete ${course.code} - ${course.name}?`)) {
                        deleteOnlineCourse(quarter, index);
                    }
                };
                
                item.appendChild(courseInfo);
                item.appendChild(deleteBtn);
                coursesList.appendChild(item);
            });

            section.appendChild(coursesList);
            onlineSection.appendChild(section);
        }

        function deleteOnlineCourse(quarter, index) {
            const data = scheduleData[quarter];
            if (data && data['ONLINE'] && data['ONLINE']['async']) {
                data['ONLINE']['async'].splice(index, 1);
                saveScheduleData();
                renderOnlineCourses(quarter);
                updateStats(quarter);
                showToast('Online course deleted');
            }
        }

        function renderArrangedCourses(quarter) {
            const arrangedSection = document.getElementById('arrangedSection');
            const data = scheduleData[quarter];

            // Clear section safely
            while (arrangedSection.firstChild) {
                arrangedSection.removeChild(arrangedSection.firstChild);
            }

            if (!data['ARRANGED']) {
                return;
            }

            const arrangedCourses = data['ARRANGED']['arranged'] || [];

            if (arrangedCourses.length === 0) {
                return;
            }

            const section = document.createElement('div');
            section.className = 'arranged-section';

            const heading = document.createElement('h3');
            heading.textContent = '✈️ Arranged Courses (Study Abroad & Independent Study)';
            section.appendChild(heading);

            const coursesContainer = document.createElement('div');
            coursesContainer.className = 'arranged-courses';

            arrangedCourses.forEach(course => {
                const facultyClass = getFacultyClass(course.instructor);
                const block = document.createElement('div');
                block.className = 'arranged-course-block ' + facultyClass;

                const nameDiv = document.createElement('div');
                nameDiv.className = 'course-name';
                nameDiv.style.cssText = 'color: white; font-size: 1em; margin-bottom: 5px;';
                nameDiv.textContent = course.code;

                const titleDiv = document.createElement('div');
                titleDiv.className = 'course-details';
                titleDiv.style.color = 'rgba(255,255,255,0.9)';
                titleDiv.textContent = course.name;

                const instructorDiv = document.createElement('div');
                instructorDiv.className = 'course-details';
                instructorDiv.style.color = 'rgba(255,255,255,0.9)';
                instructorDiv.textContent = course.instructor;

                const creditsDiv = document.createElement('div');
                creditsDiv.className = 'course-details';
                creditsDiv.style.cssText = 'color: rgba(255,255,255,0.9); margin-top: 5px;';
                creditsDiv.textContent = course.credits + ' credits';

                block.appendChild(nameDiv);
                block.appendChild(titleDiv);
                block.appendChild(instructorDiv);
                block.appendChild(creditsDiv);
                coursesContainer.appendChild(block);
            });

            section.appendChild(coursesContainer);
            arrangedSection.appendChild(section);
        }

        // Helper: Create quarter data cell content
        function createQuarterCell(data, isNew) {
            const cell = document.createElement('td');
            if (isNew) {
                const span = document.createElement('span');
                span.style.cssText = 'color: #9b59b6; font-weight: 600;';
                span.textContent = 'NEW';
                cell.appendChild(span);
            } else if (!data) {
                cell.textContent = '-';
            } else if (typeof data === 'object' && data.total !== undefined) {
                const numSpan = document.createElement('span');
                numSpan.className = 'enrollment-number';
                numSpan.textContent = data.total;
                cell.appendChild(numSpan);
                cell.appendChild(document.createElement('br'));
                const splitSpan = document.createElement('span');
                splitSpan.className = 'enrollment-split';
                splitSpan.textContent = '(' + (data.online || '-') + ' online, ' + (data.inPerson || '-') + ' in-person)';
                cell.appendChild(splitSpan);
            } else {
                const numSpan = document.createElement('span');
                numSpan.className = 'enrollment-number';
                numSpan.textContent = data;
                cell.appendChild(numSpan);
            }
            return cell;
        }

        // Helper: Create enrollment category section
        function createEnrollmentCategory(title, subtitle, courses, type, formatFn) {
            const section = document.createElement('div');
            section.className = 'enrollment-category';

            const h3 = document.createElement('h3');
            h3.textContent = title;

            const p = document.createElement('p');
            p.style.cssText = 'color: #666; font-size: 0.9em; margin-bottom: 10px;';
            p.textContent = subtitle;

            const list = document.createElement('div');
            list.className = 'enrollment-course-list';

            courses.forEach(c => {
                const tag = document.createElement('div');
                tag.className = 'enrollment-course-tag ' + type;
                const strong = document.createElement('strong');
                strong.textContent = c.code;
                tag.appendChild(strong);
                tag.appendChild(document.createTextNode(' - ' + formatFn(c)));
                list.appendChild(tag);
            });

            section.appendChild(h3);
            section.appendChild(p);
            section.appendChild(list);
            return section;
        }

        function renderEnrollmentAnalytics(quarter) {
            const analyticsPanel = document.getElementById('enrollmentAnalytics');
            const data = scheduleData[quarter];

            // Clear safely
            while (analyticsPanel.firstChild) {
                analyticsPanel.removeChild(analyticsPanel.firstChild);
            }

            // Collect all courses from the quarter
            let allCourses = [];
            ['MW', 'TR'].forEach(day => {
                if (data[day]) {
                    ['10:00-12:20', '13:00-15:20', '16:00-18:20'].forEach(time => {
                        if (data[day][time]) {
                            allCourses = allCourses.concat(data[day][time]);
                        }
                    });
                }
            });

            if (data['ONLINE'] && data['ONLINE']['async']) {
                allCourses = allCourses.concat(data['ONLINE']['async']);
            }

            // Categorize courses
            const highEnrollment = [];
            const lowEnrollment = [];
            const decliningTrend = [];

            allCourses.forEach(course => {
                const enrollment = getEnrollmentData(course.code);
                if (enrollment.average >= 30) highEnrollment.push({ ...course, enrollment });
                if (enrollment.average < 15 && enrollment.average > 0) lowEnrollment.push({ ...course, enrollment });
                if (enrollment.trend === 'declining') decliningTrend.push({ ...course, enrollment });
            });

            const coursesWithHistory = allCourses
                .reduce((unique, course) => {
                    if (!unique.find(c => c.code === course.code)) unique.push(course);
                    return unique;
                }, [])
                .sort((a, b) => {
                    const aMatch = normalizeCourseCode(a.code).match(/\d{3}[A-Z]?/);
                    const bMatch = normalizeCourseCode(b.code).match(/\d{3}[A-Z]?/);
                    const aValue = parseInt(aMatch ? aMatch[0] : '0', 10);
                    const bValue = parseInt(bMatch ? bMatch[0] : '0', 10);
                    return aValue - bValue;
                });

            const quarterName = quarter.charAt(0).toUpperCase() + quarter.slice(1);
            const q2023Key = quarter + '-2023';
            const q2024Key = quarter + '-2024';
            const q2025Key = quarter + '-2025';

            // Main container
            const container = document.createElement('div');
            container.className = 'enrollment-analytics';

            const mainTitle = document.createElement('h2');
            mainTitle.textContent = '📊 Enrollment Analytics - ' + quarterName + ' 2026';
            container.appendChild(mainTitle);

            // Per-Class Enrollment History (collapsible)
            if (coursesWithHistory.length > 0) {
                const historySection = document.createElement('div');
                historySection.className = 'quarterly-enrollment';

                const accordionHeader = document.createElement('h3');
                accordionHeader.style.cssText = 'cursor: pointer; user-select: none; padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';

                const headerText = document.createElement('span');
                headerText.textContent = '📈 Per-Class Enrollment History ';
                const countSpan = document.createElement('span');
                countSpan.style.cssText = 'font-size: 0.8em; color: #666; font-weight: normal;';
                countSpan.textContent = '(' + coursesWithHistory.length + ' courses)';
                headerText.appendChild(countSpan);

                const arrow = document.createElement('span');
                arrow.className = 'accordion-arrow';
                arrow.style.fontSize = '0.8em';
                arrow.textContent = '▶';

                accordionHeader.appendChild(headerText);
                accordionHeader.appendChild(arrow);

                const contentDiv = document.createElement('div');
                contentDiv.style.display = 'none';

                accordionHeader.onclick = function() {
                    if (contentDiv.style.display === 'none') {
                        contentDiv.style.display = 'block';
                        arrow.textContent = '▼';
                    } else {
                        contentDiv.style.display = 'none';
                        arrow.textContent = '▶';
                    }
                };

                const historyDesc = document.createElement('p');
                historyDesc.style.cssText = 'color: #666; font-size: 0.9em; margin-bottom: 15px;';
                historyDesc.textContent = 'Historical enrollment data for ' + quarterName + ' quarter courses';

                const table = document.createElement('table');
                table.className = 'enrollment-history-table';

                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['Course', 'Course Name', 'Instructor', quarterName + ' 2023', quarterName + ' 2024', quarterName + ' 2025', 'Trend'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                const tbody = document.createElement('tbody');
                coursesWithHistory.forEach(c => {
                    const enrollment = getEnrollmentData(c.code);
                    const isNewCourse = Boolean(
                        enrollment.isNew
                        || enrollment.trend === 'new'
                        || NEW_COURSE_CODES.has(normalizeCourseCode(c.code))
                    );
                    const quarterly = enrollment.quarterly || {};
                    const row = document.createElement('tr');

                    // Course code cell
                    const codeCell = document.createElement('td');
                    const codeStrong = document.createElement('strong');
                    codeStrong.textContent = c.code;
                    codeCell.appendChild(codeStrong);
                    if (isNewCourse) {
                        const badge = document.createElement('span');
                        badge.className = 'course-note-badge';
                        badge.textContent = 'NEW';
                        codeCell.appendChild(badge);
                    }

                    const nameCell = document.createElement('td');
                    nameCell.textContent = c.name;

                    const instructorCell = document.createElement('td');
                    instructorCell.textContent = c.instructor;

                    const trendCell = document.createElement('td');
                    const trendValue = isNewCourse ? 'new' : enrollment.trend;
                    const trendIcon = trendValue === 'declining' ? '📉' : trendValue === 'growing' ? '📈' : trendValue === 'new' ? '✨' : '➡️';
                    trendCell.textContent = trendIcon + ' ' + trendValue;

                    row.appendChild(codeCell);
                    row.appendChild(nameCell);
                    row.appendChild(instructorCell);
                    row.appendChild(createQuarterCell(quarterly[q2023Key], isNewCourse));
                    row.appendChild(createQuarterCell(quarterly[q2024Key], isNewCourse));
                    row.appendChild(createQuarterCell(quarterly[q2025Key], isNewCourse));
                    row.appendChild(trendCell);
                    tbody.appendChild(row);
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                contentDiv.appendChild(historyDesc);
                contentDiv.appendChild(table);
                historySection.appendChild(accordionHeader);
                historySection.appendChild(contentDiv);
                container.appendChild(historySection);
            }

            // High Demand section
            if (highEnrollment.length > 0) {
                container.appendChild(createEnrollmentCategory(
                    '🔴 High Demand Courses (30+ students)',
                    'These courses may need larger rooms or additional sections',
                    highEnrollment,
                    'high',
                    c => 'Avg: ' + c.enrollment.average + ' | Peak: ' + c.enrollment.peak
                ));
            }

            // Low Enrollment section
            if (lowEnrollment.length > 0) {
                container.appendChild(createEnrollmentCategory(
                    '🟢 Low Enrollment Courses (<15 students)',
                    'Consider consolidation or review offering frequency',
                    lowEnrollment,
                    'low',
                    c => 'Avg: ' + c.enrollment.average + ' | Instructor: ' + c.instructor
                ));
            }

            // Declining Trend section
            if (decliningTrend.length > 0) {
                container.appendChild(createEnrollmentCategory(
                    '⚠️ Declining Enrollment Trends',
                    'Courses showing declining enrollment patterns',
                    decliningTrend,
                    'declining',
                    c => 'Avg: ' + c.enrollment.average + ' | Trend: ' + c.enrollment.trend + ' ↘'
                ));
            }

            analyticsPanel.appendChild(container);
        }

        const CONFLICT_QUARTERS = ['fall', 'winter', 'spring'];
        const CONFLICT_QUARTER_LABELS = {
            fall: 'Fall',
            winter: 'Winter',
            spring: 'Spring'
        };
        const CONFLICT_SEVERITY_RANK = {
            critical: 3,
            high: 2,
            medium: 1
        };

        function getConflictSeverityRank(severity) {
            return CONFLICT_SEVERITY_RANK[String(severity || '').toLowerCase()] || 0;
        }

        function extractConflictCourseCode(courseLabel) {
            const match = String(courseLabel || '').match(/[A-Z]{2,5}\s\d{3}[A-Z]?/);
            return match ? match[0] : null;
        }

        function getConflictPatternLabel(conflict) {
            const codes = (conflict.courses || [])
                .map(extractConflictCourseCode)
                .filter(Boolean);

            if (codes.length) {
                return [...new Set(codes)].sort().join(' + ');
            }

            return conflict.time || 'Unlabeled conflict pattern';
        }

        function normalizeCourseCode(courseCode) {
            const upper = String(courseCode || '')
                .toUpperCase()
                .replace(/\s+/g, ' ')
                .trim();

            return upper.replace(/^([A-Z]{2,5})\s*(\d)/, '$1 $2');
        }

        function normalizeScheduleCourseCodes(data) {
            const quarters = ['fall', 'winter', 'spring'];

            quarters.forEach((quarter) => {
                const quarterData = data?.[quarter];
                if (!quarterData || typeof quarterData !== 'object') return;

                Object.values(quarterData).forEach((timeBucket) => {
                    if (!timeBucket || typeof timeBucket !== 'object') return;

                    Object.values(timeBucket).forEach((courses) => {
                        if (!Array.isArray(courses)) return;
                        courses.forEach((course) => {
                            if (course && typeof course === 'object') {
                                course.code = normalizeCourseCode(course.code);
                            }
                        });
                    });
                });
            });

            return data;
        }

        function getCourseDisplayLabel(course) {
            const code = normalizeCourseCode(course.code);
            const title = String(course.name || course.title || '').trim();
            return title ? `${code} - ${title}` : code;
        }

        function isSchedulableDay(day) {
            return day === 'MW' || day === 'TR';
        }

        function getQuarterCourses(quarter) {
            return flattenQuarterData(scheduleData[quarter] || {}).map((course) => ({
                ...course,
                code: normalizeCourseCode(course.code),
                credits: Number(course.credits) || 5
            }));
        }

        function formatConflictSlot(day, time) {
            const dayLabel = day === 'MW'
                ? 'Monday & Wednesday'
                : day === 'TR'
                    ? 'Tuesday & Thursday'
                    : day;
            return `${dayLabel}, ${formatTime(time)}`;
        }

        function createConflictEntry({
            severity = 'medium',
            time = '',
            courses = [],
            impact = '',
            affected = 'Medium',
            source = 'computed',
            meta = {}
        }) {
            return {
                severity: String(severity || 'medium').toLowerCase(),
                time,
                courses,
                impact,
                affected,
                source,
                ...meta
            };
        }

        function dedupeConflicts(conflicts) {
            const seen = new Set();
            const deduped = [];

            conflicts.forEach((conflict) => {
                const key = [
                    conflict.source || '',
                    conflict.severity || '',
                    conflict.title || '',
                    conflict.time || '',
                    (conflict.courses || []).slice().sort().join('|'),
                    conflict.impact || '',
                    conflict.description || ''
                ].join('::');

                if (seen.has(key)) return;
                seen.add(key);
                deduped.push(conflict);
            });

            return deduped;
        }

        function sortConflicts(conflicts) {
            return [...conflicts].sort((a, b) => {
                const severityDelta = getConflictSeverityRank(b.severity) - getConflictSeverityRank(a.severity);
                if (severityDelta !== 0) return severityDelta;
                const timeA = a.time || '';
                const timeB = b.time || '';
                if (timeA !== timeB) return timeA.localeCompare(timeB);
                const detailA = a.impact || a.description || a.title || '';
                const detailB = b.impact || b.description || b.title || '';
                return detailA.localeCompare(detailB);
            });
        }

        function buildPairingConflicts(quarterCourses) {
            const conflicts = [];
            const slotMap = new Map();
            const commonPairings = (typeof ConflictEngine !== 'undefined' && Array.isArray(ConflictEngine.COMMON_PAIRINGS))
                ? ConflictEngine.COMMON_PAIRINGS
                : [];

            quarterCourses
                .filter((course) => isSchedulableDay(course.day) && course.time)
                .forEach((course) => {
                    const key = `${course.day}|${course.time}`;
                    if (!slotMap.has(key)) slotMap.set(key, []);
                    slotMap.get(key).push(course);
                });

            slotMap.forEach((slotCourses, slotKey) => {
                if (slotCourses.length < 2) return;

                const codesInSlot = new Set(slotCourses.map((course) => normalizeCourseCode(course.code)));
                const pairMatches = commonPairings.filter(([first, second]) =>
                    codesInSlot.has(normalizeCourseCode(first)) && codesInSlot.has(normalizeCourseCode(second))
                );

                if (!pairMatches.length) return;

                const matchedCodes = new Set(pairMatches.flat().map(normalizeCourseCode));
                const matchedCourses = slotCourses.filter((course) => matchedCodes.has(normalizeCourseCode(course.code)));

                const has400Level = Array.from(matchedCodes).some((code) => {
                    const match = code.match(/\b(\d{3})\b/);
                    return match ? Number(match[1]) >= 400 : false;
                });

                const [day, time] = slotKey.split('|');
                const pairText = pairMatches
                    .map(([first, second]) => `${normalizeCourseCode(first)} + ${normalizeCourseCode(second)}`)
                    .join('; ');

                conflicts.push(createConflictEntry({
                    severity: has400Level ? 'critical' : pairMatches.length > 1 ? 'high' : 'medium',
                    time: formatConflictSlot(day, time),
                    courses: matchedCourses.map(getCourseDisplayLabel),
                    impact: `Courses commonly taken together overlap in one slot: ${pairText}.`,
                    affected: pairMatches.length > 1 ? 'High' : 'Medium',
                    source: 'pathway-pairing',
                    meta: {
                        dayPattern: day,
                        timeSlot: time
                    }
                }));
            });

            return conflicts;
        }

        function buildFacultyDoubleBookConflicts(quarterCourses) {
            const conflicts = [];
            const byInstructorSlot = new Map();

            quarterCourses
                .filter((course) =>
                    isSchedulableDay(course.day)
                    && course.time
                    && course.instructor
                    && getCanonicalFacultyName(course.instructor) !== 'TBD'
                )
                .forEach((course) => {
                    const instructor = getCanonicalFacultyName(course.instructor);
                    const key = `${instructor}|${course.day}|${course.time}`;
                    if (!byInstructorSlot.has(key)) byInstructorSlot.set(key, []);
                    byInstructorSlot.get(key).push(course);
                });

            byInstructorSlot.forEach((slotCourses, key) => {
                if (slotCourses.length < 2) return;
                const rooms = new Set(slotCourses.map((course) => course.room));
                if (rooms.size < 2) return;

                const [instructor, day, time] = key.split('|');
                conflicts.push(createConflictEntry({
                    severity: 'critical',
                    time: formatConflictSlot(day, time),
                    courses: slotCourses.map(getCourseDisplayLabel),
                    impact: `${instructor} is double-booked in different rooms at the same time.`,
                    affected: 'High',
                    source: 'faculty-double-book',
                    meta: {
                        dayPattern: day,
                        timeSlot: time,
                        instructor
                    }
                }));
            });

            return conflicts;
        }

        function buildRoomDoubleBookConflicts(quarterCourses) {
            const conflicts = [];
            const byRoomSlot = new Map();

            quarterCourses
                .filter((course) =>
                    isSchedulableDay(course.day)
                    && course.time
                    && course.room
                    && course.room !== 'ONLINE'
                    && course.room !== 'ARRANGED'
                )
                .forEach((course) => {
                    const key = `${course.room}|${course.day}|${course.time}`;
                    if (!byRoomSlot.has(key)) byRoomSlot.set(key, []);
                    byRoomSlot.get(key).push(course);
                });

            byRoomSlot.forEach((slotCourses, key) => {
                if (slotCourses.length < 2) return;
                const [room, day, time] = key.split('|');
                conflicts.push(createConflictEntry({
                    severity: 'critical',
                    time: formatConflictSlot(day, time),
                    courses: slotCourses.map(getCourseDisplayLabel),
                    impact: `Room ${room} is double-booked for the same time slot.`,
                    affected: 'High',
                    source: 'room-double-book',
                    meta: {
                        dayPattern: day,
                        timeSlot: time,
                        room
                    }
                }));
            });

            return conflicts;
        }

        function buildAySetupConflicts(quarterCoursesMap) {
            const empty = {
                byQuarter: { fall: [], winter: [], spring: [] },
                annualIssues: []
            };

            if (typeof ConflictEngine === 'undefined' || typeof ConflictEngine.evaluateAySetup !== 'function') {
                return empty;
            }

            const analysis = ConflictEngine.evaluateAySetup(
                quarterCoursesMap,
                readAySetupDataForYear(currentAcademicYear),
                {
                    academicYear: currentAcademicYear,
                    canonicalizeFacultyName: getCanonicalFacultyName
                }
            );

            const mapIssueToConflictEntry = (issue, quarter) => {
                const displaySeverity = issue.severity === 'critical'
                    ? 'critical'
                    : issue.priority === 'high'
                        ? 'high'
                        : 'medium';
                const mappedCourses = (issue.courses || []).map((course) => {
                    if (typeof course === 'string') return course;
                    return getCourseDisplayLabel({
                        code: course.code,
                        name: course.title
                    });
                }).filter(Boolean);

                return createConflictEntry({
                    severity: displaySeverity,
                    time: issue.title || `${CONFLICT_QUARTER_LABELS[quarter]} AY setup`,
                    courses: mappedCourses,
                    impact: issue.description || 'Detected an AY setup mismatch.',
                    affected: issue.priority === 'high' || issue.severity === 'critical' ? 'High' : 'Medium',
                    source: 'ay-setup'
                });
            };

            const byQuarter = {
                fall: [],
                winter: [],
                spring: []
            };
            CONFLICT_QUARTERS.forEach((quarter) => {
                byQuarter[quarter] = (analysis.byQuarter?.[quarter] || []).map((issue) =>
                    mapIssueToConflictEntry(issue, quarter)
                );
            });

            const annualIssues = (analysis.annualIssues || []).map((issue) => ({
                severity: issue.severity === 'critical'
                    ? 'critical'
                    : issue.priority === 'high'
                        ? 'high'
                        : 'medium',
                title: issue.title || 'AY Setup Check',
                description: issue.description || 'Detected an AY setup mismatch.',
                source: 'ay-setup'
            }));

            return {
                byQuarter,
                annualIssues: sortConflicts(dedupeConflicts(annualIssues))
            };
        }

        function refreshConflictData() {
            const generated = {
                fall: [],
                winter: [],
                spring: []
            };
            const quarterCoursesMap = {};

            CONFLICT_QUARTERS.forEach((quarter) => {
                const quarterCourses = getQuarterCourses(quarter);
                quarterCoursesMap[quarter] = quarterCourses;

                generated[quarter].push(...buildPairingConflicts(quarterCourses));
                generated[quarter].push(...buildFacultyDoubleBookConflicts(quarterCourses));
                generated[quarter].push(...buildRoomDoubleBookConflicts(quarterCourses));
            });

            const ayChecks = buildAySetupConflicts(quarterCoursesMap);
            CONFLICT_QUARTERS.forEach((quarter) => {
                generated[quarter].push(...(ayChecks.byQuarter[quarter] || []));
                generated[quarter] = sortConflicts(dedupeConflicts(generated[quarter]));
            });

            conflictData = generated;
            annualConflictInsights = ayChecks.annualIssues || [];
        }

        function getAnnualConflictPatterns() {
            const patterns = new Map();

            CONFLICT_QUARTERS.forEach((quarter) => {
                const quarterConflicts = (conflictData[quarter] || []).filter((conflict) => conflict.source !== 'ay-setup');
                quarterConflicts.forEach((conflict) => {
                    const patternLabel = getConflictPatternLabel(conflict);
                    if (!patterns.has(patternLabel)) {
                        patterns.set(patternLabel, {
                            label: patternLabel,
                            quarters: new Set(),
                            count: 0,
                            severity: (conflict.severity || 'medium').toLowerCase(),
                            impact: conflict.impact || ''
                        });
                    }

                    const pattern = patterns.get(patternLabel);
                    pattern.quarters.add(quarter);
                    pattern.count += 1;

                    if (getConflictSeverityRank(conflict.severity) > getConflictSeverityRank(pattern.severity)) {
                        pattern.severity = (conflict.severity || 'medium').toLowerCase();
                    }
                });
            });

            return Array.from(patterns.values()).sort((a, b) => {
                if (b.count !== a.count) return b.count - a.count;
                const severityDelta = getConflictSeverityRank(b.severity) - getConflictSeverityRank(a.severity);
                if (severityDelta !== 0) return severityDelta;
                return a.label.localeCompare(b.label);
            });
        }

        function renderAnnualConflictSummary(activeQuarter) {
            const summaryEl = document.getElementById('annualConflictSummary');
            if (!summaryEl) return;

            const totalYearConflicts = CONFLICT_QUARTERS.reduce(
                (sum, quarterKey) => sum + ((conflictData[quarterKey] || []).length),
                0
            );
            const quarterConflicts = (conflictData[activeQuarter] || []).length;
            const patterns = getAnnualConflictPatterns();
            const recurringPatterns = patterns.filter((pattern) => pattern.quarters.size > 1).length;

            while (summaryEl.firstChild) {
                summaryEl.removeChild(summaryEl.firstChild);
            }

            const header = document.createElement('div');
            header.className = 'annual-conflict-header';

            const title = document.createElement('strong');
            title.textContent = 'Whole-Year Conflict Patterns';
            header.appendChild(title);

            const stats = document.createElement('div');
            stats.className = 'annual-conflict-stats';
            [
                `${totalYearConflicts} annual conflicts`,
                `${patterns.length} unique patterns`,
                `${recurringPatterns} recurring`,
                `${annualConflictInsights.length} AY setup issues`,
                `${quarterConflicts} in ${CONFLICT_QUARTER_LABELS[activeQuarter] || activeQuarter}`
            ].forEach((label) => {
                const chip = document.createElement('span');
                chip.className = 'annual-conflict-stat';
                chip.textContent = label;
                stats.appendChild(chip);
            });
            header.appendChild(stats);
            summaryEl.appendChild(header);

            if (patterns.length === 0 && annualConflictInsights.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'no-conflicts-quarter';
                empty.textContent = 'No major conflict patterns across the academic year.';
                summaryEl.appendChild(empty);
                return;
            }

            const patternList = document.createElement('div');
            patternList.className = 'annual-pattern-list';

            patterns.slice(0, 5).forEach((pattern) => {
                const item = document.createElement('div');
                item.className = `annual-pattern-item ${pattern.severity}`;

                const itemTitle = document.createElement('div');
                itemTitle.className = 'annual-pattern-title';
                itemTitle.textContent = pattern.label;

                const itemMeta = document.createElement('div');
                itemMeta.className = 'annual-pattern-meta';
                const quarterLabels = Array.from(pattern.quarters)
                    .map((quarterKey) => CONFLICT_QUARTER_LABELS[quarterKey] || quarterKey)
                    .sort()
                    .join(', ');
                itemMeta.textContent = `Quarters: ${quarterLabels} | Frequency: ${pattern.count}`;

                item.appendChild(itemTitle);
                item.appendChild(itemMeta);
                patternList.appendChild(item);
            });

            annualConflictInsights.forEach((issue) => {
                const item = document.createElement('div');
                item.className = `annual-pattern-item ${issue.severity || 'medium'}`;

                const itemTitle = document.createElement('div');
                itemTitle.className = 'annual-pattern-title';
                itemTitle.textContent = issue.title;

                const itemMeta = document.createElement('div');
                itemMeta.className = 'annual-pattern-meta';
                itemMeta.textContent = issue.description;

                item.appendChild(itemTitle);
                item.appendChild(itemMeta);
                patternList.appendChild(item);
            });

            summaryEl.appendChild(patternList);
        }

        function createConflictItem(conflict) {
            const item = document.createElement('div');
            item.className = 'conflict-item ' + conflict.severity;

            const header = document.createElement('div');
            header.className = 'conflict-header';

            const timeSpan = document.createElement('span');
            timeSpan.className = 'conflict-time';
            timeSpan.textContent = conflict.time;

            const severityBadge = document.createElement('span');
            severityBadge.className = 'severity-badge ' + conflict.severity;
            severityBadge.textContent = conflict.severity;

            header.appendChild(timeSpan);
            header.appendChild(severityBadge);

            const impactP = document.createElement('p');
            impactP.style.cssText = 'margin: 10px 0; color: #495057;';
            impactP.textContent = conflict.impact;

            const affectedP = document.createElement('p');
            affectedP.style.cssText = 'margin: 10px 0; color: #6c757d; font-size: 0.9em;';
            const affectedStrong = document.createElement('strong');
            affectedStrong.textContent = 'Students Affected:';
            affectedP.appendChild(affectedStrong);
            affectedP.appendChild(document.createTextNode(' ' + conflict.affected));

            const coursesDiv = document.createElement('div');
            coursesDiv.className = 'conflict-courses';
            (conflict.courses || []).forEach(course => {
                const tag = document.createElement('span');
                tag.className = 'conflict-course-tag';
                tag.textContent = course;
                coursesDiv.appendChild(tag);
            });

            item.appendChild(header);
            item.appendChild(impactP);
            item.appendChild(affectedP);
            item.appendChild(coursesDiv);
            return item;
        }

        function renderConflicts(quarter) {
            const conflictsList = document.getElementById('conflictsList');
            const activeQuarter = CONFLICT_QUARTERS.includes(quarter) ? quarter : 'spring';
            const quarterOrder = [activeQuarter, ...CONFLICT_QUARTERS.filter((key) => key !== activeQuarter)];

            refreshConflictData();
            renderAnnualConflictSummary(activeQuarter);

            while (conflictsList.firstChild) {
                conflictsList.removeChild(conflictsList.firstChild);
            }

            quarterOrder.forEach((quarterKey) => {
                const group = document.createElement('section');
                group.className = 'conflict-quarter-group';

                const title = document.createElement('h3');
                title.className = 'conflict-quarter-title';
                title.textContent = `${CONFLICT_QUARTER_LABELS[quarterKey]} Quarter`;

                if (quarterKey === activeQuarter) {
                    const currentTag = document.createElement('span');
                    currentTag.className = 'current-quarter-tag';
                    currentTag.textContent = 'Current View';
                    title.appendChild(currentTag);
                }

                group.appendChild(title);

                const conflicts = conflictData[quarterKey] || [];
                if (!conflicts.length) {
                    const noConflicts = document.createElement('p');
                    noConflicts.className = 'no-conflicts-quarter';
                    noConflicts.textContent = `No major conflicts detected in ${CONFLICT_QUARTER_LABELS[quarterKey]}.`;
                    group.appendChild(noConflicts);
                } else {
                    conflicts.forEach((conflict) => {
                        group.appendChild(createConflictItem(conflict));
                    });
                }

                conflictsList.appendChild(group);
            });
        }

        function renderConflictSolver(quarter) {
            const solverList = document.getElementById('conflictSolverList');
            const data = scheduleData[quarter] || {};
            const days = ['MW', 'TR'];
            const times = ['10:00-12:20', '13:00-15:20', '16:00-18:20'];
            const rooms = ['206', '209', '210', '212', 'CEB 102', 'CEB 104'];

            refreshConflictData();

            // Clear safely
            while (solverList.firstChild) {
                solverList.removeChild(solverList.firstChild);
            }

            // Build slot map for recommendation analysis
            const scheduleMatrix = {};
            days.forEach((day) => {
                times.forEach((time) => {
                    const key = `${day} ${time}`;
                    const courses = data[day]?.[time] || [];
                    scheduleMatrix[key] = courses.map((course) => ({ ...course, day, time }));
                });
            });

            const quarterCourses = flattenQuarterData(data).map((course) => ({
                ...course,
                code: normalizeCourseCode(course.code)
            }));

            const conflictsToSolve = (conflictData[quarter] || [])
                .filter((conflict) =>
                    conflict.source !== 'ay-setup'
                    && (conflict.severity === 'critical' || conflict.severity === 'high')
                    && conflict.dayPattern
                    && conflict.timeSlot
                )
                .map((conflict) => {
                    const slotKey = `${conflict.dayPattern} ${conflict.timeSlot}`;
                    const slotCourses = scheduleMatrix[slotKey] || [];
                    const firstCourseCode = extractConflictCourseCode((conflict.courses || [])[0]);

                    const moveCandidate = slotCourses.find((course) =>
                        normalizeCourseCode(course.code) === normalizeCourseCode(firstCourseCode)
                    ) || slotCourses[0] || quarterCourses.find((course) =>
                        normalizeCourseCode(course.code) === normalizeCourseCode(firstCourseCode)
                    ) || null;

                    if (!moveCandidate) return null;

                    const sourceLabelMap = {
                        'pathway-pairing': 'Pathway conflict',
                        'faculty-double-book': 'Faculty double-booking',
                        'room-double-book': 'Room double-booking'
                    };

                    return {
                        conflict,
                        dayPattern: conflict.dayPattern,
                        timeSlot: conflict.timeSlot,
                        slotKey,
                        slotCourses,
                        moveCandidate,
                        sourceLabel: sourceLabelMap[conflict.source] || 'Schedule conflict'
                    };
                })
                .filter(Boolean);

            if (conflictsToSolve.length === 0) {
                const noConflicts = document.createElement('p');
                noConflicts.style.cssText = 'color: #51cf66; font-weight: 600;';
                noConflicts.textContent = '✓ No urgent conflicts requiring automated resolution for this quarter.';
                solverList.appendChild(noConflicts);
                return;
            }

            conflictsToSolve.forEach((entry) => {
                const movingInstructor = getCanonicalFacultyName(entry.moveCandidate.instructor || 'TBD');
                const solutions = [];

                days.forEach((day) => {
                    times.forEach((time) => {
                        if (day === entry.dayPattern && time === entry.timeSlot) return;

                        const slotKey = `${day} ${time}`;
                        const existingCourses = scheduleMatrix[slotKey] || [];
                        const usedRooms = new Set(existingCourses.map((course) => course.room).filter(Boolean));
                        const availableRooms = rooms.filter((room) => !usedRooms.has(room));
                        const instructorConflict = movingInstructor !== 'TBD' && existingCourses.some((course) =>
                            getCanonicalFacultyName(course.instructor || 'TBD') === movingInstructor
                        );

                        let status = 'viable';
                        let recommendation = '✅ RECOMMENDED';
                        if (instructorConflict) {
                            status = 'blocked';
                            recommendation = '❌ Instructor conflict';
                        } else if (availableRooms.length === 0) {
                            status = 'blocked';
                            recommendation = '❌ No rooms available';
                        } else if (existingCourses.length >= 4) {
                            status = 'warning';
                            recommendation = '⚠️ Dense slot, review impact';
                        } else if (existingCourses.length <= 2) {
                            recommendation = '✅ BEST OPTION';
                        }

                        solutions.push({
                            slotKey,
                            slotLabel: `${day} ${time}`,
                            existingCourses,
                            roomsAvailable: availableRooms.length,
                            status,
                            recommendation,
                            instructorConflict
                        });
                    });
                });

                const statusRank = { viable: 3, warning: 2, blocked: 1 };
                solutions.sort((a, b) => {
                    const rankDelta = (statusRank[b.status] || 0) - (statusRank[a.status] || 0);
                    if (rankDelta !== 0) return rankDelta;
                    return b.roomsAvailable - a.roomsAvailable;
                });

                const card = document.createElement('div');
                card.className = 'conflict-solution-card';

                const title = document.createElement('h3');
                title.textContent = `${entry.sourceLabel}: ${formatConflictSlot(entry.dayPattern, entry.timeSlot)}`;

                const infoP = document.createElement('p');
                infoP.style.cssText = 'color: #666; margin-bottom: 15px;';
                infoP.innerHTML = `
                    <strong>Issue:</strong> ${escapeHtml(entry.conflict.impact || 'Conflict detected')}<br>
                    <strong>Students Affected:</strong> ${escapeHtml(entry.conflict.affected || 'Medium')}<br>
                    <strong>Current Slot:</strong> ${escapeHtml(entry.slotKey)}
                `;

                const analysisH4 = document.createElement('h4');
                analysisH4.style.cssText = 'margin-top: 15px; margin-bottom: 10px; color: #495057;';
                analysisH4.textContent = 'Automated Solutions Analysis:';

                const matrixP = document.createElement('p');
                matrixP.style.cssText = 'font-size: 0.9em; color: #666; margin-bottom: 15px;';
                matrixP.innerHTML = `Matrix analysis for moving <strong>${escapeHtml(getCourseDisplayLabel(entry.moveCandidate))}</strong> (${escapeHtml(entry.moveCandidate.instructor || 'TBD')}):`;

                card.appendChild(title);
                card.appendChild(infoP);
                card.appendChild(analysisH4);
                card.appendChild(matrixP);

                solutions.slice(0, 6).forEach((solution) => {
                    const option = document.createElement('div');
                    option.className = 'solution-option' + (solution.status === 'blocked' ? ' creates-conflict' : solution.status === 'warning' ? ' warning' : '');

                    const recDiv = document.createElement('div');
                    recDiv.className = 'solution-recommendation';
                    recDiv.textContent = `${solution.recommendation} Move to ${solution.slotLabel}`;

                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'solution-details';
                    const existingText = solution.existingCourses.length > 0
                        ? solution.existingCourses.map((course) => `${normalizeCourseCode(course.code)} (${course.room || 'TBD'})`).join(', ')
                        : 'EMPTY SLOT';
                    detailsDiv.innerHTML = `
                        <strong>Currently scheduled:</strong> ${escapeHtml(existingText)}<br>
                        <strong>Rooms available:</strong> ${solution.roomsAvailable} of ${rooms.length}
                    `;

                    if (solution.instructorConflict) {
                        const warnSpan = document.createElement('span');
                        warnSpan.style.color = '#ff6b6b';
                        warnSpan.textContent = ' ⚠️ Instructor already teaching at this time';
                        detailsDiv.appendChild(warnSpan);
                    } else if (solution.status === 'viable' && solution.roomsAvailable >= 4) {
                        const okSpan = document.createElement('span');
                        okSpan.style.color = '#51cf66';
                        okSpan.textContent = ' ✓ Minimal impact, ample room capacity';
                        detailsDiv.appendChild(okSpan);
                    }

                    option.appendChild(recDiv);
                    option.appendChild(detailsDiv);
                    card.appendChild(option);
                });

                solverList.appendChild(card);
            });
        }

        function renderRecommendations(quarter) {
            const recList = document.getElementById('recommendationsList');
            refreshConflictData();
            const quarterConflicts = conflictData[quarter] || [];
            const dynamicRecs = [];

            quarterConflicts.forEach((conflict) => {
                if (conflict.source === 'ay-setup') {
                    dynamicRecs.push({
                        priority: conflict.severity === 'critical' ? 'critical' : 'high',
                        title: `Align AY Setup: ${conflict.time}`,
                        description: `${conflict.impact} Update AY setup targets or rebalance assignments to match planned workload.`
                    });
                    return;
                }

                const sourceAction = conflict.source === 'room-double-book'
                    ? 'Adjust room assignments to remove overlap.'
                    : conflict.source === 'faculty-double-book'
                        ? 'Reassign instructor or move one section to an open slot.'
                        : 'Move one of the overlapping pathway courses to an alternate slot.';

                dynamicRecs.push({
                    priority: conflict.severity === 'critical' ? 'critical' : conflict.severity === 'high' ? 'high' : 'medium',
                    title: `Resolve ${conflict.time}`,
                    description: `${conflict.impact} ${sourceAction}`
                });
            });

            annualConflictInsights.forEach((issue) => {
                dynamicRecs.push({
                    priority: issue.severity === 'critical' ? 'critical' : issue.severity === 'high' ? 'high' : 'medium',
                    title: issue.title,
                    description: `${issue.description} Address this in Academic Year Setup to keep yearly assignments aligned.`
                });
            });

            const seen = new Set();
            const recs = dynamicRecs.filter((rec) => {
                const key = `${rec.title}::${rec.description}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });

            // Clear safely
            while (recList.firstChild) {
                recList.removeChild(recList.firstChild);
            }

            if (recs.length === 0) {
                const noRecs = document.createElement('p');
                noRecs.textContent = 'No specific recommendations for this quarter.';
                recList.appendChild(noRecs);
                return;
            }

            recs.forEach(rec => {
                const item = document.createElement('div');
                let className = 'recommendation-item';
                if (rec.priority === 'critical') className += ' priority-critical';
                else if (rec.priority === 'high') className += ' priority-high';
                item.className = className;

                const title = document.createElement('h3');
                title.textContent = rec.title;

                const desc = document.createElement('p');
                desc.textContent = rec.description;

                item.appendChild(title);
                item.appendChild(desc);
                recList.appendChild(item);
            });
        }

        const UTILIZATION_ROOMS = ['206', '209', '210', '212', 'CEB 102', 'CEB 104'];
        const UTILIZATION_DAYS = ['MW', 'TR'];
        const UTILIZATION_TIMES = ['10:00-12:20', '13:00-15:20', '16:00-18:20'];
        const CHENEY_ONLY_COURSES = new Set(['DESN 100', 'DESN 200', 'DESN 216']);
        const ROOM_212_ONLY_COURSES = new Set(['DESN 301', 'DESN 359', 'DESN 401']);
        const ROOM_212_OVERFLOW_COURSES = new Set(['DESN 100', 'DESN 200']);

        function getQuarterSchedulableCourses(data) {
            return flattenQuarterData(data || {})
                .filter((course) =>
                    isSchedulableDay(course.day)
                    && UTILIZATION_TIMES.includes(course.time)
                    && UTILIZATION_ROOMS.includes(String(course.room || '').trim())
                )
                .map((course) => ({
                    ...course,
                    code: normalizeCourseCode(course.code),
                    credits: Number(course.credits) || 5
                }));
        }

        function isRoomPlacementCompatible(course) {
            const code = normalizeCourseCode(course.code);
            const room = String(course.room || '').trim();
            const time = String(course.time || '').trim();
            const isEvening = time.startsWith('16:');

            if (!UTILIZATION_ROOMS.includes(room)) return false;

            if (code.startsWith('ITGS')) {
                return (room === 'CEB 102' || room === 'CEB 104') && !isEvening;
            }

            if (ROOM_212_ONLY_COURSES.has(code)) {
                return room === '212';
            }

            if (room === '212') {
                return ROOM_212_ONLY_COURSES.has(code) || ROOM_212_OVERFLOW_COURSES.has(code);
            }

            if (CHENEY_ONLY_COURSES.has(code)) {
                return room === 'CEB 102' || room === 'CEB 104' || room === '212';
            }

            return true;
        }

        function buildCapacityUtilizationSnapshot(quarter, data) {
            const aySetup = readAySetupDataForYear(currentAcademicYear) || {};
            const facultyRecords = Array.isArray(aySetup.faculty) ? aySetup.faculty : [];
            const adjunctTarget = Number(aySetup?.adjunctTargets?.[quarter]) || 0;

            const capacityByFaculty = new Map();
            const adjunctFacultyNames = new Set();
            let fullTimeCapacityCredits = 0;
            let adjunctRosterCapacityCredits = 0;

            facultyRecords.forEach((record) => {
                const canonicalName = getCanonicalFacultyName(record.name || '');
                if (!canonicalName || canonicalName === 'TBD') return;

                const annualTarget = Number(record.annualTargetCredits) || 0;
                const releaseCredits = Number(record.releaseCredits) || 0;
                const ftePercent = Number(record.ftePercent);
                const fteFactor = Number.isFinite(ftePercent) && ftePercent > 0 ? Math.min(1, ftePercent / 100) : 1;
                const quarterlyCapacity = Math.max(0, (annualTarget - releaseCredits) / 3) * fteFactor;
                const roleText = String(record.role || '').toLowerCase();
                const isAdjunct = canonicalName === 'Adjunct' || roleText.includes('adjunct');

                capacityByFaculty.set(canonicalName, {
                    quarterlyCapacity,
                    isAdjunct
                });

                if (isAdjunct) {
                    adjunctFacultyNames.add(canonicalName);
                    adjunctRosterCapacityCredits += quarterlyCapacity;
                } else {
                    fullTimeCapacityCredits += quarterlyCapacity;
                }
            });

            const allQuarterCourses = flattenQuarterData(data || {}).map((course) => ({
                ...course,
                instructor: getCanonicalFacultyName(course.instructor || 'TBD'),
                credits: Number(course.credits) || 5
            }));

            let totalAssignedTeachingCredits = 0;
            let assignedAdjunctCredits = 0;
            let implicitUnknownFacultyCapacity = 0;

            allQuarterCourses.forEach((course) => {
                if (!course.instructor || course.instructor === 'TBD') return;
                totalAssignedTeachingCredits += course.credits;

                const knownFaculty = capacityByFaculty.get(course.instructor);
                if (course.instructor === 'Adjunct' || knownFaculty?.isAdjunct || adjunctFacultyNames.has(course.instructor)) {
                    assignedAdjunctCredits += course.credits;
                    return;
                }

                if (!knownFaculty) {
                    // Neutral treatment for instructors missing from AY setup to reduce hidden bias.
                    implicitUnknownFacultyCapacity += course.credits;
                }
            });

            const schedulableCourses = getQuarterSchedulableCourses(data);
            const compatiblePlacements = schedulableCourses.filter(isRoomPlacementCompatible).length;
            const roomFitRate = schedulableCourses.length > 0 ? compatiblePlacements / schedulableCourses.length : 1;

            const usedRoomSlots = new Set(
                schedulableCourses.map((course) => `${course.day}|${course.time}|${course.room}`)
            ).size;
            const totalRoomSlots = UTILIZATION_ROOMS.length * UTILIZATION_DAYS.length * UTILIZATION_TIMES.length;
            const roomUtilizationRate = totalRoomSlots > 0 ? usedRoomSlots / totalRoomSlots : 0;

            const adjunctCapacityCredits = Math.max(adjunctTarget, adjunctRosterCapacityCredits, assignedAdjunctCredits);
            const totalFacultyCapacityCredits =
                fullTimeCapacityCredits + adjunctCapacityCredits + implicitUnknownFacultyCapacity;
            const facultyUtilizationRate = totalFacultyCapacityCredits > 0
                ? totalAssignedTeachingCredits / totalFacultyCapacityCredits
                : 0;

            const compositeRate =
                (Math.min(1.2, facultyUtilizationRate) * 0.55)
                + (roomUtilizationRate * 0.30)
                + (roomFitRate * 0.15);

            return {
                utilizationPercent: Math.max(0, Math.round(compositeRate * 100)),
                facultyUtilizationRate,
                roomUtilizationRate,
                roomFitRate,
                totalAssignedTeachingCredits,
                totalFacultyCapacityCredits,
                assignedAdjunctCredits,
                adjunctTarget,
                usedRoomSlots,
                totalRoomSlots,
                implicitUnknownFacultyCapacity
            };
        }

        function updateStats(quarter) {
            const data = scheduleData[quarter];
            refreshConflictData();
            const conflicts = conflictData[quarter] || [];

            let totalCourses = 0;
            Object.values(data).forEach(dayData => {
                Object.values(dayData).forEach(timeSlot => {
                    totalCourses += timeSlot.length;
                });
            });

            const criticalConflicts = conflicts.filter(c => c.severity === 'critical').length;
            const snapshot = buildCapacityUtilizationSnapshot(quarter, data);
            const utilizationRate = snapshot.utilizationPercent;

            document.getElementById('criticalConflicts').textContent = criticalConflicts;
            document.getElementById('totalConflicts').textContent = conflicts.length;
            document.getElementById('totalCourses').textContent = totalCourses;
            document.getElementById('utilizationRate').textContent = utilizationRate + '%';

            const utilizationEl = document.getElementById('utilizationRate');
            if (utilizationEl) {
                utilizationEl.title =
                    `Capacity-aware utilization\n`
                    + `Faculty load: ${snapshot.totalAssignedTeachingCredits.toFixed(1)} / ${snapshot.totalFacultyCapacityCredits.toFixed(1)} credits `
                    + `(${Math.round(snapshot.facultyUtilizationRate * 100)}%)\n`
                    + `Room slots used: ${snapshot.usedRoomSlots} / ${snapshot.totalRoomSlots} `
                    + `(${Math.round(snapshot.roomUtilizationRate * 100)}%)\n`
                    + `Room fit score: ${Math.round(snapshot.roomFitRate * 100)}%\n`
                    + `Adjunct assigned/target: ${snapshot.assignedAdjunctCredits.toFixed(1)} / ${snapshot.adjunctTarget.toFixed(1)} credits`
                    + (snapshot.implicitUnknownFacultyCapacity > 0
                        ? `\nImplicit capacity from non-AY faculty: ${snapshot.implicitUnknownFacultyCapacity.toFixed(1)} credits`
                        : '');
            }
        }

        function isCourseInMinor(courseCode, minorKey) {
            const normalizedCode = normalizeCourseCode(courseCode);
            return (minors[minorKey]?.courses || [])
                .some((code) => normalizeCourseCode(code) === normalizedCode);
        }

        function displayMinorInfo(minorKey) {
            const panel = document.getElementById('minorInfoPanel');

            // Clear safely
            while (panel.firstChild) {
                panel.removeChild(panel.firstChild);
            }

            if (minorKey === 'all') {
                return;
            }

            const minor = minors[minorKey];

            const infoPanel = document.createElement('div');
            infoPanel.className = 'minor-info-panel';

            const title = document.createElement('h3');
            title.textContent = minor.name;

            const reqText = document.createElement('p');
            reqText.textContent = 'Required Courses:';

            const coursesDiv = document.createElement('div');
            coursesDiv.className = 'minor-courses';
            minor.courses.forEach(course => {
                const tag = document.createElement('div');
                tag.className = 'minor-course-tag';
                tag.textContent = course;
                coursesDiv.appendChild(tag);
            });

            infoPanel.appendChild(title);
            infoPanel.appendChild(reqText);
            infoPanel.appendChild(coursesDiv);

            if (minor.note) {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'minor-note';
                noteDiv.textContent = minor.note;
                infoPanel.appendChild(noteDiv);
            }

            panel.appendChild(infoPanel);
        }

        function displayTrackSuggestions(trackKey) {
            const panel = document.getElementById('trackSuggestionsPanel');

            // Clear safely
            while (panel.firstChild) {
                panel.removeChild(panel.firstChild);
            }

            if (trackKey === 'all') {
                return;
            }

            const track = studentTracks[trackKey];
            const suggestedMinors = track.suggestedMinors.map(minorKey => {
                const minor = minors[minorKey];
                return {
                    key: minorKey,
                    name: minor.name,
                    typical: minor.typical
                };
            });

            const container = document.createElement('div');
            container.className = 'suggested-minors';

            const title = document.createElement('h3');
            title.textContent = 'Suggested Minors for ' + track.name + ' Students';

            const list = document.createElement('div');
            list.className = 'minor-list';

            suggestedMinors.forEach(m => {
                const chip = document.createElement('div');
                chip.className = 'minor-chip' + (!m.typical ? ' not-typical' : '');
                chip.textContent = m.name;
                chip.onclick = function() { selectMinor(m.key); };
                list.appendChild(chip);
            });

            container.appendChild(title);
            container.appendChild(list);
            panel.appendChild(container);
        }

        function selectMinor(minorKey) {
            document.getElementById('minorFilter').value = minorKey;
            document.getElementById('minorFilter').dispatchEvent(new Event('change'));
        }

        function resetLensFilters() {
            const minorFilter = document.getElementById('minorFilter');
            const trackFilter = document.getElementById('trackFilter');
            if (minorFilter) minorFilter.value = 'all';
            if (trackFilter) trackFilter.value = 'all';

            displayMinorInfo('all');
            highlightMinorCourses('all');
            displayTrackSuggestions('all');
            updateLensStatus();
        }

        function updateLensStatus() {
            const status = document.getElementById('lensStatus');
            if (!status) return;

            const minorKey = document.getElementById('minorFilter')?.value || 'all';
            const trackKey = document.getElementById('trackFilter')?.value || 'all';
            const chips = [];

            if (trackKey !== 'all' && studentTracks[trackKey]) {
                chips.push(`<span class="lens-chip">Track: ${escapeHtml(studentTracks[trackKey].name)}</span>`);
            }

            if (minorKey !== 'all' && minors[minorKey]) {
                const highlightedCount = document.querySelectorAll('.course-block.minor-highlight').length;
                chips.push(`<span class="lens-chip">Minor: ${escapeHtml(minors[minorKey].name)}</span>`);
                chips.push(`<span class="lens-chip">${highlightedCount} highlighted sections</span>`);
            }

            if (!chips.length) {
                status.textContent = 'No advising lens active.';
                return;
            }

            status.innerHTML = chips.join('');
        }

        function highlightMinorCourses(minorKey) {
            const courseBlocks = document.querySelectorAll('.course-block');
            courseBlocks.forEach(block => {
                block.classList.remove('minor-highlight');
            });

            if (minorKey !== 'all') {
                courseBlocks.forEach(block => {
                    const courseCode = normalizeCourseCode(
                        block.dataset.courseCode || block.querySelector('.course-name')?.textContent || ''
                    );
                    if (isCourseInMinor(courseCode, minorKey)) {
                        block.classList.add('minor-highlight');
                    }
                });
            }

            updateLensStatus();
        }

        // Current course being viewed/edited
        let currentCourseData = null;

        function showCourseDetails(code, name, instructor, credits, room, courseId, quarter, day, time) {
            // Store course data for edit modal
            currentCourseData = { code, name, instructor, credits, room, courseId, quarter, day, time };

            // Format day/time for display
            const dayDisplay = day || 'TBD';
            const timeDisplay = time || 'TBD';

            // Build details content
            const content = document.getElementById('courseDetailsContent');
            content.innerHTML = `
                <p><strong>Course:</strong> ${code} - ${name || 'N/A'}</p>
                <p><strong>Instructor:</strong> ${instructor || 'TBD'}</p>
                <p><strong>Credits:</strong> ${credits || 'N/A'}</p>
                <p><strong>Days:</strong> ${dayDisplay}</p>
                <p><strong>Time:</strong> ${timeDisplay}</p>
                <p><strong>Room:</strong> ${room || 'TBD'}</p>
            `;

            document.getElementById('detailsModalTitle').textContent = code;
            document.getElementById('courseDetailsModal').classList.add('active');
        }

        function closeCourseDetailsModal() {
            document.getElementById('courseDetailsModal').classList.remove('active');
            currentCourseData = null;
        }

        function openEditModal() {
            if (!currentCourseData) return;

            // Close details modal
            document.getElementById('courseDetailsModal').classList.remove('active');

            // Fill edit form with current data
            document.getElementById('editCourseId').value = currentCourseData.courseId || '';
            document.getElementById('editCourseCode').value = currentCourseData.code || '';
            document.getElementById('editSection').value = '001';
            document.getElementById('editCredits').value = currentCourseData.credits || 5;

            // Set year and quarter
            document.getElementById('editYear').value = '2025-26'; // Current academic year
            document.getElementById('editQuarter').value = currentCourseData.quarter || 'spring';

            // Default enrollment cap is 24 for most courses
            const specialCaps = { 'DESN 399': 5, 'DESN 491': 10, 'DESN 495': 15, 'DESN 499': 10 };
            const defaultCap = specialCaps[currentCourseData.code] || 24;
            document.getElementById('editEnrollmentCap').value = defaultCap;
            document.getElementById('editRoom').value = currentCourseData.room || '';
            document.getElementById('editNotes').value = '';

            // Parse time slot (e.g., "10:00-12:00" -> start: "10:00", end: "12:00")
            let startTime = '';
            let endTime = '';
            if (currentCourseData.time) {
                const timeParts = currentCourseData.time.split('-');
                if (timeParts.length === 2) {
                    startTime = timeParts[0];
                    endTime = timeParts[1];
                }
            }
            document.getElementById('editStartTime').value = startTime;
            document.getElementById('editEndTime').value = endTime;

            // Clear day checkboxes first
            ['M', 'T', 'W', 'Th', 'F'].forEach(day => {
                const cb = document.getElementById('editDay' + day);
                if (cb) cb.checked = false;
            });

            // Set day checkboxes based on current day pattern (e.g., "MW" -> M, W checked)
            if (currentCourseData.day) {
                const dayPattern = currentCourseData.day;
                if (dayPattern === 'MW') {
                    document.getElementById('editDayM').checked = true;
                    document.getElementById('editDayW').checked = true;
                } else if (dayPattern === 'TR') {
                    document.getElementById('editDayT').checked = true;
                    document.getElementById('editDayTh').checked = true;
                } else {
                    // Handle other patterns by checking matching days
                    if (dayPattern.includes('M')) document.getElementById('editDayM').checked = true;
                    if (dayPattern.includes('T') && !dayPattern.includes('Th')) document.getElementById('editDayT').checked = true;
                    if (dayPattern.includes('W')) document.getElementById('editDayW').checked = true;
                    if (dayPattern.includes('Th')) document.getElementById('editDayTh').checked = true;
                    if (dayPattern.includes('F')) document.getElementById('editDayF').checked = true;
                }
            }

            // Set faculty dropdown - find matching option
            const facultySelect = document.getElementById('editFaculty');
            const instructorValue = currentCourseData.instructor || '';
            let facultyFound = false;

            // Helper to extract last name from various formats
            const getLastName = (name) => {
                if (!name) return '';
                // Handle "S.Durr" format
                if (name.includes('.')) {
                    return name.split('.').pop().toLowerCase();
                }
                // Handle "Sam Durr" format
                return name.split(' ').pop().toLowerCase();
            };
            
            const instructorLastName = getLastName(instructorValue);

            for (let i = 0; i < facultySelect.options.length; i++) {
                const optionValue = facultySelect.options[i].value;
                
                // Try exact match first
                if (optionValue === instructorValue) {
                    facultySelect.selectedIndex = i;
                    facultyFound = true;
                    break;
                }

                // Check if last names match (handles "S.Durr" matching to "S.Durr (Lecturer)")
                const optionLastName = getLastName(optionValue);
                if (instructorLastName && optionLastName && instructorLastName === optionLastName) {
                    facultySelect.selectedIndex = i;
                    facultyFound = true;
                    break;
                }
            }

            // If still not found, set value directly (it may work if exact match exists)
            if (!facultyFound && instructorValue && instructorValue !== 'TBD') {
                facultySelect.value = instructorValue;
                if (facultySelect.value !== instructorValue) {
                    // Value didn't stick, reset to placeholder
                    facultySelect.selectedIndex = 0;
                }
            }

            // Try to get more data from ScheduleManager if available
            if (typeof ScheduleManager !== 'undefined' && currentCourseData.courseId) {
                const schedule = ScheduleManager.getQuarterSchedule('2025-26', currentCourseData.quarter);
                const course = schedule.find(c => c.id === currentCourseData.courseId);
                if (course) {
                    document.getElementById('editSection').value = course.section || '001';
                    // Only override enrollment cap if ScheduleManager has one set
                    if (course.enrollmentCap) {
                        document.getElementById('editEnrollmentCap').value = course.enrollmentCap;
                    }
                    document.getElementById('editNotes').value = course.notes || '';
                    // Override with ScheduleManager data if available
                    if (course.startTime) document.getElementById('editStartTime').value = course.startTime;
                    if (course.endTime) document.getElementById('editEndTime').value = course.endTime;
                    if (course.days && Array.isArray(course.days)) {
                        // Clear and reset days
                        ['M', 'T', 'W', 'Th', 'F'].forEach(day => {
                            const cb = document.getElementById('editDay' + day);
                            if (cb) cb.checked = false;
                        });
                        course.days.forEach(day => {
                            const cb = document.getElementById('editDay' + day);
                            if (cb) cb.checked = true;
                        });
                    }
                }
            }

            // Open edit modal
            document.getElementById('courseEditModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('courseEditModal').classList.remove('active');
        }

        function getEditSelectedDays() {
            const days = [];
            ['M', 'T', 'W', 'Th', 'F'].forEach(day => {
                const cb = document.getElementById('editDay' + day);
                if (cb && cb.checked) days.push(day);
            });
            return days;
        }

        function handleEditFormSubmit(e) {
            e.preventDefault();

            const courseId = document.getElementById('editCourseId').value;
            const year = document.getElementById('editYear').value;
            const quarterRaw = document.getElementById('editQuarter').value;
            const quarter = quarterRaw.charAt(0).toUpperCase() + quarterRaw.slice(1);
            const quarterLower = quarterRaw.toLowerCase();

            const newInstructor = document.getElementById('editFaculty').value || 'TBD';
            const newRoom = document.getElementById('editRoom').value || '';

            const updates = {
                section: document.getElementById('editSection').value,
                credits: parseInt(document.getElementById('editCredits').value) || 5,
                enrollmentCap: parseInt(document.getElementById('editEnrollmentCap').value) || 24,
                assignedFaculty: newInstructor,
                room: newRoom,
                days: getEditSelectedDays(),
                startTime: document.getElementById('editStartTime').value || null,
                endTime: document.getElementById('editEndTime').value || null,
                notes: document.getElementById('editNotes').value || null
            };

            // Track if we successfully saved
            let savedSuccessfully = false;

            // Update the scheduleData directly for immediate display (primary save path)
            if (currentCourseData) {
                const { day, time, room, code } = currentCourseData;
                const quarterData = scheduleData[quarterLower];
                
                if (quarterData && quarterData[day] && quarterData[day][time]) {
                    const courses = quarterData[day][time];
                    const courseIndex = courses.findIndex(c => c.code === code && c.room === room);
                    
                    if (courseIndex !== -1) {
                        courses[courseIndex].instructor = newInstructor;
                        if (newRoom) courses[courseIndex].room = newRoom;
                        // Update other fields
                        courses[courseIndex].credits = updates.credits;
                        courses[courseIndex].enrollmentCap = updates.enrollmentCap;
                        courses[courseIndex].section = updates.section;
                        if (updates.notes) courses[courseIndex].notes = updates.notes;
                        saveScheduleData();
                        savedSuccessfully = true;
                    }
                }
            }

            // Try ScheduleManager update as secondary sync (don't fail if it doesn't work)
            if (typeof ScheduleManager !== 'undefined' && courseId) {
                try {
                    const result = ScheduleManager.updateCourseAssignment(year, quarter, courseId, updates);
                    if (result.success) {
                        savedSuccessfully = true;
                    }
                    // If ScheduleManager fails but direct save worked, that's still OK
                } catch (e) {
                    console.log('ScheduleManager update skipped:', e.message);
                }
            }

            // Show result based on whether any save path succeeded
            if (savedSuccessfully) {
                showToast('Course updated successfully');
                closeEditModal();
                // Refresh the schedule view
                const currentQuarter = document.getElementById('quarterSelect').value;
                renderSchedule(currentQuarter);
                renderOnlineCourses(currentQuarter);
                renderArrangedCourses(currentQuarter);
            } else {
                // No direct save path available - try just closing and refreshing
                showToast('Course updated');
                closeEditModal();
                const currentQuarter = document.getElementById('quarterSelect').value;
                renderSchedule(currentQuarter);
                renderOnlineCourses(currentQuarter);
                renderArrangedCourses(currentQuarter);
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.style.background = type === 'error' ? '#dc3545' : '#1f2937';
            toast.classList.add('visible');
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        function highlightConflicts() {
            alert('Conflicts are highlighted in red (3+ courses) and orange (2 courses) in the schedule grid!');
        }

        function exportReport() {
            alert('Export functionality would generate a PDF report with full conflict analysis and recommendations.');
        }

        // Event listeners
        document.getElementById('quarterSelect').addEventListener('change', function() {
            const quarter = this.value;
            document.getElementById('quarterTitle').textContent = quarter.charAt(0).toUpperCase() + quarter.slice(1) + ' 2026';
            renderSchedule(quarter);
            renderOnlineCourses(quarter);
            renderArrangedCourses(quarter);
            renderEnrollmentAnalytics(quarter);
            renderConflicts(quarter);
            renderConflictSolver(quarter);
            renderRecommendations(quarter);
            updateStats(quarter);

            // Re-apply minor filter if active
            const minorFilter = document.getElementById('minorFilter').value;
            if (minorFilter !== 'all') {
                highlightMinorCourses(minorFilter);
            }
        });

        document.getElementById('minorFilter').addEventListener('change', function() {
            const minorKey = this.value;
            displayMinorInfo(minorKey);
            highlightMinorCourses(minorKey);
        });

        document.getElementById('trackFilter').addEventListener('change', function() {
            const trackKey = this.value;
            displayTrackSuggestions(trackKey);
            updateLensStatus();
        });

        // ============================================
        // DISPLACED COURSES TRAY
        // ============================================

        let displacedCourses = [];
        let courseToDelete = null;
        let swapMode = false; // false = displace, true = swap

        // Update swap mode labels when toggle changes
        function updateSwapModeLabels() {
            swapMode = document.getElementById('swapModeToggle').checked;
            document.getElementById('displaceLabel').classList.toggle('active', !swapMode);
            document.getElementById('swapLabel').classList.toggle('active', swapMode);
            // Save preference
            localStorage.setItem('swapMode', swapMode ? 'true' : 'false');
        }

        // Load swap mode preference
        function loadSwapMode() {
            const saved = localStorage.getItem('swapMode');
            swapMode = saved === 'true';
            document.getElementById('swapModeToggle').checked = swapMode;
            updateSwapModeLabels();
        }

        // Load displaced courses from localStorage
        function loadDisplacedCourses() {
            const saved = localStorage.getItem('displacedCourses');
            if (saved) {
                displacedCourses = JSON.parse(saved);
                updateDisplacedTray();
            }
        }

        // Save displaced courses to localStorage
        function saveDisplacedCourses() {
            localStorage.setItem('displacedCourses', JSON.stringify(displacedCourses));
        }

        // Add a course to the displaced tray
        function addToDisplacedTray(course) {
            displacedCourses.push(course);
            saveDisplacedCourses();
            updateDisplacedTray();
            openDisplacedTray();
        }

        // Remove a course from displaced tray
        function removeFromDisplacedTray(index) {
            displacedCourses.splice(index, 1);
            saveDisplacedCourses();
            updateDisplacedTray();
        }

        // Clear all displaced courses
        function clearAllDisplaced() {
            displacedCourses = [];
            saveDisplacedCourses();
            updateDisplacedTray();
            closeDisplacedTray();
        }

        // Update the displaced tray display
        function updateDisplacedTray() {
            const content = document.getElementById('displacedContent');
            const countBadge = document.getElementById('displacedCount');
            const toggleCount = document.getElementById('toggleCount');
            const toggle = document.getElementById('displacedToggle');

            countBadge.textContent = displacedCourses.length;
            toggleCount.textContent = displacedCourses.length;

            // Show/hide toggle button
            if (displacedCourses.length > 0) {
                toggle.classList.add('visible');
            } else {
                toggle.classList.remove('visible');
            }

            if (displacedCourses.length === 0) {
                content.innerHTML = `
                    <div class="displaced-empty">
                        <div class="displaced-empty-icon">📦</div>
                        <p>No displaced courses</p>
                        <p style="font-size: 0.8rem;">Courses bumped from their slots will appear here</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = displacedCourses.map((course, index) => `
                <div class="displaced-course-card" draggable="true"
                     data-displaced-index="${index}"
                     data-course-code="${course.code}"
                     ondragstart="handleDisplacedDragStart(event, ${index})"
                     ondragend="handleDisplacedDragEnd(event)">
                    <div class="displaced-course-header">
                        <span class="displaced-course-code">${course.code}</span>
                        <button class="displaced-course-remove" onclick="removeFromDisplacedTray(${index})" title="Remove">&times;</button>
                    </div>
                    <div class="displaced-course-name">${course.name || ''}</div>
                    <div class="displaced-course-origin">was at: ${course.originalDay} ${course.originalTime}, Room ${course.originalRoom}</div>
                </div>
            `).join('');
        }

        // Open displaced tray
        function openDisplacedTray() {
            document.getElementById('displacedTray').classList.add('open');
            document.getElementById('displacedToggle').classList.remove('visible');
            document.body.classList.add('tray-open');
        }

        // Close displaced tray
        function closeDisplacedTray() {
            document.getElementById('displacedTray').classList.remove('open');
            document.body.classList.remove('tray-open');
            if (displacedCourses.length > 0) {
                document.getElementById('displacedToggle').classList.add('visible');
            }
        }

        // Handle drag start from displaced tray
        function handleDisplacedDragStart(e, index) {
            const course = displacedCourses[index];
            e.target.classList.add('dragging');

            draggedCourse = {
                element: e.target,
                courseCode: course.code,
                courseName: course.name,
                instructor: course.instructor,
                credits: course.credits,
                isFromDisplacedTray: true,
                displacedIndex: index,
                originalDay: course.originalDay,
                originalTime: course.originalTime,
                originalRoom: course.originalRoom
            };

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedCourse));

            // Show drop indicator
            const indicator = document.getElementById('dropIndicator');
            document.getElementById('dropIndicatorText').textContent =
                'Dragging ' + course.code + ' - Drop on schedule to place';
            indicator.classList.add('active');
        }

        // Handle drag end from displaced tray
        function handleDisplacedDragEnd(e) {
            e.target.classList.remove('dragging');
            document.getElementById('dropIndicator').classList.remove('active');
            document.querySelectorAll('.schedule-cell').forEach(cell => {
                cell.classList.remove('drag-over');
            });
        }

        // Handle drag over the displaced tray (to drop courses into it)
        function handleTrayDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            document.getElementById('displacedTray').classList.add('drag-over');
            // Auto-open tray when dragging over
            openDisplacedTray();
        }

        // Handle drag leave from displaced tray
        function handleTrayDragLeave(e) {
            // Only remove if leaving the tray entirely
            if (!e.currentTarget.contains(e.relatedTarget)) {
                document.getElementById('displacedTray').classList.remove('drag-over');
            }
        }

        // Handle drop onto displaced tray
        function handleTrayDrop(e) {
            e.preventDefault();
            document.getElementById('displacedTray').classList.remove('drag-over');

            if (!draggedCourse || draggedCourse.isFromDisplacedTray) return;

            const quarter = document.getElementById('quarterSelect').value;
            const data = scheduleData[quarter];

            // Remove course from schedule and add to tray
            if (data[draggedCourse.originalDay] && data[draggedCourse.originalDay][draggedCourse.originalTime]) {
                const courses = data[draggedCourse.originalDay][draggedCourse.originalTime];
                const courseIndex = courses.findIndex(c => c.code === draggedCourse.courseCode);

                if (courseIndex > -1) {
                    const course = courses.splice(courseIndex, 1)[0];
                    addToDisplacedTray({
                        code: course.code,
                        name: course.name,
                        instructor: course.instructor,
                        credits: course.credits,
                        originalDay: draggedCourse.originalDay,
                        originalTime: draggedCourse.originalTime,
                        originalRoom: draggedCourse.originalRoom
                    });

                    renderSchedule(quarter);
                    renderConflicts(quarter);
                    updateStats(quarter);
                    showToast(course.code + ' moved to displaced tray');
                }
            }

            // Clear dragged course
            draggedCourse = null;
            document.getElementById('dropIndicator').classList.remove('active');
        }

        // ============================================
        // DELETE COURSE FUNCTIONALITY
        // ============================================

        function deleteCourse(courseCode, day, time, room, shiftKey) {
            if (shiftKey) {
                // Shift+Click: Move to displaced tray
                const data = scheduleData[document.getElementById('quarterSelect').value];
                if (data[day] && data[day][time]) {
                    const courseIndex = data[day][time].findIndex(c => c.code === courseCode && c.room === room);
                    if (courseIndex > -1) {
                        const course = data[day][time][courseIndex];
                        addToDisplacedTray({
                            code: course.code,
                            name: course.name,
                            instructor: course.instructor,
                            credits: course.credits,
                            originalDay: day,
                            originalTime: time,
                            originalRoom: room
                        });
                        data[day][time].splice(courseIndex, 1);
                        saveScheduleData(); // Persist changes
                        renderSchedule(document.getElementById('quarterSelect').value);
                        showToast(courseCode + ' moved to displaced tray');
                    }
                }
            } else {
                // Regular click: Show confirmation dialog
                courseToDelete = { courseCode, day, time, room };
                document.getElementById('deleteConfirmText').textContent =
                    'Are you sure you want to permanently remove ' + courseCode + ' from the schedule?';
                document.getElementById('deleteConfirmModal').classList.add('active');
            }
        }

        function confirmDelete() {
            if (!courseToDelete) return;

            const { courseCode, day, time, room } = courseToDelete;
            const quarter = document.getElementById('quarterSelect').value;
            const data = scheduleData[quarter];

            if (data[day] && data[day][time]) {
                const courseIndex = data[day][time].findIndex(c => c.code === courseCode && c.room === room);
                if (courseIndex > -1) {
                    data[day][time].splice(courseIndex, 1);
                    saveScheduleData(); // Persist changes
                    renderSchedule(quarter);
                    renderConflicts(quarter);
                    updateStats(quarter);
                    showToast(courseCode + ' removed from schedule');
                }
            }

            closeDeleteConfirm();
        }

        function closeDeleteConfirm() {
            document.getElementById('deleteConfirmModal').classList.remove('active');
            courseToDelete = null;
        }

        // ============================================
        // ADD COURSE FUNCTIONALITY
        // ============================================

        async function openAddCourseModal() {
            document.getElementById('addCourseForm').reset();
            document.getElementById('addDayM').checked = true;
            document.getElementById('addDayW').checked = true;
            document.getElementById('addOnlineSection').checked = false;
            toggleOnlineMode(false);
            document.getElementById('addCourseModal').classList.add('active');

            // Load courses from Supabase
            await loadCoursesFromSupabase();
            // Load faculty from Supabase
            await loadFacultyFromSupabase();
        }
        
        function toggleOnlineMode(isOnline) {
            const inPersonFields = document.getElementById('inPersonFields');
            const roomSelect = document.getElementById('addRoom');
            const startTime = document.getElementById('addStartTime');
            const endTime = document.getElementById('addEndTime');
            
            if (isOnline) {
                inPersonFields.style.display = 'none';
                roomSelect.value = 'ONLINE';
                roomSelect.disabled = true;
                startTime.required = false;
                endTime.required = false;
                roomSelect.required = false;
            } else {
                inPersonFields.style.display = 'block';
                roomSelect.value = '';
                roomSelect.disabled = false;
                startTime.required = true;
                endTime.required = true;
                roomSelect.required = true;
            }
        }

        async function loadCoursesFromSupabase() {
            const select = document.getElementById('addCourseCode');
            if (!supabase) return; // Keep hardcoded fallback if Supabase not configured

            try {
                const { data: courses, error } = await supabase
                    .from('courses')
                    .select('code, title')
                    .order('code');

                if (error) throw error;

                if (courses && courses.length > 0) {
                    // Clear existing options except the placeholder
                    select.innerHTML = '<option value="">Select Course...</option>';

                    // Add courses from database
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.code;
                        option.textContent = `${course.code} - ${course.title}`;
                        select.appendChild(option);
                    });
                    console.log(`Loaded ${courses.length} courses from Supabase`);
                }
            } catch (err) {
                console.warn('Could not load courses from Supabase, using fallback:', err.message);
            }
        }

        async function loadFacultyFromSupabase() {
            const select = document.getElementById('addFaculty');
            if (!supabase) return; // Keep hardcoded fallback if Supabase not configured

            try {
                const { data: faculty, error } = await supabase
                    .from('faculty')
                    .select('name')
                    .order('name');

                if (error) throw error;

                if (faculty && faculty.length > 0) {
                    // Clear existing options except the placeholder
                    select.innerHTML = '<option value="">Select Instructor...</option>';

                    // Add faculty from database
                    faculty.forEach(f => {
                        const option = document.createElement('option');
                        // Format name as "F.Lastname"
                        const nameParts = f.name.split(', ');
                        const shortName = nameParts.length > 1
                            ? `${nameParts[1].charAt(0)}.${nameParts[0]}`
                            : f.name;
                        option.value = shortName;
                        option.textContent = f.name;
                        select.appendChild(option);
                    });

                    // Add TBD option
                    const tbdOption = document.createElement('option');
                    tbdOption.value = 'TBD';
                    tbdOption.textContent = 'TBD';
                    select.appendChild(tbdOption);

                    console.log(`Loaded ${faculty.length} faculty from Supabase`);
                }
            } catch (err) {
                console.warn('Could not load faculty from Supabase, using fallback:', err.message);
            }
        }

        function closeAddCourseModal() {
            document.getElementById('addCourseModal').classList.remove('active');
        }

        function getAddSelectedDays() {
            const days = [];
            ['M', 'T', 'W', 'Th', 'F'].forEach(day => {
                const cb = document.getElementById('addDay' + day);
                if (cb && cb.checked) days.push(day);
            });
            return days;
        }

        function handleAddCourseSubmit(e) {
            e.preventDefault();

            const courseCode = normalizeCourseCode(document.getElementById('addCourseCode').value);
            const courseName = document.getElementById('addCourseCode').options[document.getElementById('addCourseCode').selectedIndex].text.split(' - ')[1] || '';
            const section = document.getElementById('addSection').value;
            const credits = parseInt(document.getElementById('addCredits').value);
            const instructor = document.getElementById('addFaculty').value || 'TBD';
            const isOnline = document.getElementById('addOnlineSection').checked;
            const room = document.getElementById('addRoom').value;

            const quarter = document.getElementById('quarterSelect').value;
            const data = scheduleData[quarter];

            let dayPattern, timeSlot;
            
            if (isOnline || room === 'ONLINE') {
                dayPattern = 'ONLINE';
                timeSlot = 'async';
            } else {
                const days = getAddSelectedDays();
                const startTime = document.getElementById('addStartTime').value;
                dayPattern = (days.includes('M') || days.includes('W')) ? 'MW' : 'TR';
                timeSlot = startTime.replace(':', '') === '1000' ? '10:00-12:20' :
                                startTime.replace(':', '') === '1300' ? '13:00-15:20' : '16:00-18:20';
            }

            // Ensure structure exists
            if (!data[dayPattern]) data[dayPattern] = {};
            if (!data[dayPattern][timeSlot]) data[dayPattern][timeSlot] = [];

            // Add the course
            data[dayPattern][timeSlot].push({
                code: courseCode,
                name: courseName,
                instructor: instructor,
                credits: credits,
                room: isOnline ? 'ONLINE' : room
            });

            closeAddCourseModal();
            saveScheduleData(); // Save to localStorage
            renderSchedule(quarter);
            renderConflicts(quarter);
            updateStats(quarter);
            showToast(courseCode + ' added to schedule');
        }

        // Current academic year
        let currentAcademicYear = '2025-26';

        // Schedule data persistence (year-aware)
        function getStorageKey(year) {
            return 'designSchedulerData_' + (year || currentAcademicYear);
        }

        function saveScheduleData() {
            try {
                normalizeScheduleCourseCodes(scheduleData);
                localStorage.setItem(getStorageKey(), JSON.stringify(scheduleData));
                console.log('Schedule data saved for year:', currentAcademicYear);
            } catch (e) {
                console.warn('Could not save schedule data:', e);
            }
        }

        function migrateTimeSlots(data) {
            const timeMapping = {
                '10:00-12:00': '10:00-12:20',
                '13:00-15:00': '13:00-15:20',
                '16:00-18:00': '16:00-18:20'
            };
            let migrated = false;
            
            for (const quarter of ['fall', 'winter', 'spring']) {
                if (data[quarter]) {
                    for (const day of ['MW', 'TR']) {
                        if (data[quarter][day]) {
                            for (const oldTime of Object.keys(timeMapping)) {
                                if (data[quarter][day][oldTime]) {
                                    const newTime = timeMapping[oldTime];
                                    data[quarter][day][newTime] = data[quarter][day][oldTime];
                                    delete data[quarter][day][oldTime];
                                    migrated = true;
                                }
                            }
                        }
                    }
                    // Ensure ONLINE structure exists if not present
                    if (!data[quarter]['ONLINE']) {
                        data[quarter]['ONLINE'] = { 'async': [] };
                    }
                }
            }
            
            if (migrated) {
                console.log('Migrated time slots to 2h 20min format');
            }
            return data;
        }

        function loadScheduleData(year) {
            const targetYear = year || currentAcademicYear;
            try {
                const saved = localStorage.getItem(getStorageKey(targetYear));
                if (saved) {
                    let parsed = JSON.parse(saved);
                    parsed = migrateTimeSlots(parsed);
                    parsed = normalizeScheduleCourseCodes(parsed);
                    for (const quarter of ['fall', 'winter', 'spring']) {
                        if (parsed[quarter]) {
                            scheduleData[quarter] = parsed[quarter];
                        }
                    }
                    console.log('Schedule data loaded for year:', targetYear);
                    saveScheduleData();
                    return true;
                }
            } catch (e) {
                console.warn('Could not load schedule data:', e);
            }
            return false;
        }

        function clearScheduleData() {
            localStorage.removeItem(getStorageKey());
            showToast('Schedule data cleared - refresh to reset');
        }

        // Migrate old storage format to year-aware format
        function migrateOldScheduleData() {
            const oldKey = 'designSchedulerData';
            const oldData = localStorage.getItem(oldKey);
            if (oldData && !localStorage.getItem(getStorageKey('2025-26'))) {
                localStorage.setItem(getStorageKey('2025-26'), oldData);
                localStorage.removeItem(oldKey);
                console.log('Migrated schedule data to year-aware format');
            }
        }

        // Switch academic year
        function switchAcademicYear(newYear) {
            // Save current year's data first
            saveScheduleData();

            // Switch to new year
            currentAcademicYear = newYear;

            // Reset scheduleData to defaults
            scheduleData.fall = {};
            scheduleData.winter = {};
            scheduleData.spring = {};

            // Load the new year's data (if any)
            const hasData = loadScheduleData(newYear);

            // Update quarter tab labels
            updateQuarterTabLabels(newYear);

            // Re-render current quarter
            const quarter = document.getElementById('quarterSelect').value;
            renderSchedule(quarter);
            renderConflicts(quarter);
            updateStats(quarter);

            if (!hasData) {
                showToast('Viewing ' + newYear + ' schedule (empty - use Copy to populate)');
            } else {
                showToast('Switched to ' + newYear + ' schedule');
            }
        }

        function updateQuarterTabLabels(year) {
            const [startYear, endYear] = year.split('-');
            const fullStartYear = '20' + startYear;
            const fullEndYear = '20' + endYear;

            document.querySelectorAll('.quarter-tab').forEach(tab => {
                const quarter = tab.dataset.quarter;
                const yearSpan = tab.querySelector('.tab-year');
                if (yearSpan) {
                    if (quarter === 'fall') {
                        yearSpan.textContent = fullStartYear;
                    } else {
                        yearSpan.textContent = fullEndYear;
                    }
                }
            });

            // Update hidden select options
            const quarterSelect = document.getElementById('quarterSelect');
            if (quarterSelect) {
                quarterSelect.options[0].text = 'Fall ' + fullStartYear;
                quarterSelect.options[1].text = 'Winter ' + fullEndYear;
                quarterSelect.options[2].text = 'Spring ' + fullEndYear;
            }

            // Update schedule grid title
            const quarterTitle = document.getElementById('quarterTitle');
            if (quarterTitle) {
                const currentQuarter = document.getElementById('quarterSelect').value;
                const qYear = currentQuarter === 'fall' ? fullStartYear : fullEndYear;
                quarterTitle.textContent = currentQuarter.charAt(0).toUpperCase() + currentQuarter.slice(1) + ' ' + qYear;
            }
        }

        // Copy current year's schedule to next year
        function copyToNextYear() {
            const yearSelect = document.getElementById('yearSelect');
            const currentIndex = yearSelect.selectedIndex;

            if (currentIndex >= yearSelect.options.length - 1) {
                // Need to add a new year option
                const currentYearParts = currentAcademicYear.split('-');
                const nextStartYear = parseInt(currentYearParts[0]) + 1;
                const nextEndYear = parseInt(currentYearParts[1]) + 1;
                const nextYear = nextStartYear + '-' + nextEndYear;

                // Add new option
                const newOption = document.createElement('option');
                newOption.value = nextYear;
                newOption.textContent = nextYear;
                yearSelect.appendChild(newOption);
            }

            const nextYear = yearSelect.options[currentIndex + 1].value;

            // Deep copy current schedule data
            const copyData = JSON.parse(JSON.stringify(scheduleData));

            // Save copy to next year's storage
            localStorage.setItem(getStorageKey(nextYear), JSON.stringify(copyData));

            showToast('Schedule copied to ' + nextYear + '!');

            // Ask if user wants to switch
            if (confirm('Schedule copied to ' + nextYear + '. Switch to that year now?')) {
                yearSelect.value = nextYear;
                switchAcademicYear(nextYear);
            }
        }

        // Initialize app - load data then render
        // Faculty data from workload-data.json
        let facultyList = [];

        async function loadFacultyData() {
            try {
                const response = await fetch('workload-data.json');
                if (response.ok) {
                    const data = await response.json();
                    if (data.facultyWorkload) {
                        facultyList = Object.keys(data.facultyWorkload).sort();
                        populateFacultyDropdowns();
                    }
                }
            } catch (error) {
                console.warn('Could not load faculty data:', error);
            }
        }

        function populateFacultyDropdowns() {
            const addFacultySelect = document.getElementById('addFaculty');
            const editFacultySelect = document.getElementById('editFaculty');

            // Clear existing options except first placeholder
            [addFacultySelect, editFacultySelect].forEach(select => {
                if (!select) return;
                // Keep first option (placeholder)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                // Add faculty options
                facultyList.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
                // Add TBD option at end
                const tbdOption = document.createElement('option');
                tbdOption.value = 'TBD';
                tbdOption.textContent = 'TBD';
                select.appendChild(tbdOption);
            });
        }

        // Custom faculty storage
        let customFaculty = JSON.parse(localStorage.getItem('customFaculty') || '[]');
        let pendingFacultySelectId = null;
        
        // Default faculty roster
        const defaultFaculty = {
            'Professors': [
                { name: 'T.Masingale', rank: 'Professor' },
                { name: 'G.Hustrulid', rank: 'Professor' },
                { name: 'M.Breen', rank: 'Professor' },
                { name: 'C.Manikoth', rank: 'Professor' }
            ],
            'Lecturers': [
                { name: 'S.Mills', rank: 'Lecturer' },
                { name: 'A.Sopu', rank: 'Lecturer' },
                { name: 'S.Durr', rank: 'Lecturer' }
            ],
            'Adjuncts': [
                { name: 'J.Braukmann', rank: 'Adjunct' }
            ]
        };
        
        function rebuildFacultyDropdowns() {
            const selects = [
                document.getElementById('addFaculty'),
                document.getElementById('editFaculty')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                
                // Clear and rebuild
                select.innerHTML = '<option value="">Select Instructor...</option>';
                
                // Add default faculty by rank
                Object.entries(defaultFaculty).forEach(([groupLabel, members]) => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = groupLabel;
                    members.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f.name;
                        opt.textContent = f.name + ' (' + f.rank + ')';
                        optgroup.appendChild(opt);
                    });
                    select.appendChild(optgroup);
                });
                
                // Add custom faculty if any
                if (customFaculty.length > 0) {
                    const customGroup = document.createElement('optgroup');
                    customGroup.label = 'Custom Faculty';
                    customFaculty.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f.name;
                        opt.textContent = f.name + ' (' + f.rank + ')';
                        customGroup.appendChild(opt);
                    });
                    select.appendChild(customGroup);
                }
                
                // Add TBD and Add New options
                const tbdOpt = document.createElement('option');
                tbdOpt.value = 'TBD';
                tbdOpt.textContent = 'TBD';
                select.appendChild(tbdOpt);
                
                const addNewOpt = document.createElement('option');
                addNewOpt.value = '__add_new__';
                addNewOpt.textContent = '+ Add New Faculty...';
                select.appendChild(addNewOpt);
                
                // Restore selection if possible
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }
        
        function handleFacultySelectChange(selectId) {
            const select = document.getElementById(selectId);
            if (select.value === '__add_new__') {
                pendingFacultySelectId = selectId;
                select.value = ''; // Reset selection
                openAddFacultyModal();
            }
        }
        
        function openAddFacultyModal() {
            document.getElementById('addFacultyForm').reset();
            document.getElementById('addFacultyModal').classList.add('active');
        }
        
        function closeAddFacultyModal() {
            document.getElementById('addFacultyModal').classList.remove('active');
            pendingFacultySelectId = null;
        }
        
        function handleAddFacultySubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('newFacultyName').value.trim();
            const rank = document.getElementById('newFacultyRank').value;
            
            if (!name || !rank) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            // Check for duplicates
            const allFaculty = [...Object.values(defaultFaculty).flat(), ...customFaculty];
            if (allFaculty.some(f => f.name.toLowerCase() === name.toLowerCase())) {
                showToast('Faculty member already exists', 'error');
                return;
            }
            
            // Add to custom faculty
            customFaculty.push({ name, rank });
            localStorage.setItem('customFaculty', JSON.stringify(customFaculty));
            
            // Rebuild dropdowns
            rebuildFacultyDropdowns();
            
            // Select the new faculty in the pending dropdown
            if (pendingFacultySelectId) {
                const select = document.getElementById(pendingFacultySelectId);
                if (select) {
                    select.value = name;
                }
            }
            
            closeAddFacultyModal();
            showToast('Faculty member added: ' + name);
        }

        async function init() {
            await loadEnrollmentData();
            await loadFacultyData();
            
            // Initialize custom faculty from localStorage
            customFaculty = JSON.parse(localStorage.getItem('customFaculty') || '[]');
            
            // Rebuild faculty dropdowns with current roster
            rebuildFacultyDropdowns();
            
            // Add change handlers to faculty selects
            document.getElementById('addFaculty')?.addEventListener('change', () => handleFacultySelectChange('addFaculty'));
            document.getElementById('editFaculty')?.addEventListener('change', () => handleFacultySelectChange('editFaculty'));

            // Migrate old schedule data format to year-aware format
            migrateOldScheduleData();

            // Load saved schedule data from localStorage
            loadScheduleData();

            // Check for imported schedule from schedule builder
            checkForImportedSchedule();

            // Initialize ScheduleManager for editing
            if (typeof ScheduleManager !== 'undefined') {
                await ScheduleManager.init({ catalogPath: 'data/course-catalog.json' });
                console.log('ScheduleManager initialized');
            }

            // Load displaced courses from localStorage
            loadDisplacedCourses();

            // Load swap mode preference
            loadSwapMode();

            // Initial render
            renderSchedule('spring');
            renderOnlineCourses('spring');
            renderArrangedCourses('spring');
            renderEnrollmentAnalytics('spring');
            renderConflicts('spring');
            renderConflictSolver('spring');
            renderRecommendations('spring');
            updateStats('spring');
        }

        // Start the app when page loads
        init();
    </script>

    <!-- Course Details Modal -->
    <div class="modal-overlay" id="courseDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="detailsModalTitle">Course Details</h2>
                <button class="modal-close" onclick="closeCourseDetailsModal()">&times;</button>
            </div>
            <div class="course-details-content" id="courseDetailsContent">
                <!-- Filled dynamically -->
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeCourseDetailsModal()">Close</button>
                <button class="btn-primary" id="editCourseBtn" onclick="openEditModal()">Edit Course</button>
            </div>
        </div>
    </div>

    <!-- Edit Course Modal -->
    <div class="modal-overlay" id="courseEditModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Course</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>

            <form id="editCourseForm" onsubmit="handleEditFormSubmit(event)">
                <input type="hidden" id="editCourseId">

                <div class="modal-body">
                    <div class="form-input-group">
                        <div class="form-group">
                            <label class="form-label">Course Code</label>
                            <input type="text" id="editCourseCode" class="form-input" readonly style="background: #f3f4f6;">
                        </div>

                        <div class="form-group">
                            <label for="editSection" class="form-label">Section</label>
                            <input type="text" id="editSection" class="form-input" maxlength="3">
                        </div>
                    </div>

                    <div class="form-input-group">
                        <div class="form-group">
                            <label for="editYear" class="form-label">Academic Year</label>
                            <select id="editYear" class="form-select">
                                <option value="2025-26">2025-26</option>
                                <option value="2026-27">2026-27</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editQuarter" class="form-label">Quarter</label>
                            <select id="editQuarter" class="form-select">
                                <option value="fall">Fall</option>
                                <option value="winter">Winter</option>
                                <option value="spring">Spring</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editCredits" class="form-label">Credits</label>
                            <input type="number" id="editCredits" class="form-input" min="1" max="15" step="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editEnrollmentCap" class="form-label">Enrollment Cap</label>
                        <input type="number" id="editEnrollmentCap" class="form-input" min="1" max="100" step="1">
                    </div>

                    <div class="form-group">
                        <label for="editFaculty" class="form-label">Faculty</label>
                        <select id="editFaculty" class="form-select">
                            <option value="">Select Instructor...</option>
                            <optgroup label="Professors">
                                <option value="T.Masingale">T.Masingale (Professor)</option>
                                <option value="G.Hustrulid">G.Hustrulid (Professor)</option>
                                <option value="M.Breen">M.Breen (Professor)</option>
                                <option value="C.Manikoth">C.Manikoth (Professor)</option>
                            </optgroup>
                            <optgroup label="Lecturers">
                                <option value="S.Mills">S.Mills (Lecturer)</option>
                                <option value="A.Sopu">A.Sopu (Lecturer)</option>
                                <option value="S.Durr">S.Durr (Lecturer)</option>
                            </optgroup>
                            <optgroup label="Adjuncts">
                                <option value="J.Braukmann">J.Braukmann (Adjunct)</option>
                            </optgroup>
                            <option value="TBD">TBD</option>
                            <option value="__add_new__">+ Add New Faculty...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Days</label>
                        <div style="display: flex; gap: 12px; margin-top: 6px;">
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="checkbox" id="editDayM" value="M"> M
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="checkbox" id="editDayT" value="T"> T
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="checkbox" id="editDayW" value="W"> W
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="checkbox" id="editDayTh" value="Th"> Th
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="checkbox" id="editDayF" value="F"> F
                            </label>
                        </div>
                    </div>

                    <div class="form-input-group">
                        <div class="form-group">
                            <label for="editStartTime" class="form-label">Start Time</label>
                            <input type="time" id="editStartTime" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="editEndTime" class="form-label">End Time</label>
                            <input type="time" id="editEndTime" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editRoom" class="form-label">Room</label>
                        <input type="text" id="editRoom" class="form-input" placeholder="e.g., CEB 242">
                    </div>

                    <div class="form-group">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea id="editNotes" class="form-input" rows="2" placeholder="Optional notes..."></textarea>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div class="modal-overlay" id="addCourseModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Course to Schedule</h2>
                <button class="modal-close" onclick="closeAddCourseModal()">&times;</button>
            </div>

            <form id="addCourseForm" onsubmit="handleAddCourseSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addCourseCode" class="form-label">Course</label>
                        <select id="addCourseCode" class="form-select" required>
                            <option value="">Select Course...</option>
                            <option value="DESN 100">DESN 100 - Drawing for Communication</option>
                            <option value="DESN 200">DESN 200 - Visual Thinking + Making</option>
                            <option value="DESN 216">DESN 216 - Digital Foundations</option>
                            <option value="DESN 243">DESN 243 - Typography</option>
                            <option value="DESN 263">DESN 263 - Visual Communication Design</option>
                            <option value="DESN 301">DESN 301 - Visual Storytelling</option>
                            <option value="DESN 326">DESN 326 - Introduction to Animation</option>
                            <option value="DESN 338">DESN 338 - UX Design 1</option>
                            <option value="DESN 345">DESN 345 - Digital Game Design</option>
                            <option value="DESN 348">DESN 348 - UX Design 2</option>
                            <option value="DESN 355">DESN 355 - Motion Design</option>
                            <option value="DESN 359">DESN 359 - Histories of Design</option>
                            <option value="DESN 368">DESN 368 - Code + Design 1</option>
                            <option value="DESN 369">DESN 369 - Web Development 1</option>
                            <option value="DESN 378">DESN 378 - Code + Design 2</option>
                            <option value="DESN 379">DESN 379 - Web Development 2</option>
                            <option value="DESN 458">DESN 458 - UX Design 3</option>
                            <option value="DESN 463">DESN 463 - Community-Driven Design</option>
                            <option value="DESN 468">DESN 468 - Code + Design 3</option>
                            <option value="DESN 480">DESN 480 - Professional Practice</option>
                            <option value="DESN 490">DESN 490 - Senior Capstone</option>
                        </select>
                    </div>

                    <div class="form-input-group">
                        <div class="form-group">
                            <label for="addSection" class="form-label">Section</label>
                            <input type="text" id="addSection" class="form-input" value="001" maxlength="3" required>
                        </div>

                        <div class="form-group">
                            <label for="addCredits" class="form-label">Credits</label>
                            <input type="number" id="addCredits" class="form-input" value="5" min="1" max="15" step="1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="addFaculty" class="form-label">Instructor</label>
                        <select id="addFaculty" class="form-select">
                            <option value="">Select Instructor...</option>
                            <optgroup label="Professors">
                                <option value="T.Masingale">T.Masingale (Professor)</option>
                                <option value="G.Hustrulid">G.Hustrulid (Professor)</option>
                                <option value="M.Breen">M.Breen (Professor)</option>
                                <option value="C.Manikoth">C.Manikoth (Professor)</option>
                            </optgroup>
                            <optgroup label="Lecturers">
                                <option value="S.Mills">S.Mills (Lecturer)</option>
                                <option value="A.Sopu">A.Sopu (Lecturer)</option>
                                <option value="S.Durr">S.Durr (Lecturer)</option>
                            </optgroup>
                            <optgroup label="Adjuncts">
                                <option value="J.Braukmann">J.Braukmann (Adjunct)</option>
                            </optgroup>
                            <option value="TBD">TBD</option>
                            <option value="__add_new__">+ Add New Faculty...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: #f0fdf4; border-radius: 6px; border: 1px solid #86efac;">
                            <input type="checkbox" id="addOnlineSection" onchange="toggleOnlineMode(this.checked)">
                            <span style="font-weight: 500; color: #166534;">Online/Async Section</span>
                        </label>
                    </div>

                    <div id="inPersonFields">
                        <div class="form-group">
                            <label class="form-label">Days</label>
                            <div style="display: flex; gap: 12px; margin-top: 6px;">
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="checkbox" id="addDayM" value="M" checked> M
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="checkbox" id="addDayT" value="T"> T
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="checkbox" id="addDayW" value="W" checked> W
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="checkbox" id="addDayTh" value="Th"> Th
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="checkbox" id="addDayF" value="F"> F
                                </label>
                            </div>
                        </div>

                    <div class="form-input-group">
                        <div class="form-group">
                            <label for="addStartTime" class="form-label">Start Time</label>
                            <select id="addStartTime" class="form-select" required>
                                <option value="10:00">10:00 AM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="addEndTime" class="form-label">End Time</label>
                            <select id="addEndTime" class="form-select" required>
                                <option value="12:00">12:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="18:00">6:00 PM</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="addRoom" class="form-label">Room</label>
                        <select id="addRoom" class="form-select" required>
                            <option value="">Select Room...</option>
                            <option value="206">206 - UX Lab</option>
                            <option value="207">207 - Media Lab</option>
                            <option value="209">209 - Mac Lab</option>
                            <option value="210">210 - Mac Lab</option>
                            <option value="212">212 - Project Lab</option>
                            <option value="CEB 102">CEB 102</option>
                            <option value="CEB 104">CEB 104</option>
                            <option value="ONLINE">Online / Async</option>
                        </select>
                    </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddCourseModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add to Schedule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Drop Indicator -->
    <div class="drop-indicator" id="dropIndicator">
        <span id="dropIndicatorText">Drop to move course</span>
    </div>

    <!-- Faculty Modal -->
    <div class="faculty-modal-overlay" id="facultyModalOverlay" onclick="closeFacultyModal(event)">
        <div class="faculty-modal" onclick="event.stopPropagation()">
            <div class="faculty-modal-header">
                <h3 id="facultyModalName">Faculty Name</h3>
                <button class="faculty-modal-close" onclick="closeFacultyModal()">&times;</button>
            </div>
            <div class="faculty-modal-body">
                <div class="faculty-modal-section">
                    <h4>Current Schedule</h4>
                    <div id="facultyModalSchedule">
                        <!-- Schedule items will be populated by JavaScript -->
                    </div>
                </div>
                <div class="faculty-modal-section">
                    <h4>Workload Summary</h4>
                    <div class="faculty-modal-stats" id="facultyModalStats">
                        <!-- Stats will be populated by JavaScript -->
                    </div>
                </div>
                <div class="faculty-modal-section">
                    <h4>Preferences</h4>
                    <div id="facultyModalPreferences">
                        <!-- Preferences will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage">Changes saved</span>
    </div>

    <!-- Add Faculty Modal -->
    <div class="modal-overlay" id="addFacultyModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Add New Faculty</h2>
                <button class="modal-close" onclick="closeAddFacultyModal()">&times;</button>
            </div>
            <form id="addFacultyForm" onsubmit="handleAddFacultySubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newFacultyName" class="form-label">Name (First Initial.LastName)</label>
                        <input type="text" id="newFacultyName" class="form-input" placeholder="e.g., J.Smith" required>
                        <small style="color: #6b7280; font-size: 0.85em;">Format: First initial + period + last name</small>
                    </div>
                    <div class="form-group">
                        <label for="newFacultyRank" class="form-label">Rank</label>
                        <select id="newFacultyRank" class="form-select" required>
                            <option value="">Select Rank...</option>
                            <option value="Professor">Professor</option>
                            <option value="Lecturer">Lecturer</option>
                            <option value="Adjunct">Adjunct</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddFacultyModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Faculty</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scheduling Rules Panel -->
    <div class="modal-overlay" id="constraintsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Scheduling Rules</h2>
                <button class="modal-close" onclick="closeConstraintsModal()">&times;</button>
            </div>
            <div class="modal-body" id="constraintsContent" style="max-height: 500px; overflow-y: auto;">
                <p style="color: #6b7280; margin-bottom: 16px;">Toggle rules on/off to customize conflict detection. Changes are saved automatically.</p>
                <div id="constraintsList">
                    <!-- Populated by JavaScript -->
                    <div style="text-align: center; padding: 20px; color: #6b7280;">Loading constraints...</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeConstraintsModal()">Close</button>
                <a href="https://supabase.com/dashboard" target="_blank" class="btn-secondary" style="text-decoration: none;">+ Add Rule in Supabase</a>
            </div>
        </div>
    </div>

    <!-- API Settings Modal -->
    <div class="modal-overlay" id="apiSettingsModal" onclick="closeApiSettingsModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>AI API Settings (OpenAI or Claude)</h2>
                <button class="modal-close" onclick="closeApiSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="api-help">
                    <strong>How this works</strong>
                    1. Paste your API key.
                    2. Choose key type (checkbox).
                    3. Click Test Connection.
                    4. Save and close.
                </div>
                <div class="form-group">
                    <label for="apiKeyInput">API Key</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="password" id="apiKeyInput" placeholder="sk-... or sk-ant-..." style="flex: 1; font-family: monospace;">
                        <button class="btn-secondary" onclick="toggleApiKeyVisibility()">👁️</button>
                    </div>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">Use either <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API keys</a> or <a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic API keys</a>.</p>
                </div>
                <div class="api-provider-type">
                    <label><input type="checkbox" id="providerOpenAI" onchange="toggleApiProviderType('openai')">Use OpenAI key</label>
                    <label><input type="checkbox" id="providerClaude" onchange="toggleApiProviderType('anthropic')">Use Claude (Anthropic) key</label>
                    <p class="api-provider-note">If neither is checked, the app auto-detects key type from prefix.</p>
                </div>
                <div class="api-model-group">
                    <label for="apiModelSelect">Model</label>
                    <select id="apiModelSelect" class="api-model-select"></select>
                    <p class="api-model-note">Pick the model used for Program Command and AI analysis.</p>
                </div>
                <div id="apiKeyStatus" class="api-status-box">
                    <div class="api-status-title">Status</div>
                    <div id="apiKeyStatusMessage" class="api-status-message">No API key configured.</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeApiSettingsModal()">Close</button>
                <button class="btn-secondary" style="background: #ef4444; color: white; border: none;" onclick="clearApiKey()">Clear Key</button>
                <button class="btn-secondary" onclick="testApiConnection()">Test Connection</button>
                <button class="btn-primary" onclick="saveApiKey()">Save</button>
            </div>
        </div>
    </div>

    <!-- Print Dialog Modal -->
    <div class="modal-overlay" id="printModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Print Schedule</h2>
                <button class="modal-close" onclick="closePrintDialog()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">What would you like to print?</p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn-primary" onclick="printSchedule('current')" style="padding: 12px 16px;">
                        Print Current Quarter Only
                        <span style="display: block; font-size: 12px; opacity: 0.8; margin-top: 4px;" id="printCurrentLabel"></span>
                    </button>
                    <button class="btn-secondary" onclick="printSchedule('all')" style="padding: 12px 16px;">
                        Print All Three Quarters
                        <span style="display: block; font-size: 12px; opacity: 0.8; margin-top: 4px;">Fall, Winter, Spring</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conflict Detection Results Panel -->
    <div class="results-panel" id="conflictResultsPanel" style="display: none;">
        <div class="results-panel-header">
            <h3>🔍 Conflict Detection Results</h3>
            <button class="modal-close" onclick="closeConflictResultsPanel()">&times;</button>
        </div>
        <div class="results-panel-content" id="conflictResultsContent">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- AI Analysis Results Panel -->
    <div class="results-panel ai-panel" id="aiResultsPanel" style="display: none;">
        <div class="results-panel-header ai-results-header-ewu">
            <h3>✨ Program Command Analysis</h3>
            <button class="modal-close" onclick="closeAiResultsPanel()">&times;</button>
        </div>
        <div class="results-panel-loading" id="aiResultsLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Analyzing schedule with ChatGPT...</p>
        </div>
        <div class="results-panel-content" id="aiResultsContent">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <style>
        /* Results Panel Styles */
        .results-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 450px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .results-panel.active {
            transform: translateX(0);
            display: flex;
        }
        .results-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .results-panel-header h3 {
            margin: 0;
            font-size: 16px;
        }
        .results-panel-header .modal-close {
            color: white;
            font-size: 28px;
        }
        .results-panel-header .modal-close:hover {
            color: rgba(255,255,255,0.8);
        }
        .results-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .results-panel-loading {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            color: #6b7280;
        }
        .conflict-item {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-left: 4px solid #ef4444;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .conflict-item.warning {
            background: #fffbeb;
            border-color: #fde68a;
            border-left-color: #f59e0b;
        }
        .conflict-item.info {
            background: #eff6ff;
            border-color: #bfdbfe;
            border-left-color: #3b82f6;
        }
        .conflict-item h4 {
            margin: 0 0 8px;
            font-size: 14px;
            color: #1f2937;
        }
        .conflict-item p {
            margin: 0;
            font-size: 13px;
            color: #4b5563;
        }
        .conflict-suggestion {
            margin-top: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            font-size: 12px;
        }
        .no-conflicts {
            text-align: center;
            padding: 40px 20px;
            color: #10b981;
        }
        .no-conflicts .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        .health-score {
            text-align: center;
            padding: 20px;
            margin-bottom: 16px;
            background: #f9fafb;
            border-radius: 12px;
        }
        .health-score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            border: 4px solid #e5e7eb;
            font-size: 24px;
            font-weight: 700;
        }
        .health-score-circle.good { border-color: #10b981; color: #10b981; }
        .health-score-circle.medium { border-color: #f59e0b; color: #f59e0b; }
        .health-score-circle.poor { border-color: #ef4444; color: #ef4444; }
    </style>

    <!-- OpenAI Integration Scripts -->
    <script src="js/claude-service.js"></script>
    <script src="js/schedule-evaluator.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>

    <script>
        // ============================================
        // SAVE, CONFLICT DETECTION & AI ANALYSIS
        // ============================================

        async function exportToGoogleSheets() {
            if (window.location.hostname.endsWith('github.io')) {
                showToast('Google Sheets export needs the Node API server and is unavailable on GitHub Pages.', 'error');
                return;
            }

            showToast('Exporting to Google Sheets...');
            
            try {
                const exportData = {
                    fall: flattenQuarterData(scheduleData.fall || {}),
                    winter: flattenQuarterData(scheduleData.winter || {}),
                    spring: flattenQuarterData(scheduleData.spring || {})
                };
                
                const response = await fetch('/api/export-to-sheets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scheduleData: exportData,
                        academicYear: currentAcademicYear
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Exported! Opening spreadsheet...');
                    window.open(result.spreadsheetUrl, '_blank');
                } else {
                    showToast('Export failed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('Export failed: ' + error.message, 'error');
            }
        }
        
        function flattenQuarterData(quarterData) {
            const courses = [];
            for (const day of Object.keys(quarterData)) {
                const dayData = quarterData[day];
                if (!dayData || typeof dayData !== 'object') continue;
                
                for (const time of Object.keys(dayData)) {
                    const timeCourses = dayData[time];
                    if (!Array.isArray(timeCourses)) continue;
                    
                    for (const course of timeCourses) {
                        courses.push({
                            ...course,
                            day: day,
                            time: time
                        });
                    }
                }
            }
            return courses;
        }

        /**
         * Save schedule changes to localStorage and optionally to database
         */
        function saveScheduleChanges() {
            try {
                // Get current schedule data
                const quarter = document.getElementById('quarterSelect').value;
                const scheduleData = {
                    quarter: quarter,
                    savedAt: new Date().toISOString(),
                    courses: getCurrentScheduleData()
                };

                // Save to localStorage
                localStorage.setItem(`schedule_${quarter}`, JSON.stringify(scheduleData));

                showToast('Schedule saved successfully!');
            } catch (error) {
                console.error('Error saving schedule:', error);
                showToast('Error saving schedule');
            }
        }

        /**
         * Get current schedule data from the grid
         */
        function getCurrentScheduleData() {
            const quarter = document.getElementById('quarterSelect')?.value || 'spring';
            const quarterCourses = flattenQuarterData(scheduleData[quarter] || {});
            return quarterCourses.map((course, index) => ({
                code: normalizeCourseCode(course.code),
                section: course.section || String(index + 1).padStart(3, '0'),
                title: course.name || course.title || '',
                instructor: course.instructor || 'TBD',
                room: course.room || '',
                day: course.day || '',
                time: course.time || '',
                credits: Number(course.credits) || 5
            }));
        }

        function getScheduleByQuarterCourses() {
            const quarterCourses = {};
            CONFLICT_QUARTERS.forEach((quarter) => {
                quarterCourses[quarter] = flattenQuarterData(scheduleData[quarter] || {}).map((course, index) => ({
                    code: normalizeCourseCode(course.code),
                    section: course.section || String(index + 1).padStart(3, '0'),
                    title: course.name || course.title || '',
                    instructor: course.instructor || 'TBD',
                    room: course.room || '',
                    day: course.day || '',
                    time: course.time || '',
                    credits: Number(course.credits) || 5
                }));
            });
            return quarterCourses;
        }

        function ensureAySetupConstraint(constraints) {
            const list = Array.isArray(constraints) ? [...constraints] : [];
            const hasAyConstraint = list.some((constraint) => constraint.constraint_type === 'ay_setup_alignment');
            if (hasAyConstraint) return list;

            list.push({
                id: 'local-ay-setup-alignment',
                enabled: true,
                constraint_type: 'ay_setup_alignment',
                description: 'Academic Year Setup alignment for workload and adjunct targets',
                rule_details: {
                    annualOverloadWarning: 3,
                    annualOverloadCritical: 8,
                    annualUnderloadWarning: 6,
                    quarterOverloadWarning: 2,
                    quarterOverloadCritical: 5,
                    quarterUnderloadWarning: 3,
                    adjunctUnderloadWarning: 0.5,
                    adjunctOverloadWarning: 2
                }
            });

            return list;
        }

        function ensureCoreConflictConstraints(constraints) {
            const list = Array.isArray(constraints) ? [...constraints] : [];
            const existingTypes = new Set(
                list.map((constraint) => String(constraint?.constraint_type || '').trim().toLowerCase())
            );
            const hasAnyType = (...types) => types.some((type) => existingTypes.has(type));

            if (!hasAnyType('student_conflict', 'pathway_conflict', 'student_pathway_conflict', 'student_scheduling_conflict')) {
                list.push({
                    id: 'local-student-conflict',
                    enabled: true,
                    constraint_type: 'student_conflict',
                    description: 'Graduation pathway pairings cannot overlap in the same slot',
                    rule_details: {
                        severity: 'critical',
                        message: 'Courses in the same graduation pathway are scheduled at the same time.'
                    }
                });
            }

            if (!hasAnyType('faculty_double_book', 'faculty_conflict', 'faculty_double_booking')) {
                list.push({
                    id: 'local-faculty-double-book',
                    enabled: true,
                    constraint_type: 'faculty_double_book',
                    description: 'Faculty cannot be double-booked in the same slot',
                    rule_details: {
                        severity: 'critical',
                        message: 'Instructor is scheduled in multiple rooms at the same time.'
                    }
                });
            }

            if (!hasAnyType('room_double_book', 'room_conflict', 'room_double_booking')) {
                list.push({
                    id: 'local-room-double-book',
                    enabled: true,
                    constraint_type: 'room_double_book',
                    description: 'A room can only host one class per time slot',
                    rule_details: {
                        severity: 'critical',
                        message: 'Multiple courses share the same room/time slot.'
                    }
                });
            }

            return list;
        }

        // Winter 2026 enrollment data for predictions
        let winterEnrollmentData = null;

        // Load Winter enrollment data on page load
        fetch('data/winter-2026-enrollments.json')
            .then(response => response.json())
            .then(data => {
                winterEnrollmentData = data;
                console.log('Winter 2026 enrollment data loaded:', data.summary);
            })
            .catch(err => console.warn('Could not load winter enrollment data:', err));

        /**
         * Run conflict detection algorithm using database-driven constraints
         */
        async function runConflictDetection() {
            const panel = document.getElementById('conflictResultsPanel');
            const content = document.getElementById('conflictResultsContent');

            // Get the currently selected quarter
            const currentQuarter = document.getElementById('quarterSelect')?.value || 'spring';
            const [startYearPart, endYearPart] = String(currentAcademicYear || '2025-26').split('-');
            const quarterYear = currentQuarter === 'fall'
                ? Number(startYearPart)
                : Number(`20${endYearPart}`);
            const currentQuarterDisplay = `${CONFLICT_QUARTER_LABELS[currentQuarter] || currentQuarter} ${quarterYear}`;

            // Show panel with loading state
            panel.style.display = 'flex';
            setTimeout(() => panel.classList.add('active'), 10);
            content.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 2em;">Loading constraints...</div></div>';

            // Clear old static conflict sections at bottom of page
            clearOldConflictSections();

            // Get all scheduled courses for the current quarter
            const courses = getCurrentScheduleData();
            const scheduleByQuarter = getScheduleByQuarterCourses();
            const aySetupData = readAySetupDataForYear(currentAcademicYear);

            // Load constraints from database (or fallback)
            let constraints;
            try {
                constraints = await ConstraintsService.loadEnabledConstraints();
            } catch (err) {
                console.warn('Failed to load constraints, using fallback:', err);
                constraints = ConstraintsService.getFallbackConstraints();
            }
            constraints = ensureCoreConflictConstraints(constraints);
            constraints = ensureAySetupConstraint(constraints);

            // Run the conflict engine
            const results = ConflictEngine.evaluate(courses, constraints, {
                currentQuarter,
                academicYear: currentAcademicYear,
                scheduleByQuarter,
                aySetupData,
                canonicalizeFacultyName: getCanonicalFacultyName
            });
            const conflicts = [...results.conflicts];
            const warnings = [...results.warnings];
            const suggestions = [...results.suggestions];
            const enrollmentInsights = [];

            // Enrollment-based predictions from Winter 2026 data
            // NOTE: The "waitlist" field in data = REMAINING SEATS AVAILABLE, not students waiting
            if (winterEnrollmentData && winterEnrollmentData.courses) {
                const scheduledCodes = courses.map(c => c.code);

                // High-demand courses = nearly full (few remaining seats)
                // Filter for courses with 3 or fewer seats remaining
                const highDemandCourses = winterEnrollmentData.courses.filter(c =>
                    c.waitlist <= 3 && c.capacity >= 15 && c.enrolled >= 15
                );
                highDemandCourses.forEach(course => {
                    const courseCode = course.code;
                    const sectionsInSpring = scheduledCodes.filter(c => c === courseCode).length;
                    const remainingSeats = course.waitlist;
                    const fillRate = Math.round((course.enrolled / course.capacity) * 100);

                    enrollmentInsights.push({
                        type: 'high-demand',
                        severity: 'info',
                        title: `High Demand: ${courseCode}`,
                        description: `${course.title} is ${fillRate}% full in Winter 2026 (${course.enrolled}/${course.capacity} enrolled, only ${remainingSeats} seat${remainingSeats !== 1 ? 's' : ''} remaining). ${sectionsInSpring > 0 ? `You have ${sectionsInSpring} section(s) in Spring.` : 'Not currently scheduled for Spring.'}`,
                        suggestion: remainingSeats === 0 ? 'Consider adding an additional section for Spring' : 'Monitor enrollment closely'
                    });
                });

                // Low enrollment courses - many empty seats
                const lowEnrollmentCourses = winterEnrollmentData.courses.filter(c =>
                    c.capacity >= 20 && c.enrolled <= 8 && c.scheduleType === 'Performance'
                );
                lowEnrollmentCourses.forEach(course => {
                    const remainingSeats = course.waitlist;
                    enrollmentInsights.push({
                        type: 'low-enrollment',
                        severity: 'warning',
                        title: `Low Enrollment: ${course.code}`,
                        description: `${course.title} has only ${course.enrolled}/${course.capacity} enrolled in Winter (${remainingSeats} seats still available)`,
                        suggestion: 'Consider whether to offer in Spring or combine sections'
                    });
                });

                // Full courses (0 remaining seats)
                const fullCourses = winterEnrollmentData.courses.filter(c =>
                    c.waitlist === 0 && c.capacity >= 15
                );
                fullCourses.forEach(course => {
                    suggestions.push({
                        type: 'capacity',
                        severity: 'info',
                        title: `At Capacity: ${course.code}`,
                        description: `${course.title} is completely full in Winter (${course.enrolled}/${course.capacity}) - strong demand`,
                        suggestion: 'Consider adding another section or increasing capacity for Spring'
                    });
                });

                // Add summary from Winter data
                if (winterEnrollmentData.summary) {
                    const summary = winterEnrollmentData.summary;
                    enrollmentInsights.unshift({
                        type: 'summary',
                        severity: 'info',
                        title: 'Winter 2026 Overview',
                        description: `Total enrolled: ${summary.totalEnrolled}/${summary.totalCapacity} (${summary.overallFillRate} fill rate). ${summary.fullCourses ? summary.fullCourses.length : 0} courses at capacity.`,
                        suggestion: summary.highDemand && summary.highDemand.length > 0 ? `High demand: ${summary.highDemand.map(h => h.code).join(', ')}` : 'No critically full courses'
                    });
                }
            }

            // Run graduation pathway analysis
            let pathwayResults = { conflicts: [], warnings: [], pathwayHealth: 100 };
            if (typeof GraduationOptimizer !== 'undefined') {
                pathwayResults = GraduationOptimizer.analyzePathways(scheduleData);
            }

            // Render results
            const hasIssues = conflicts.length > 0 || warnings.length > 0 || pathwayResults.conflicts.length > 0;
            const hasEnrollmentData = enrollmentInsights.length > 0 || suggestions.length > 0;
            const hasPathwayIssues = pathwayResults.conflicts.length > 0 || pathwayResults.warnings.length > 0;

            if (!hasIssues && !hasEnrollmentData && !hasPathwayIssues) {
                content.innerHTML = `
                    <div class="no-conflicts">
                        <div class="icon">✅</div>
                        <h4>No Conflicts Detected in ${currentQuarterDisplay}</h4>
                        <p>Your schedule looks good! No room or faculty conflicts found.</p>
                    </div>
                `;
            } else {
                let html = '';

                // Summary bar with current quarter and pathway health
                html += `
                    <div style="margin-bottom: 16px; padding: 12px; background: #1e293b; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #e2e8f0;">Analyzing: ${currentQuarterDisplay}</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #8b5cf6;">🎓 Pathway Health:</span>
                                <span style="background: ${pathwayResults.pathwayHealth >= 80 ? '#10b981' : pathwayResults.pathwayHealth >= 60 ? '#f59e0b' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 0.85em;">${pathwayResults.pathwayHealth}%</span>
                            </div>
                        </div>
                        <div style="color: #94a3b8;">
                            <strong style="color: #ef4444;">${conflicts.length + pathwayResults.conflicts.length}</strong> conflicts,
                            <strong style="color: #f59e0b;">${warnings.length + pathwayResults.warnings.length}</strong> warnings,
                            <strong style="color: #3b82f6;">${enrollmentInsights.length}</strong> enrollment insights
                        </div>
                    </div>
                `;

                // Conflicts section
                if (conflicts.length > 0) {
                    html += `<h4 style="color: #ef4444; margin: 16px 0 8px;">Critical Conflicts</h4>`;
                    html += conflicts.map(c => {
                        // Student scheduling conflicts have special rendering
                        if (c.type === 'student-conflict') {
                            return `
                                <div class="conflict-item" style="padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                        <h4 style="margin: 0;">🔴 ${c.title}</h4>
                                        <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600;">CRITICAL</span>
                                    </div>
                                    <p style="margin-bottom: 8px;">${c.description}</p>
                                    <p style="margin-bottom: 12px;"><strong>Students Affected:</strong> ${c.studentsAffected}</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                                        ${c.courses.map(course => `
                                            <span style="background: #fecaca; color: #991b1b; padding: 4px 12px; border-radius: 4px; font-size: 0.85em;">
                                                ${course.code} - ${course.title}
                                            </span>
                                        `).join('')}
                                    </div>
                                    ${c.resolutions && c.resolutions.length > 0 ? `
                                        <div style="background: #0f172a; padding: 12px; border-radius: 8px; margin-top: 12px;">
                                            <h5 style="color: #10b981; margin: 0 0 12px 0;">Resolution Options</h5>
                                            <p style="color: #94a3b8; font-size: 0.85em; margin-bottom: 12px;">Move one course to reduce the conflict:</p>
                                            ${c.resolutions.map((r, i) => {
                                                const timeDisplay = r.time ? r.time.replace('10:00-12:20', '10:00 AM - 12:20 PM').replace('13:00-15:20', '1:00 - 3:20 PM').replace('16:00-18:20', '4:00 - 6:20 PM') : (r.target_slot || 'alternate time');
                                                const dayDisplay = r.dayName || (r.target_slot ? (r.target_slot.startsWith('MW') ? 'Monday/Wednesday' : 'Tuesday/Thursday') : '');
                                                return `
                                                <div style="background: #1e293b; padding: 10px 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${i < 2 ? '#10b981' : '#3b82f6'};">
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                        ${i < 2 ? '<span style="color: #10b981;">✅</span>' : '<span style="color: #3b82f6;">📋</span>'}
                                                        <strong style="color: #e2e8f0;">${i < 2 ? 'BEST OPTION: ' : ''}Move to ${dayDisplay} ${timeDisplay}</strong>
                                                    </div>
                                                    <div style="color: #94a3b8; font-size: 0.85em; margin-left: 24px;">
                                                        ${r.currentCourses ? `<div><strong>Currently scheduled:</strong> ${r.currentCourses}</div>` : ''}
                                                        ${r.availableRooms ? `<div><strong>Rooms available:</strong> ${r.availableRooms} of 6</div>` : ''}
                                                        <div style="color: #10b981;">✓ ${r.reason || r.impact || 'Available slot'}</div>
                                                    </div>
                                                </div>
                                            `}).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                        // Regular conflicts
                        return `
                            <div class="conflict-item">
                                <h4>🔴 ${c.title}</h4>
                                <p>${c.description}</p>
                                <div class="conflict-suggestion">💡 ${c.suggestion}</div>
                            </div>
                        `;
                    }).join('');
                }

                // Warnings section
                if (warnings.length > 0) {
                    html += `<h4 style="color: #f59e0b; margin: 16px 0 8px;">Warnings</h4>`;
                    html += warnings.map(w => `
                        <div class="conflict-item warning">
                            <h4>🟡 ${w.title}</h4>
                            <p>${w.description}</p>
                            <div class="conflict-suggestion">💡 ${w.suggestion}</div>
                        </div>
                    `).join('');
                }

                // Enrollment insights section (Winter data to inform Spring planning)
                if (enrollmentInsights.length > 0) {
                    html += `<h4 style="color: #3b82f6; margin: 16px 0 8px;">Predictions Based on Winter 2026 Enrollment</h4>
                             <p style="color: #94a3b8; font-size: 0.85em; margin-bottom: 12px;">Using Winter enrollment data to inform ${currentQuarterDisplay} planning</p>`;
                    html += enrollmentInsights.map(e => `
                        <div class="conflict-item" style="border-left-color: ${e.type === 'high-demand' ? '#10b981' : e.type === 'low-enrollment' ? '#f59e0b' : '#3b82f6'};">
                            <h4>${e.type === 'high-demand' ? '📈' : e.type === 'low-enrollment' ? '📉' : 'ℹ️'} ${e.title}</h4>
                            <p>${e.description}</p>
                            <div class="conflict-suggestion">💡 ${e.suggestion}</div>
                        </div>
                    `).join('');
                }

                // Suggestions section
                if (suggestions.length > 0) {
                    html += `<h4 style="color: #10b981; margin: 16px 0 8px;">Capacity Suggestions</h4>`;
                    html += suggestions.map(s => `
                        <div class="conflict-item" style="border-left-color: #10b981;">
                            <h4>✅ ${s.title}</h4>
                            <p>${s.description}</p>
                            <div class="conflict-suggestion">💡 ${s.suggestion}</div>
                        </div>
                    `).join('');
                }

                // Graduation Pathway Analysis (using already-computed results)
                if (hasPathwayIssues) {
                        html += `
                            <div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #334155;">
                                <h4 style="color: #8b5cf6; margin: 0 0 8px; display: flex; align-items: center; gap: 8px;">
                                    🎓 Graduation Pathway Analysis
                                    <span style="background: ${pathwayResults.pathwayHealth >= 80 ? '#10b981' : pathwayResults.pathwayHealth >= 60 ? '#f59e0b' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">${pathwayResults.pathwayHealth}% Health</span>
                                </h4>
                                <p style="color: #94a3b8; font-size: 0.85em; margin-bottom: 12px;">Analyzing course offerings against BDES degree requirements</p>
                        `;

                        // Critical pathway issues
                        if (pathwayResults.conflicts.length > 0) {
                            html += `<h5 style="color: #ef4444; margin: 12px 0 8px;">🚨 Critical Pathway Issues</h5>`;
                            html += pathwayResults.conflicts.map(c => `
                                <div class="conflict-item" style="border-left-color: #ef4444;">
                                    <h4>🔴 ${c.title}</h4>
                                    <p>${c.description}</p>
                                    ${c.courses ? `<div style="margin: 8px 0;"><strong>Courses:</strong> ${c.courses.join(', ')}</div>` : ''}
                                    <div class="conflict-suggestion">💡 ${c.recommendation}</div>
                                </div>
                            `).join('');
                        }

                        // Pathway warnings
                        if (pathwayResults.warnings.length > 0) {
                            html += `<h5 style="color: #f59e0b; margin: 12px 0 8px;">⚠️ Pathway Warnings</h5>`;
                            html += pathwayResults.warnings.slice(0, 5).map(w => `
                                <div class="conflict-item warning" style="border-left-color: ${w.type === 'pathway_conflict' ? '#f59e0b' : '#8b5cf6'};">
                                    <h4>${w.type === 'pathway_conflict' ? '🟡' : '📚'} ${w.title}</h4>
                                    <p>${w.description}</p>
                                    ${w.courses ? `<div style="margin: 8px 0;"><strong>Courses:</strong> ${Array.isArray(w.courses) ? w.courses.join(', ') : w.courses}</div>` : ''}
                                    <div class="conflict-suggestion">💡 ${w.recommendation}</div>
                                </div>
                            `).join('');

                            if (pathwayResults.warnings.length > 5) {
                                html += `<p style="color: #6b7280; font-size: 0.85em; margin-top: 8px;">+ ${pathwayResults.warnings.length - 5} more warnings</p>`;
                            }
                        }

                    html += `</div>`;
                }

                content.innerHTML = html;
            }
        }

        function closeConflictResultsPanel() {
            const panel = document.getElementById('conflictResultsPanel');
            panel.classList.remove('active');
            setTimeout(() => panel.style.display = 'none', 300);
        }

        /**
         * Clear the old static conflict sections at the bottom of the page
         */
        function clearOldConflictSections() {
            const conflictsList = document.getElementById('conflictsList');
            const conflictSolverList = document.getElementById('conflictSolverList');
            const recommendationsList = document.getElementById('recommendationsList');

            if (conflictsList) conflictsList.innerHTML = '<p style="color: #6b7280; padding: 10px;">See Detect Conflicts panel for current analysis</p>';
            if (conflictSolverList) conflictSolverList.innerHTML = '';
            if (recommendationsList) recommendationsList.innerHTML = '';
        }

        // ============================================
        // SCHEDULING RULES/CONSTRAINTS
        // ============================================

        async function openConstraintsModal() {
            const modal = document.getElementById('constraintsModal');
            const list = document.getElementById('constraintsList');

            modal.classList.add('active');
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">Loading constraints...</div>';

            // Load constraints from database
            let constraints;
            try {
                constraints = await ConstraintsService.loadConstraints();
            } catch (err) {
                constraints = ConstraintsService.getFallbackConstraints();
            }

            // Render constraints list
            if (constraints.length === 0) {
                list.innerHTML = '<p style="color: #6b7280;">No scheduling rules configured yet.</p>';
                return;
            }

            list.innerHTML = constraints.map(c => {
                const severity = c.rule_details?.severity || 'info';
                const severityColor = severity === 'critical' ? '#ef4444' : severity === 'warning' ? '#f59e0b' : '#3b82f6';
                const severityIcon = severity === 'critical' ? '🔴' : severity === 'warning' ? '🟡' : 'ℹ️';

                return `
                    <div class="constraint-item" style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${severityColor};">
                        <label class="toggle-switch" style="margin-top: 2px;">
                            <input type="checkbox" ${c.enabled ? 'checked' : ''} onchange="toggleConstraint('${c.id}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937;">
                                ${severityIcon} ${c.description}
                            </div>
                            <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">
                                Type: ${c.constraint_type} | Severity: ${severity}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function closeConstraintsModal() {
            document.getElementById('constraintsModal').classList.remove('active');
        }

        async function toggleConstraint(id, enabled) {
            const success = await ConstraintsService.toggleConstraint(id, enabled);
            if (success) {
                showToast(`Rule ${enabled ? 'enabled' : 'disabled'}`);
            } else {
                showToast('Failed to update rule', 'error');
            }
        }

        // ============================================
        // OPENAI / CHATGPT INTEGRATION
        // ============================================

        const PLANNING_TARGETS = [
            { faculty: 'Travis', credits: 31, inload: 5, desn499PerQuarter: 2 },
            { faculty: 'Ginelle', credits: 31, inload: 5, desn499PerQuarter: 2 },
            { faculty: 'Mindy', credits: 18 },
            { faculty: 'Colin', credits: 36 },
            { faculty: 'Sonja', credits: 45 },
            { faculty: 'Sam', credits: 45 },
            { faculty: 'Meg', credits: 45 },
            { faculty: 'Optional Lecturer', credits: 45, optionalScenario: true }
        ];
        const AI_MODELS = {
            openai: [
                { value: 'gpt-4o-mini', label: 'gpt-4o-mini (fast + low cost)' },
                { value: 'gpt-4o', label: 'gpt-4o (strong reasoning)' },
                { value: 'gpt-4.1-mini', label: 'gpt-4.1-mini (balanced)' },
                { value: 'gpt-4.1', label: 'gpt-4.1 (highest quality)' }
            ],
            anthropic: [
                { value: 'claude-opus-4-6', label: 'claude-opus-4-6 (highest quality)' },
                { value: 'claude-sonnet-4-5', label: 'claude-sonnet-4-5 (recommended)' },
                { value: 'claude-haiku-4-5', label: 'claude-haiku-4-5 (fast + low cost)' },
                { value: 'claude-3-7-sonnet-latest', label: 'claude-3.7-sonnet-latest (legacy)' }
            ]
        };

        function getAiService() {
            if (typeof OpenAIService !== 'undefined') {
                return OpenAIService;
            }
            if (typeof ClaudeService !== 'undefined') {
                return ClaudeService;
            }
            return null;
        }

        function tryHydrateAiKeyFromInput(aiService) {
            if (!aiService) {
                return false;
            }
            const input = document.getElementById('apiKeyInput');
            const typedKey = input?.value?.trim();

            if (typedKey && typedKey.startsWith('sk-')) {
                try {
                    aiService.setApiKey(typedKey);
                    return true;
                } catch (_error) {
                    return false;
                }
            }

            return aiService.hasApiKey();
        }

        function getSelectedProviderPreference() {
            const openaiChecked = document.getElementById('providerOpenAI')?.checked;
            const claudeChecked = document.getElementById('providerClaude')?.checked;
            if (openaiChecked) return 'openai';
            if (claudeChecked) return 'anthropic';
            return null;
        }

        function inferProviderForModal(aiService) {
            const explicit = getSelectedProviderPreference();
            if (explicit) {
                return explicit;
            }

            const typedKey = document.getElementById('apiKeyInput')?.value?.trim() || '';
            if (typedKey.startsWith('sk-ant-')) {
                return 'anthropic';
            }
            if (typedKey.startsWith('sk-')) {
                return 'openai';
            }

            return aiService?.getCurrentProvider?.() || 'openai';
        }

        function populateModelDropdown(aiService, provider) {
            const select = document.getElementById('apiModelSelect');
            if (!select) {
                return;
            }

            const models = AI_MODELS[provider] || AI_MODELS.openai;
            const preferred = aiService?.getModelPreference?.(provider);
            const fallback = aiService?.getCurrentDefaultModel?.();

            select.innerHTML = models
                .map((model) => `<option value="${model.value}">${model.label}</option>`)
                .join('');

            const preferredValue = preferred || fallback || models[0]?.value;
            const match = models.find((model) => model.value === preferredValue);
            select.value = match ? preferredValue : models[0]?.value || '';
        }

        function toggleApiProviderType(provider) {
            const openaiCheckbox = document.getElementById('providerOpenAI');
            const claudeCheckbox = document.getElementById('providerClaude');
            const aiService = getAiService();

            if (!openaiCheckbox || !claudeCheckbox) {
                return;
            }

            if (provider === 'openai' && openaiCheckbox.checked) {
                claudeCheckbox.checked = false;
            } else if (provider === 'anthropic' && claudeCheckbox.checked) {
                openaiCheckbox.checked = false;
            }

            const preference = getSelectedProviderPreference();
            aiService?.setProviderPreference?.(preference);
            const effectiveProvider = preference || inferProviderForModal(aiService);
            populateModelDropdown(aiService, effectiveProvider);
            updateApiStatus(
                preference
                    ? `Provider preference set: ${preference === 'anthropic' ? 'Claude (Anthropic)' : 'OpenAI'}`
                    : 'Provider preference cleared. Auto-detect will be used.',
                'warn'
            );
        }

        function updateApiStatus(message, tone = 'warn', title = 'Status') {
            const box = document.getElementById('apiKeyStatus');
            const messageEl = document.getElementById('apiKeyStatusMessage');
            if (!box || !messageEl) {
                return;
            }

            box.classList.remove('ok', 'warn', 'error');
            if (tone === 'ok') {
                box.classList.add('ok');
            } else if (tone === 'error') {
                box.classList.add('error');
            } else {
                box.classList.add('warn');
            }

            const titleEl = box.querySelector('.api-status-title');
            if (titleEl) {
                titleEl.textContent = title;
            }
            messageEl.textContent = message;
        }

        function openApiSettingsModal() {
            const modal = document.getElementById('apiSettingsModal');
            const input = document.getElementById('apiKeyInput');
            const aiService = getAiService();
            const typedKey = input?.value?.trim();
            const providerPref = aiService?.getProviderPreference?.() || null;
            const openaiCheckbox = document.getElementById('providerOpenAI');
            const claudeCheckbox = document.getElementById('providerClaude');
            const inferredProvider = providerPref
                || (typedKey?.startsWith('sk-ant-') ? 'anthropic' : null)
                || (typedKey?.startsWith('sk-') ? 'openai' : null)
                || aiService?.getCurrentProvider?.()
                || 'openai';

            if (aiService && aiService.hasApiKey()) {
                input.value = '';
                input.placeholder = aiService.maskApiKey(aiService.getApiKey());
                updateApiStatus('API key configured.', 'ok');
            } else if (typedKey && typedKey.startsWith('sk-')) {
                updateApiStatus('Unsaved key detected. Click Save or Test Connection.', 'warn');
            } else {
                input.value = '';
                input.placeholder = 'sk-... or sk-ant-...';
                updateApiStatus('No API key configured.', 'warn');
            }

            if (openaiCheckbox && claudeCheckbox) {
                openaiCheckbox.checked = inferredProvider === 'openai';
                claudeCheckbox.checked = inferredProvider === 'anthropic';
            }
            populateModelDropdown(aiService, inferredProvider);

            modal.classList.add('active');
        }

        function closeApiSettingsModal(event) {
            if (event && event.target && event.target.id !== 'apiSettingsModal') {
                return;
            }
            document.getElementById('apiSettingsModal').classList.remove('active');
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            const aiService = getAiService();

            if (!aiService) {
                showToast('AI service unavailable', 'error');
                return;
            }

            if (!key && aiService.hasApiKey()) {
                showToast('API key unchanged');
                updateApiStatus('API key unchanged.', 'ok');
                closeApiSettingsModal();
                return;
            }

            if (!key) {
                showToast('Please enter an API key');
                updateApiStatus('Please enter an API key before saving.', 'error', 'Validation');
                return;
            }

            if (!key.startsWith('sk-')) {
                showToast('Invalid API key format');
                updateApiStatus('Invalid key format. Key must start with "sk-".', 'error', 'Validation');
                return;
            }

            try {
                aiService.setApiKey(key);
                aiService.setProviderPreference(getSelectedProviderPreference());
                const provider = inferProviderForModal(aiService);
                const selectedModel = document.getElementById('apiModelSelect')?.value;
                aiService.setModelPreference(selectedModel, provider);
                showToast('API key saved');
                updateApiStatus('API key saved successfully.', 'ok');
                closeApiSettingsModal();
            } catch (error) {
                showToast('Error saving API key');
                updateApiStatus(error.message || 'Error saving API key.', 'error');
            }
        }

        function clearApiKey() {
            const aiService = getAiService();
            if (!aiService) {
                showToast('AI service unavailable', 'error');
                return;
            }

            if (confirm('Clear API key?')) {
                aiService.clearApiKey();
                document.getElementById('apiKeyInput').value = '';
                document.getElementById('apiKeyInput').placeholder = 'sk-... or sk-ant-...';
                const openaiCheckbox = document.getElementById('providerOpenAI');
                const claudeCheckbox = document.getElementById('providerClaude');
                if (openaiCheckbox) openaiCheckbox.checked = false;
                if (claudeCheckbox) claudeCheckbox.checked = false;
                updateApiStatus('API key cleared.', 'warn');
                showToast('API key cleared');
            }
        }

        async function testApiConnection() {
            const input = document.getElementById('apiKeyInput');
            const newKey = input.value.trim();
            const aiService = getAiService();
            const providerPref = getSelectedProviderPreference();
            const effectiveProvider = providerPref || inferProviderForModal(aiService);
            const selectedModel = document.getElementById('apiModelSelect')?.value;

            if (!aiService) {
                updateApiStatus('AI service unavailable.', 'error');
                return;
            }

            if (newKey && newKey.startsWith('sk-')) {
                aiService.setApiKey(newKey);
            }

            aiService.setProviderPreference(providerPref);
            aiService.setModelPreference(selectedModel, effectiveProvider);
            updateApiStatus('Testing connection... please wait.', 'warn');

            try {
                const result = await aiService.testConnection(selectedModel || undefined, providerPref || undefined);
                if (result.success) {
                    const providerLabel = result.provider === 'anthropic' ? 'Claude (Anthropic)' : 'OpenAI';
                    updateApiStatus(
                        `Connection successful.\nProvider: ${providerLabel}\nModel: ${result.model}\nResponse: ${result.message}`,
                        'ok'
                    );
                } else {
                    updateApiStatus(`Connection failed.\n${result.error}`, 'error');
                }
            } catch (error) {
                updateApiStatus(`Connection error.\n${error.message}`, 'error');
            }
        }

        function buildScheduleSnapshotForAI(quarter) {
            const normalizePromptInstructorName = (instructorName) => {
                const value = String(instructorName || '').trim().toLowerCase();
                if (!value) {
                    return 'TBD';
                }
                if (value === 'a.sopu' || value === 'ariel' || value === 'ariel sopu') {
                    return 'Optional Lecturer';
                }
                return instructorName;
            };

            const snapshot = {
                [quarter]: {
                    assignedCourses: {}
                }
            };

            const quarterData = scheduleData[quarter] || {};
            Object.entries(quarterData).forEach(([day, dayData]) => {
                if (!dayData || typeof dayData !== 'object') {
                    return;
                }
                Object.entries(dayData).forEach(([time, courses]) => {
                    if (!Array.isArray(courses)) {
                        return;
                    }
                    courses.forEach((course, index) => {
                        const room = course.room || day;
                        const key = `${day}-${time}-${room}`;
                        if (!snapshot[quarter].assignedCourses[key]) {
                            snapshot[quarter].assignedCourses[key] = [];
                        }
                        snapshot[quarter].assignedCourses[key].push({
                            courseCode: course.code,
                            section: course.section || String(index + 1).padStart(3, '0'),
                            courseTitle: course.name || course.title || '',
                            facultyName: normalizePromptInstructorName(course.instructor),
                            credits: Number(course.credits) || 5
                        });
                    });
                });
            });

            return snapshot;
        }

        function buildPlannerScenarioText() {
            return PLANNING_TARGETS
                .map((target) => {
                    const details = [`${target.credits} credits`];
                    if (target.inload) details.push(`${target.inload} inload`);
                    if (target.desn499PerQuarter) details.push(`DESN499 ${target.desn499PerQuarter}/quarter`);
                    if (target.optionalScenario) details.push('optional (with/without)');
                    return `- ${target.faculty}: ${details.join(', ')}`;
                })
                .join('\n');
        }

        function fillSchedulerQuestion(questionText) {
            const input = document.getElementById('schedulerQuestionInput');
            input.value = questionText;
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('schedulerQuestionInput');
            if (!input) {
                return;
            }
            input.addEventListener('keydown', (event) => {
                if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
                    event.preventDefault();
                    askSchedulerQuestion();
                }
            });
        });

        function buildSchedulerQuestionPrompt(question, quarter) {
            const normalizePromptInstructorName = (instructorName) => {
                const value = String(instructorName || '').trim().toLowerCase();
                if (!value) {
                    return 'TBD';
                }
                if (value === 'a.sopu' || value === 'ariel' || value === 'ariel sopu') {
                    return 'Optional Lecturer';
                }
                return instructorName;
            };

            const quarterCourses = flattenQuarterData(scheduleData[quarter] || {});
            const trimmedCourses = quarterCourses.map((course) => ({
                code: course.code,
                title: course.name || course.title || '',
                instructor: normalizePromptInstructorName(course.instructor),
                room: course.room || '',
                day: course.day || '',
                time: course.time || '',
                credits: Number(course.credits) || 5
            }));

            return `You are the scheduling strategist for EWU Design.

CURRENT QUARTER: ${quarter}
SCENARIO TARGETS:
${buildPlannerScenarioText()}

SCHEDULE COURSES (JSON):
${JSON.stringify(trimmedCourses, null, 2)}

QUESTION:
${question}

RESPONSE FORMAT:
1) Direct answer
2) Impact analysis (who/what changes)
3) Recommended action plan
4) Key assumptions`;
        }

        function escapeHtml(value) {
            return String(value || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function markdownToSafeHtml(markdownText) {
            const text = (markdownText || '').trim();
            if (!text) {
                return '';
            }

            if (window.marked && typeof window.marked.parse === 'function') {
                window.marked.setOptions({
                    gfm: true,
                    breaks: true,
                    headerIds: false,
                    mangle: false
                });

                const renderedHtml = window.marked.parse(text);
                if (window.DOMPurify && typeof window.DOMPurify.sanitize === 'function') {
                    return window.DOMPurify.sanitize(renderedHtml);
                }
                return escapeHtml(text).replace(/\n/g, '<br>');
            }

            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        function renderMarkdownResponse(element, markdownText, fallbackText = 'No response returned.') {
            if (!element) {
                return;
            }

            const text = (markdownText || '').trim();
            if (!text) {
                element.classList.add('empty');
                element.textContent = fallbackText;
                return;
            }

            element.classList.remove('empty');
            const html = markdownToSafeHtml(text);
            element.innerHTML = `<div class="markdown-output">${html}</div>`;
        }

        async function askSchedulerQuestion() {
            const aiService = getAiService();
            if (!aiService) {
                openApiSettingsModal();
                showToast('AI service unavailable', 'error');
                return;
            }
            tryHydrateAiKeyFromInput(aiService);

            const input = document.getElementById('schedulerQuestionInput');
            const responseEl = document.getElementById('schedulerQuestionResponse');
            const question = input.value.trim();

            if (!question) {
                showToast('Enter a question first');
                input.focus();
                return;
            }

            responseEl.classList.remove('empty');
            renderMarkdownResponse(responseEl, '_Thinking..._');

            try {
                const quarter = document.getElementById('quarterSelect').value;
                const prompt = buildSchedulerQuestionPrompt(question, quarter);
                const model = aiService.getCurrentDefaultModel?.() || 'gpt-4o-mini';
                const provider = aiService.getCurrentProvider?.();
                const result = await aiService.analyze(prompt, {
                    model,
                    provider,
                    maxTokens: 1200,
                    temperature: 0.2,
                    systemPrompt: 'You are a precise academic scheduling assistant. Be concrete, actionable, and explicit about risk tradeoffs.'
                });

                const answer = (result.text || '').trim();
                renderMarkdownResponse(responseEl, answer, 'No answer returned.');
                showToast('Program Command response ready');
            } catch (error) {
                if (error.message.includes('No AI API key found') || error.message.includes('No API key')) {
                    openApiSettingsModal();
                    showToast('Add your API key in Settings, then retry', 'error');
                }
                renderMarkdownResponse(
                    responseEl,
                    `### Request failed\n\n${escapeHtml(error.message)}`,
                    `Request failed: ${error.message}`
                );
                showToast('Program Command request failed', 'error');
            }
        }

        async function evaluateScheduleWithAI() {
            const aiService = getAiService();
            if (!aiService) {
                openApiSettingsModal();
                showToast('AI service unavailable', 'error');
                return;
            }
            tryHydrateAiKeyFromInput(aiService);

            const panel = document.getElementById('aiResultsPanel');
            const loading = document.getElementById('aiResultsLoading');
            const content = document.getElementById('aiResultsContent');

            panel.style.display = 'flex';
            setTimeout(() => panel.classList.add('active'), 10);
            loading.style.display = 'flex';
            content.style.display = 'none';

            try {
                const quarter = document.getElementById('quarterSelect').value;
                const scheduleSnapshot = buildScheduleSnapshotForAI(quarter);
                const prompt = ScheduleEvaluator.buildPrompt(scheduleSnapshot, {}, [], { quarter });
                const model = aiService.getCurrentDefaultModel?.() || 'gpt-4o-mini';
                const provider = aiService.getCurrentProvider?.();

                const response = await aiService.analyze(prompt, {
                    model,
                    provider,
                    maxTokens: 4096,
                    temperature: 0.2,
                    responseFormat: 'json_object'
                });

                const parsed = ScheduleEvaluator.parseResponse(response);
                const results = ScheduleEvaluator.formatResults(parsed);

                loading.style.display = 'none';
                content.style.display = 'block';

                if (results.error) {
                    content.innerHTML = `<div class="conflict-item"><h4>Analysis Error</h4><p>${results.message}</p></div>`;
                } else {
                    const scoreClass = results.healthScore >= 80 ? 'good' : results.healthScore >= 60 ? 'medium' : 'poor';

                    content.innerHTML = `
                        <div class="health-score">
                            <div class="health-score-circle ${scoreClass}">${results.healthScore || '--'}</div>
                            <p style="margin: 0; font-size: 14px; color: #6b7280;">Schedule Health Score</p>
                            <p style="margin: 8px 0 0; font-size: 13px;">${results.overallAssessment || ''}</p>
                        </div>
                        ${results.sections.map(section => `
                            <div style="margin-bottom: 16px;">
                                <h4 style="margin: 0 0 8px;">${section.icon} ${section.title} (${section.count})</h4>
                                ${section.items.length === 0 ? '<p style="color: #6b7280; font-size: 13px;">No issues</p>' :
                                section.items.map(item => `
                                    <div class="conflict-item ${item.severity === 'critical' ? '' : item.severity === 'high' ? '' : 'warning'}">
                                        <h4>${item.title}</h4>
                                        <p>${item.description}</p>
                                        ${item.suggestion ? `<div class="conflict-suggestion">💡 ${item.suggestion.action}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    `;
                }

                showToast('Program Command analysis complete');

            } catch (error) {
                console.error('AI evaluation error:', error);
                if (error.message.includes('No AI API key found') || error.message.includes('No API key')) {
                    openApiSettingsModal();
                }
                loading.style.display = 'none';
                content.style.display = 'block';
                content.innerHTML = `
                    <div class="conflict-item">
                        <h4>Analysis Failed</h4>
                        <p>${error.message}</p>
                        <p style="font-size: 12px; color: #6b7280;">Check your API key and try again.</p>
                    </div>
                `;
                showToast('AI analysis failed');
            }
        }

        function closeAiResultsPanel() {
            const panel = document.getElementById('aiResultsPanel');
            panel.classList.remove('active');
            setTimeout(() => panel.style.display = 'none', 300);
        }

        // ============================================
        // PRINT FUNCTIONALITY
        // ============================================

        function openPrintDialog() {
            const modal = document.getElementById('printModal');
            const currentQuarter = document.getElementById('quarterSelect').value;
            const quarterLabel = document.getElementById('quarterSelect').options[document.getElementById('quarterSelect').selectedIndex].text;
            document.getElementById('printCurrentLabel').textContent = quarterLabel;
            modal.classList.add('active');
            closeHeaderSettingsMenu();
        }

        function closePrintDialog() {
            document.getElementById('printModal').classList.remove('active');
        }

        function printSchedule(mode) {
            closePrintDialog();
            
            const quarters = mode === 'all' 
                ? ['fall', 'winter', 'spring'] 
                : [document.getElementById('quarterSelect').value];
            
            const quarterNames = {
                fall: `Fall ${currentAcademicYear.split('-')[0]}`,
                winter: `Winter ${currentAcademicYear.split('-')[1]}`,
                spring: `Spring ${currentAcademicYear.split('-')[1]}`
            };
            
            const rooms = ['206', '207', '209', '210', '212', 'CEB 102', 'CEB 104'];
            const timeSlots = ['10:00-12:20', '13:00-15:20', '16:00-18:20'];
            const timeLabels = ['10:00 AM - 12:20 PM', '1:00 PM - 3:20 PM', '4:00 PM - 6:20 PM'];
            
            let content = '';
            quarters.forEach((quarter, qIdx) => {
                const quarterData = scheduleData[quarter] || {};
                content += `
                    <div style="page-break-after: ${qIdx < quarters.length - 1 ? 'always' : 'auto'}; padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px; border-bottom: 3px solid #a10022; padding-bottom: 15px;">
                            <h1 style="font-size: 28px; color: #a10022; margin: 0;">EWU Design Department</h1>
                            <h2 style="font-size: 22px; color: #333; margin: 5px 0;">${quarterNames[quarter]}</h2>
                            <div style="font-size: 12px; color: #666;">Printed: ${new Date().toLocaleDateString()}</div>
                        </div>
                `;
                
                // MW Section
                content += buildPrintSectionHTML('Monday / Wednesday', ['MW'], quarterData, rooms, timeSlots, timeLabels);
                
                // TR Section  
                content += buildPrintSectionHTML('Tuesday / Thursday', ['TR'], quarterData, rooms, timeSlots, timeLabels);
                
                // Online Section
                const onlineCourses = getOnlineCoursesForQuarter(quarterData);
                if (onlineCourses.length > 0) {
                    content += '<div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc;"><h3 style="margin: 0 0 10px 0;">Online / Asynchronous Courses</h3>';
                    onlineCourses.forEach(course => {
                        content += `<div style="background: #f5f5f5; padding: 5px 10px; margin: 3px 0; font-size: 12px;"><strong>${course.code}</strong> - ${course.name || course.title} (${course.instructor || 'TBD'})</div>`;
                    });
                    content += '</div>';
                }
                
                content += '</div>';
            });
            
            // Open print window
            const printWindow = window.open('', '_blank', 'width=1000,height=800');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>EWU Schedule - ${mode === 'all' ? 'All Quarters' : quarterNames[quarters[0]]}</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 250);
        }
        
        function buildPrintSectionHTML(title, dayPatterns, quarterData, rooms, timeSlots, timeLabels) {
            let html = `<div style="margin-bottom: 25px;"><h3 style="font-size: 14px; background: #e8e8e8; padding: 8px; margin: 0 0 5px 0;">${title}</h3>`;
            html += '<table style="border-collapse: collapse; width: 100%; font-size: 11px;"><thead><tr><th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0; text-align: left;">Time</th>';
            rooms.forEach(room => html += `<th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0; text-align: left;">${room}</th>`);
            html += '</tr></thead><tbody>';
            
            timeSlots.forEach((slot, idx) => {
                html += `<tr><td style="border: 1px solid #ccc; padding: 6px; font-weight: bold; background: #fafafa;">${timeLabels[idx]}</td>`;
                rooms.forEach(room => {
                    const courses = findCoursesForPrint(quarterData, dayPatterns, slot, room);
                    if (courses.length > 0) {
                        html += '<td style="border: 1px solid #ccc; padding: 4px; vertical-align: top;">';
                        courses.forEach(course => {
                            html += `<div style="background: #f0f7ff; padding: 4px; margin: 2px 0; font-size: 10px;"><strong>${course.code}</strong><br>${course.name || course.title || ''}<br><em>${course.instructor || 'TBD'}</em></div>`;
                        });
                        html += '</td>';
                    } else {
                        html += '<td style="border: 1px solid #ccc; padding: 4px;"></td>';
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function findCoursesForPrint(quarterData, dayPatterns, timeSlot, room) {
            const results = [];
            dayPatterns.forEach(pattern => {
                const dayData = quarterData[pattern];
                if (!dayData) return;
                const timeCourses = dayData[timeSlot];
                if (!Array.isArray(timeCourses)) return;
                timeCourses.forEach(course => {
                    const courseRoom = (course.room || '').toString();
                    if (courseRoom === room || room.startsWith(courseRoom)) {
                        results.push(course);
                    }
                });
            });
            return results;
        }

        function getOnlineCoursesForQuarter(quarterData) {
            const onlineData = quarterData['ONLINE'] || {};
            const asyncData = onlineData['async'] || [];
            return asyncData;
        }
    </script>
</body>
</html>
